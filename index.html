<!DOCTYPE html>
<html lang="it">
<head>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pharmocounter</title>
    <style>
        :root {
            --bg-color: #f2f2f7; --card-bg: #ffffff; --text-main: #000000; --text-sec: #8e8e93;
            --accent: #007aff; --danger: #ff3b30; --warn: #ffcc00; --orange: #ff9500; --success: #34c759;
            --carb-color: #5ac8fa; --prot-color: #ff2d55; --fat-color: #ffcc00;
            --shop-bg: #f4f9ff; --shop-border: #dbeafe; --shop-text: #003a80;
        }

        /* RESET & BASE */
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); display: flex; justify-content: center; min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box; color: var(--text-main); -webkit-font-smoothing: antialiased; }
        .app-container { background: var(--card-bg); width: 100%; max-width: 420px; border-radius: 24px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.06); display: flex; flex-direction: column; gap: 20px; position: relative; }

        /* HEADER */
        .header-area { text-align: center; padding-bottom: 10px; margin-bottom: 5px; }
        .date-badge { font-size: 0.8rem; color: var(--text-sec); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 5px; }
        h1 { margin: 0; font-size: 2rem; font-weight: 800; letter-spacing: -0.5px; line-height: 1; background: linear-gradient(135deg, #007aff 0%, #004494 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block; }
        .subtitle-brand { display: block; font-size: 0.95rem; color: var(--text-sec); font-weight: 500; margin-top: 5px; }
        .streak-badge { position: absolute; top: 0; right: 0; background: #fff5e6; color: #ff9500; font-size: 0.75rem; font-weight: 700; padding: 6px 12px; border-radius: 20px; border: 1px solid #ffeebb; cursor: pointer; transition: transform 0.1s; }
        .streak-badge:active { transform: scale(0.95); }

        /* CARDS & INPUTS */
        .card { background: #f9f9fb; border-radius: 18px; padding: 18px; border: 1px solid rgba(0,0,0,0.03); }
        summary { cursor: pointer; font-weight: 600; font-size: 0.95rem; outline: none; display: flex; justify-content: space-between; align-items: center; color: var(--accent); list-style: none; }
        summary::-webkit-details-marker { display: none; }
        summary::after { content: '‚öôÔ∏è'; font-size: 1rem; opacity: 0.7; transition: transform 0.2s; }
        details[open] summary::after { transform: rotate(180deg); }
        
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; align-items: end; }
        label { font-size: 0.75rem; font-weight: 600; color: var(--text-sec); display: block; margin-bottom: 6px; }
        
        select, input { 
            width: 100%; padding: 0 12px; border-radius: 12px; 
            border: 1px solid #e5e5ea; background: #fff; 
            font-size: 0.95rem; box-sizing: border-box; 
            color: var(--text-main); height: 48px; 
            line-height: normal; -webkit-appearance: none; appearance: none;
            margin: 0;
        } 
        select:focus, input:focus { border-color: var(--accent); outline: none; }
        
        .info-box { grid-column: 1 / -1; font-size: 0.75rem; color: #666; background: #fff; padding: 12px; border-radius: 10px; border: 1px solid #eee; line-height: 1.5; margin-top: 5px; }

        /* DASHBOARD & BARS */
        .dash-header { text-align: center; margin: 10px 0; }
        .big-val { font-size: 3.2rem; font-weight: 800; line-height: 1; letter-spacing: -2px; color: var(--text-main); }
        .sub-val { font-size: 0.9rem; color: var(--text-sec); margin-top: 6px; font-weight: 500; }
        
        .track { background: #eef0f2; height: 14px; width: 100%; border-radius: 7px; overflow: hidden; position: relative; }
        .fill { height: 100%; width: 0%; border-radius: 7px; transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.4s; }
        .bmr-line { position: absolute; top: 0; bottom: 0; width: 2px; background: rgba(0,0,0,0.3); z-index: 5; border-right: 1px dashed rgba(255,255,255,0.7); }
        .bmr-tag { position: absolute; top: -18px; font-size: 0.65rem; color: var(--text-sec); transform: translateX(-50%); font-weight: 700; text-transform: uppercase; }
        .status-text { text-align: center; font-size: 0.85rem; font-weight: 600; margin-top: 10px; min-height: 1.2em; }

        /* MACROS BOX */
        .macro-grid { display: grid; gap: 18px; margin-top: 25px; }
        .macro-item { display: flex; flex-direction: column; }
        .bar-label { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: #555; }

        /* CUMULATIVE & CARDS */
        .cumulative-box { background: #e6f7ff; border: 1px solid #cceeff; border-radius: 18px; padding: 20px; text-align: center; margin-bottom: 5px; }
        .cumul-label { font-size: 0.8rem; font-weight: 600; color: #0056b3; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .cumul-value { font-size: 2rem; font-weight: 800; color: #007aff; line-height: 1; }
        .pred-status { font-size: 0.85rem; font-weight: 600; margin-top: 15px; padding: 10px; border-radius: 10px; line-height: 1.4; border: 1px solid; transition: all 0.3s ease; }
        
        .precision-card { display: inline-block; padding: 8px 15px; border-radius: 12px; font-size: 1rem; font-weight: 800; letter-spacing: 0.5px; margin-top: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); min-width: 150px; text-align: center; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); cursor: pointer; }
        .card-gold { background: linear-gradient(135deg, #FFD700, #DAA520); color: #805a00; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); }
        .card-silver { background: linear-gradient(135deg, #C0C0C0, #808080); color: #444; }
        .card-bronze { background: linear-gradient(135deg, #CD7F32, #A0522D); color: #ffffff; }
        .card-default { background: #f0f0f5; color: var(--text-sec); }

        /* WATER */
        .water-box { margin-top: 20px; padding: 15px; background: #eef7ff; border-radius: 16px; border: 1px solid #dbeafe; margin-bottom: 20px; }
        .water-title { font-size: 0.85rem; font-weight: 700; color: #004494; margin-bottom: 12px; display: flex; justify-content: space-between; }
        .water-grid { display: flex; justify-content: space-between; gap: 4px; }
        .water-glass { flex: 1; height: 40px; background: #d1e3fa; border-radius: 4px 4px 8px 8px; cursor: pointer; transition: all 0.2s; position: relative; border: 2px solid #a6c8ff; border-top: none; opacity: 0.6; }
        .water-glass.filled { background: #007aff; border-color: #005bb5; opacity: 1; }
        .water-glass.next-up { opacity: 1; border-color: #007aff; box-shadow: 0 0 0 2px rgba(0,122,255,0.3); }

        /* SHOP & LISTS */
        .shop-card { background-color: var(--shop-bg); border: 1px solid var(--shop-border); border-radius: 18px; padding: 20px; text-align: left; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 122, 255, 0.06); }
        .shop-tag { background: #007aff; color: white; font-size: 0.65rem; font-weight: 700; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; display: inline-block; margin-bottom: 10px; }
        .shop-title { font-size: 1.15rem; font-weight: 800; color: var(--shop-text); margin: 0 0 10px 0; line-height: 1.3; }
        .shop-content { font-size: 0.85rem; color: #335d88; margin-bottom: 15px; line-height: 1.5; }
        .shop-highlight { background: #ffffff; padding: 12px; border-radius: 10px; margin-top: 10px; display: block; border-left: 4px solid #007aff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-size: 0.85rem; line-height: 1.5; }
        .btn-shop { background: linear-gradient(135deg, #007aff 0%, #0056b3 100%); color: white; text-decoration: none; display: block; text-align: center; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 0.95rem; margin-top: 15px; box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2); }
        
        details.shop-details summary { color: #007aff; font-size: 0.85rem; font-weight: 600; padding: 8px 0; cursor: pointer; list-style: none; text-align: left; margin-top: 5px; display: flex; align-items: center; }
        details.macros-box summary::after { content: 'üìä'; }

        /* CIBO ALLINEAMENTO */
        .food-list { list-style: none; padding: 0; margin: 0; min-height: 20px; }
        .food-item { display: grid; grid-template-columns: 1fr auto; gap: 10px; padding: 14px 0; border-bottom: 1px solid #f0f0f5; align-items: center; }
        .food-info { min-width: 0; text-align: left; display: flex; flex-direction: column; } 
        .food-name { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #333; }
        .food-details { font-size: 0.75rem; color: var(--text-sec); margin-top: 3px; }
        .food-actions { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .food-cal { font-weight: 700; font-size: 0.95rem; }
        .btn-del { color: #ff3b30; font-size: 0.75rem; margin-top: 4px; cursor: pointer; background: none; border: none; padding: 0; font-weight: 500; }
        
        .add-box { border-top: 1px solid #eee; padding-top: 24px; display: flex; flex-direction: column; gap: 10px; }
        .row { display: flex; gap: 8px; }
        .btn-main { background: #1c1c1e; color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 600; font-size: 1rem; cursor: pointer; margin-top: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-main:active { transform: scale(0.98); }

        .did-you-know { background: #fff; padding: 20px; border-radius: 16px; border: 1px solid #eee; text-align: center; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .dyk-icon { font-size: 1.5rem; display: block; margin-bottom: 10px; }
        .dyk-title { font-weight: 800; color: #007aff; font-size: 0.9rem; margin-bottom: 5px; text-transform: uppercase; }
        .dyk-text { font-size: 0.85rem; color: #555; line-height: 1.5; }

        /* MODALS & TOAST */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: none; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 100%; max-width: 350px; border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .modal-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 15px; color: #1c1c1e; }
        .modal-text { font-size: 0.9rem; color: #444; line-height: 1.5; text-align: left; margin-bottom: 20px; }
        .modal-btn { background: #007aff; color: white; border: none; width: 100%; padding: 14px; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; }
        .reward-code { background: #f0f0f5; border: 2px dashed #007aff; color: #007aff; font-size: 1.4rem; font-weight: 800; padding: 15px; border-radius: 10px; margin: 15px 0; display: block; text-align: center; }
        
        .smart-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1c1c1e; color: white; padding: 12px 20px; border-radius: 50px; font-size: 0.85rem; box-shadow: 0 10px 20px rgba(0,0,0,0.25); z-index: 10000; display: flex; align-items: center; gap: 10px; opacity: 0; transition: opacity 0.5s; pointer-events: none; width: 90%; max-width: 350px; }
        .toast-visible { opacity: 1; pointer-events: auto; }
        .toast-btn { background: white; color: #1c1c1e; border:none; padding: 6px 12px; border-radius: 20px; font-weight: 700; font-size: 0.75rem; margin-left: auto; text-decoration: none; }
    </style>
</head>
<body>

<div id="smartToast" class="smart-toast"><span class="toast-icon">üí°</span><span id="toastMsg">...</span><a href="https://www.pharmo.it" target="_blank" class="toast-btn">Vedi</a></div>

<div id="disclaimerModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title" style="color:#d32f2f;">‚ö†Ô∏è Disclaimer Legale & Privacy</div>
        <div class="modal-text" style="font-size: 0.8rem; line-height: 1.4; text-align: justify;">
            Benvenuto su <b>Pharmocounter</b>.<br><br>
            
            <b>1. ESCLUSIONE DI RESPONSABILIT√Ä MEDICA</b><br>
            Questa applicazione fornisce stime basate su formule matematiche standard a puro scopo informativo e ludico. <b>NON sostituisce in alcun modo il parere di un medico, biologo nutrizionista o dietista.</b><br>
            Prima di intraprendere qualsiasi regime alimentare o attivit√† fisica, consultare obbligatoriamente uno specialista.
            <br><br>
            <b>2. LIMITAZIONE DI RESPONSABILIT√Ä & DATI</b><br>
            <b>Pharmo.it</b> e l'azienda gestore declinano ogni responsabilit√† per danni derivanti dall'uso improprio dei dati.<br>
            Inoltre, <b>l'azienda non si assume alcuna responsabilit√† per l'eventuale perdita di dati</b> causata da bug del sistema, aggiornamenti software, malfunzionamenti tecnici, cancellazione della cache o cambio del dispositivo. L'utente riconosce che i dati non sono salvati in cloud ma risiedono esclusivamente nel proprio terminale.
            <br><br>
            <b>3. PRIVACY (GDPR)</b><br>
            A tutela della tua privacy, questa applicazione funziona <b>esclusivamente in locale</b>. I dati inseriti restano nella memoria del tuo dispositivo e <b>NON vengono mai trasmessi, raccolti o visualizzati da server esterni</b>.
            <br><br>
            <i>Cliccando su "Accetto", dichiari di aver letto, compreso e approvato integralmente queste condizioni.</i>
        </div>
        <button class="modal-btn" onclick="acceptTerms()">Ho Letto, Compreso e Accetto</button>
    </div>
</div>


<div id="rewardModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title" id="rewardTitle">üéâ Complimenti!</div>
        <div class="modal-text" style="text-align:center;">
            <span id="rewardMsg">Nuovo livello!</span><br><br>Premio per <b>Pharmo.it</b>:
            <span class="reward-code" onclick="copyCode(this)" id="rewardCodeDisplay">...</span>
            <small style="color:#888;">Clicca per copiare</small>
        </div>
        <button class="modal-btn" onclick="closeReward('rewardModal')">Riscatta Ora</button>
    </div>
</div>

<div id="waterRewardModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title">üíß Campione di Idratazione!</div>
        <div class="modal-text" style="text-align:center;">
            Hai bevuto correttamente per <b>3 giorni</b>!<br><br>Ecco un premio per i drenanti:
            <span class="reward-code" onclick="copyCode(this)">PHARMOSPED</span>
            <small style="color:#888;">Clicca per copiare</small><br>
            <b style="color:var(--accent); margin-top:10px; display:block;">Usalo subito su pharmo.it per i tuoi prodotti preferiti!</b>
        </div>
        <button class="modal-btn" onclick="closeReward('waterRewardModal')">Riscatta Ora</button>
    </div>
</div>

<div class="app-container">
    <div class="header-area">
        <span class="date-badge" id="dateText">...</span>
        <h1>Pharmocounter</h1>
        <span class="subtitle-brand">by pharmo.it</span>
        <div class="streak-badge" id="streakDisplay" onclick="showStreakInfo()">üî• 1/7</div>
    </div>

    <details class="card" id="profileDetails">
        <summary>Il tuo Profilo</summary>
        <div class="settings-grid">
            <div><label>Sesso</label><select id="gender" onchange="calc()"><option value="m">Uomo</option><option value="f">Donna</option></select></div>
            <div><label>Et√†</label><input type="number" id="age" value="30" onchange="calc()"></div>
            <div><label>Peso Attuale (kg)</label><input type="number" id="weight" value="75" onchange="calc()"></div>
            <div><label>Altezza (cm)</label><input type="number" id="height" value="175" onchange="calc()"></div>
            
            <div style="grid-column: 1 / -1;"><label>Livello Attivit√† Fisica</label>
                <select id="act" onchange="calc()">
                    <option value="1.2">Sedentario (Ufficio, no sport)</option>
                    <option value="1.375">Leggero (Sport 1-3 gg/sett)</option>
                    <option value="1.55">Moderato (Sport 3-5 gg/sett)</option>
                    <option value="1.725">Attivo (Sport 6-7 gg/sett)</option>
                </select>
            </div>
            <div style="grid-column: 1 / -1;"><label>Obiettivo Attuale</label>
                <select id="goal" onchange="calc()">
                    <option value="lose_aggr">üìâ Perdita Peso Standard (-20%)</option>
                    <option value="lose_athlete_15">‚úÇÔ∏è Atleta / Cut Aggressivo (-15%)</option>
                    <option value="lose_cons">üõ°Ô∏è Atleta / Cut Conservativo (-10%)</option>
                    <option value="detox">üíß Detox & Sgonfiamento (-5%)</option>
                    <option value="beauty">‚ú® Beauty & Anti-Age (Mantenimento)</option>
                    <option value="recomp">üí™ Ricomposizione Corporea (High Prot)</option>
                    <option value="maintain" selected>‚öñÔ∏è Mantenimento</option>
                    <option value="gain">üìà Aumento Muscolare (+10%)</option>
                </select>
            </div>

            <details class="card" style="grid-column: 1 / -1; margin-top: 10px; padding: 15px; background: #f0f4f8; border: 1px solid #dbeafe;">
                <summary style="font-size: 0.9rem; color: #004494; font-weight: 700;">üéØ Obiettivi & Misure <span style="font-weight:400; opacity:0.7;">(Opzionali)</span></summary>
                <div class="settings-grid" style="margin-top: 15px;">
                    <div style="grid-column: 1 / -1; border-bottom: 1px solid #cceeff; padding-bottom: 5px; margin-bottom: 5px;">
                        <span style="font-size:0.75rem; font-weight:700; color:#004494; text-transform:uppercase;">Il tuo Traguardo</span>
                    </div>
                    <div><label>Peso Obiettivo (kg)</label><input type="number" id="targetWeightInput" placeholder="es. 65" onchange="calc()"></div>
                    <div><label>Data Obiettivo</label><input type="date" id="targetDateInput" onchange="calc()"></div>

                    <div style="grid-column: 1 / -1; border-bottom: 1px solid #cceeff; padding-bottom: 5px; margin-bottom: 5px; margin-top: 15px;">
                        <span style="font-size:0.75rem; font-weight:700; color:#004494; text-transform:uppercase;">Analisi Corporea (cm)</span>
                    </div>
                    <div><label>Addome (Ombelico)</label><input type="number" id="circ_abd" placeholder="cm" onchange="calc()"></div>
                    <div><label>Coscia (Alta)</label><input type="number" id="circ_coscia" placeholder="cm" onchange="calc()"></div>
                    <div id="braccio_input_wrapper" style="grid-column: 1 / -1;"><label>Braccio (Bicipite)</label><input type="number" id="circ_braccio" placeholder="cm" onchange="calc()"></div>
                    <div class="info-box" id="circAnalysis" style="grid-column: 1 / -1; margin-top: 5px; background: white; border-color: #cceeff; color: #004494;">Compila per analisi settimanale.</div>
                </div>
            </details>

            <div class="info-box" id="scientificData">Calcolo in corso...</div>
        </div>
    </details>

    <div>
        <div class="dash-header">
            <div class="big-val" id="remCal">0</div>
            <div class="sub-val">Kcal Rimanenti (Target: <span id="targetDisplay">0</span>)</div>
        </div>
        <div style="position: relative; margin-top: 30px;">
            <div id="bmrMarker" class="bmr-line"></div>
            <div id="bmrTag" class="bmr-tag">Basale</div>
            <div class="track" style="height: 26px; border-radius: 13px;"><div class="fill" id="calBar" style="border-radius: 13px;"></div></div>
        </div>
        <div class="status-text" id="statusText">...</div>
    </div>
    
    <div class="cumulative-box">
        <div class="cumul-label">Deficit Totale Risparmiato (Stima)</div>
        <div class="cumul-value" id="cumulativeDisplay">0 Kg</div>
        <div class="pred-status" id="predictionStatus">Inserisci Peso/Data Obiettivo per l'Analisi üí°</div>
    </div>
        
    <div style="text-align: center; margin-top: 15px;">
        <span style="font-size: 0.9rem; color: var(--text-sec); font-weight: 600;">PRECISIONE GIORNALIERA:</span>
        <div id="bullseyeBadge" class="precision-card card-default" onclick="showPrecisionInfo()">Inizia a loggare</div>
    </div>
    
    <div style="text-align: center; margin-top: 5px; padding: 5px 0; margin-bottom: 10px;"> <span style="font-size: 0.9rem; color: #007aff; font-weight: 700;">SERIE PLATINO:</span>
        <span id="platinumStreakDisplay" style="font-size: 1.1rem; color: var(--success); font-weight: 800; margin-left: 5px;">0 giorni</span>
    </div>

    <div class="shop-card" id="shopCard">
        <span class="shop-tag">Protocollo Consigliato</span>
        <h3 class="shop-title" id="shopTitle">...</h3>
        <div class="shop-content" id="shopDesc">...</div>
        <a href="https://www.pharmo.it" target="_blank" class="btn-shop">Acquista su Pharmo.it ‚Üí</a>
    </div>

    <div class="water-box">
        <div class="water-title"><span>Idratazione & Detox</span><span id="waterCountDisplay">0/8</span></div>
        <div class="water-grid" id="waterGrid"></div>
        <div id="waterStatus" style="font-size:0.75rem; color:var(--accent); font-weight:600; margin-top:8px; text-align:center;">Sfida Drenante: Giorno 1/3</div>
    </div>

    <details class="card macros-box">
        <summary>Dettaglio Nutrienti</summary>
        <div class="macro-grid">
            <div class="macro-item"><div class="bar-label"><span>Carboidrati</span><span id="carbTxt" style="color:var(--carb-color)">0 / 0g</span></div><div class="track"><div class="fill" id="carbBar" style="background:var(--carb-color)"></div></div></div>
            <div class="macro-item"><div class="bar-label"><span>Proteine</span><span id="protTxt" style="color:var(--prot-color)">0 / 0g</span></div><div class="track"><div class="fill" id="protBar" style="background:var(--prot-color)"></div></div></div>
            <div class="macro-item"><div class="bar-label"><span>Grassi</span><span id="fatTxt" style="color:var(--fat-color)">0 / 0g</span></div><div class="track"><div class="fill" id="fatBar" style="background:var(--fat-color)"></div></div></div>
        </div>
        <div id="protAlert" style="margin-top: 15px;"></div> </details>

     <div class="add-box">
        <div style="background:#f0f4f8; padding:10px; border-radius:12px; margin-bottom:10px; border:1px solid #dbeafe;">
            <label style="margin-bottom:5px; color:#004494; font-weight:700;">üìÇ I tuoi Cibi Salvati</label>
            <div class="row">
                <select id="favSelect" onchange="loadFav()" style="flex:1; font-weight:600; color:#004494;">
                    <option value="">-- Scegli o Crea Nuovo --</option>
                </select>
                <button onclick="deleteFav()" style="background:#ff3b30; color:white; border:none; padding:0 12px; border-radius:10px; font-weight:700;">X</button>
            </div>
        </div>

        <div class="row">
            <input type="text" id="inName" placeholder="Nome Cibo (es. Pollo)" style="flex:2; font-weight:600;">
        </div>
        
        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#888; margin-top:5px; padding:0 5px;">
            <span>Kcal (su 100g)</span><span>Carb</span><span>Prot</span><span>Gras</span>
        </div>
        <div class="row small-inputs">
            <input type="number" id="inCal100" placeholder="Kcal" style="border-color:#ccc;">
            <input type="number" id="inCarb100" placeholder="C">
            <input type="number" id="inProt100" placeholder="P">
            <input type="number" id="inFat100" placeholder="G">
        </div>

        <div class="row" style="align-items: center; margin-top:10px; background:#fafafa; padding:8px; border-radius:10px; border:1px solid #eee;">
            <span style="font-size:0.85rem; font-weight:700; color:#333;">‚öñÔ∏è Quantit√† che mangi:</span>
            <input type="number" id="inGrams" placeholder="g" value="100" style="width:80px; text-align:center; font-weight:700; color:#007aff; font-size:1.1rem;">
            <span style="font-size:0.85rem; color:#666;">grammi</span>
        </div>

        <div class="row" style="margin-top:10px; gap:10px;">
            <button class="btn-main" onclick="saveFav()" style="background:#fff; border:2px solid #007aff; color:#007aff; flex:1; padding:10px; font-size:0.8rem;">üíæ Salva Cibo<br>& Grammi</button>
            <button class="btn-main" onclick="addCalculated()" style="flex:2; margin-top:0; background:linear-gradient(135deg, #1c1c1e 0%, #3a3a3c 100%);">‚ûï Aggiungi al Diario</button>
        </div>
    </div>

<ul id="list" class="food-list"></ul>

    <div style="text-align:center; margin-top:30px; margin-bottom:20px; line-height:1.6;">
        
        <span style="font-size:0.75rem; color:#aaa; cursor:pointer; text-decoration:underline;" onclick="document.getElementById('disclaimerModal').style.display='flex'">
            Disclaimer e Privacy (Accettato)
        </span>
        
        <div style="margin-top:10px;">
            <a href="mailto:shop@pharmo.it" style="font-size:0.8rem; font-weight:600; color:#007aff; text-decoration:none;">
                <span style="vertical-align:middle;">üìß shop@pharmo.it</span>
            </a>
        </div>

                      <div style="margin-top:5px;">
            <a href="https://wa.me/393501407554" target="_blank" style="font-size:0.8rem; font-weight:600; color:#25D366; text-decoration:none;">
                <i class="fab fa-whatsapp" style="margin-right:5px;"></i>
                +39 350 140 7554
            </a>
        </div>
        
    </div>

<script>
    // --- COSTANTI & INIT ---
    const d = new Date();
    document.getElementById('dateText').innerText = d.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
    const KCAL_PER_KG_FAT = 7700; 
    const SECONDS_IN_DAY = 86400;
    const MAX_SAFE_DAILY_DEFICIT = 1000; 
    const PT_MIN_MULTIPLIER = 1.8;

    // --- TESTI PROTOCOLLI DETTAGLIATI & PERSUASIVI ---
    const stackLoss = `
        Consiglio: <b>Pharmofit</b>, <b>Pharmodren</b> e <b>Pharmofiller</b>.
        <details class="shop-details">
            <summary>Svela la strategia completa</summary>
            <div class="shop-highlight" style="border-left-color:#ff3b30;">
                <b>1. PHARMOFIT (Metabolismo):</b><br>
                Non basta mangiare meno. Pharmofit costringe il tuo corpo a usare i grassi come fonte primaria di energia grazie alla termogenesi indotta da Caff√® Verde e Arancio Amaro. Sblocca gli stalli metabolici.
            </div>
            <div class="shop-highlight" style="border-left-color:#34c759;">
                <b>2. PHARMODREN (Drenante Urtante):</b><br>
                Spesso quello che credi sia grasso √® acqua extracellulare. Betulla e Ananas prosciugano la ritenzione idrica, sgonfiando immediatamente girovita e gambe pesanti.
            </div>
            <div class="shop-highlight" style="border-left-color:#007aff;">
                <b>3. PHARMOFILLER (Struttura - L'architetto della Pelle):</b><br>
              Ricostruisce l'impalcatura cutanea mentre ti svuoti. Evita l'effetto "pelle svuotata". Mentre perdi volume, il Collagene e l'Acido Ialuronico mantengono la pelle elastica, soda e compatta, prevenendo i cedimenti.
            </div>
        </details>`;

    const stackDetox = `
        Consiglio: <b>Pharmodren</b> e <b>Pharmolain</b>.
        <details class="shop-details">
            <summary>Svela la strategia completa</summary>
            <div class="shop-highlight" style="border-left-color:#34c759;">
                <b>1. PHARMODREN (Wash-out Tossine):</b><br>
                Un vero lavaggio interno. Elimina le tossine accumulate nei tessuti che infiammano il corpo e bloccano il dimagrimento. Risultato: gambe leggere e microcircolo riattivato.
            </div>
            <div class="shop-highlight" style="border-left-color:#ffcc00;">
                <b>2. PHARMOLAIN (Pancia Piatta):</b><br>
                La Bromelina ad alto dosaggio (2500 GDU) √® un potente antinfiammatorio naturale. Polverizza il gonfiore addominale post-pasto e migliora la digestione istantaneamente.
            </div>
        </details>`;

    const stackBeauty = `
        Consiglio: <b>Pharmofiller</b> e <b>Pharmodren</b>.
        <details class="shop-details">
            <summary>Svela la strategia completa</summary>
            <div class="shop-highlight" style="border-left-color:#007aff;">
                <b>1. PHARMOFILLER (Anti-Age):</b><br>
                Dopo i 25 anni perdi l'1.5% di collagene l'anno. Pharmofiller lo reintegra dall'interno, rimpolpando le rughe sottili e garantendo un'idratazione profonda che nessuna crema pu√≤ raggiungere.
            </div>
            <div class="shop-highlight" style="border-left-color:#34c759;">
                <b>2. PHARMODREN (Glow & Ossigeno):</b><br>
                Una pelle bella deve respirare. La Vite Rossa stimola il microcircolo sottocutaneo, portando ossigeno e nutrienti in superficie per un colorito sano, roseo e luminoso.
            </div>
        </details>`;

    const stackRecomp = `
        Consiglio: <b>Pharmofit</b> e <b>Pharmolain</b>.
        <details class="shop-details">
            <summary>Svela la strategia completa</summary>
            <div class="shop-highlight" style="border-left-color:#ff3b30;">
                <b>1. PHARMOFIT (Gestione Carboidrati):</b><br>
                Il Cromo Picolinato indirizza i carboidrati che mangi verso il muscolo (glicogeno) invece che nel tessuto adiposo. Energia esplosiva per l'allenamento e zero accumuli.
            </div>
            <div class="shop-highlight" style="border-left-color:#ffcc00;">
                <b>2. PHARMOLAIN (Assimilazione):</b><br>
                Mangiare proteine non basta, devi assorbirle. La Bromelina massimizza la digestione proteica, garantendo che ogni grammo vada a costruire e riparare le fibre muscolari.
            </div>
        </details>`;

    const stackGain = `
         Consiglio: <b>Pharmofit</b>, <b>Pharmodren</b> e <b>Pharmofiller</b>.
        <details class="shop-details">
            <summary>Svela la strategia completa</summary>
            <div class="shop-highlight" style="border-left-color:#ff3b30;">
                <b>1. PHARMOFIT (Clean Bulk):</b><br>
                Ottimizza la sensibilit√† insulinica. Ti permette di stare in surplus calorico minimizzando l'accumulo di grasso sporco. Crescita pulita e controllata.
            </div>
            <div class="shop-highlight" style="border-left-color:#34c759;">
                <b>2. PHARMODREN (Definizione HD):</b><br>
                L'acqua appanna i muscoli. Pharmodren elimina i liquidi sottocutanei in eccesso, facendo emergere vascolarizzazione e striature muscolari.
            </div>
            <div class="shop-highlight" style="border-left-color:#007aff;">
                <b>3. PHARMOFILLER (Scudo Smagliature):</b><br>
                La crescita muscolare rapida stressa la pelle. L'integrazione di collagene rende il tessuto connettivo elastico, prevenendo la formazione di smagliature su bicipiti e petto.
            </div>
        </details>`;


    // --- STATO E VARIABILI GLOBALI ---
    let foods = JSON.parse(localStorage.getItem('foods_v3')) || [];
        let customFoods = JSON.parse(localStorage.getItem('custom_foods_v1')) || {};
    let waterCount = parseInt(localStorage.getItem('water_count')) || 0;
    let cumulativeDeficit = parseFloat(localStorage.getItem('cumulative_deficit')) || 0;
    let streakCount = parseInt(localStorage.getItem('streak_days')) || 1;
    let appReady = false; // Variabile per silenziare i toast all'avvio


    
    // Recupero Profilo
    let savedProfile = localStorage.getItem('profile_v3');
    let state = JSON.parse(savedProfile) || {
        g: 'm', age: 30, w: 75, h: 175, act: 1.375, goal: 'maintain', 
        targetW: 0, targetD: '', circ_abd: 0, circ_coscia: 0, circ_braccio: 0
    };

    // Variabili Calcolate Globale
    let TGT_CAL = 0, TGT_C = 0, TGT_P = 0, TGT_F = 0, BMR = 0, TDEE = 0, PT_MIN_G = 0;

    // --- RESET GIORNALIERO (4:00 AM) ---
    const now = new Date(); now.setHours(now.getHours() - 4);
    const todayStr = now.toDateString();
    
    if (localStorage.getItem('app_date') !== todayStr) {
        let lastTarget = parseFloat(localStorage.getItem('last_day_target')) || 0;
        let lastConsumed = parseFloat(localStorage.getItem('last_day_total_consumed')) || 0;
        
        if (lastTarget > 0) {
            cumulativeDeficit += (lastTarget - lastConsumed);
            localStorage.setItem('cumulative_deficit', cumulativeDeficit);
        }

        // Platino Check (5 giorni)
        const lastPrecision = parseInt(localStorage.getItem('last_day_precision')) || 0;
        let pStreak = parseInt(localStorage.getItem('platinum_streak')) || 0;
        if (lastPrecision >= 3) pStreak++; else pStreak = 0;
        localStorage.setItem('platinum_streak', pStreak);

        if (pStreak >= 5 && !localStorage.getItem('claimed_platinum_5')) {
            alert("üíé PLATINO SBLOCCATO! 5 giorni di precisione Oro!\n\nIl tuo premio speciale √®: PHARMO5DAYS\n\nUsalo subito su pharmo.it per i tuoi prodotti preferiti!");
            window.open('https://www.pharmo.it', '_blank');
            localStorage.setItem('claimed_platinum_5', 'true');
        }

        // Reset Giornaliero
        if (state.circ_abd > 0) localStorage.setItem('last_week_abd', state.circ_abd);
        if (state.circ_coscia > 0) localStorage.setItem('last_week_coscia', state.circ_coscia);
        if (state.circ_braccio > 0) localStorage.setItem('last_week_braccio', state.circ_braccio);

        localStorage.setItem('foods_v3', JSON.stringify([])); 
        localStorage.setItem('water_count', 0);
        localStorage.setItem('water_last_time', 0);
        localStorage.setItem('app_date', todayStr);
        
        // Streak Visit
        let lastVisit = localStorage.getItem('last_visit_date');
        let yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
        if (lastVisit !== todayStr) {
            streakCount = (lastVisit === yesterday.toDateString()) ? streakCount + 1 : 1;
            localStorage.setItem('streak_days', streakCount);
            localStorage.setItem('last_visit_date', todayStr);
        }
        foods = []; waterCount = 0;
    }

    // --- FUNZIONI UTILI ---
        function showToast(msg) {
        const t = document.getElementById('smartToast');
        document.getElementById('toastMsg').innerText = msg;
        t.classList.add('toast-visible');
        // Ora rimane visibile per 10 secondi (10000 ms)
        setTimeout(() => t.classList.remove('toast-visible'), 10000); 
    }
    
    function copyCode(el) { navigator.clipboard.writeText(el.innerText); alert("Codice copiato!"); }
    function closeReward(id) { 
        if(id==='waterRewardModal') window.open('https://www.pharmo.it', '_blank');
        document.getElementById(id).style.display = 'none'; 
        localStorage.setItem(id === 'rewardModal' ? 'reward_claimed' : 'water_reward_claimed', 'true');
    }
    function acceptTerms() { document.getElementById('disclaimerModal').style.display = 'none'; localStorage.setItem('terms_accepted_v1', 'true'); document.getElementById('profileDetails').open = true; }
    // --- GESTIONE DATABASE CIBI PERSONALE ---
    
       // --- GESTIONE CIBI AVANZATA ---

    // 1. Carica la tendina
    function renderFavSelect() {
        const sel = document.getElementById('favSelect');
        sel.innerHTML = '<option value="">-- Scegli o Crea Nuovo --</option>';
        Object.keys(customFoods).sort().forEach(name => {
            let opt = document.createElement('option');
            opt.value = name;
            opt.innerText = name;
            sel.appendChild(opt);
        });
    }

    // 2. Carica Cibo + Grammatura salvata
    function loadFav() {
        const name = document.getElementById('favSelect').value;
        if(customFoods[name]) {
            const f = customFoods[name];
            document.getElementById('inName').value = name;
            document.getElementById('inCal100').value = f.k;
            document.getElementById('inCarb100').value = f.c;
            document.getElementById('inProt100').value = f.p;
            document.getElementById('inFat100').value = f.f;
            // Carica la grammatura preferita (o 100 se non esiste)
            document.getElementById('inGrams').value = f.defG || 100; 
        }
    }

    // 3. Salva Cibo + Grammatura attuale
    function saveFav() {
        const n = document.getElementById('inName').value.trim();
        const k = parseFloat(document.getElementById('inCal100').value);
        const c = parseFloat(document.getElementById('inCarb100').value)||0;
        const p = parseFloat(document.getElementById('inProt100').value)||0;
        const f = parseFloat(document.getElementById('inFat100').value)||0;
        const g = parseFloat(document.getElementById('inGrams').value)||100;

        if(!n || isNaN(k)) { alert("Inserisci Nome e Kcal per salvare."); return; }

        customFoods[n] = { k, c, p, f, defG: g }; // Salva anche i grammi preferiti
        localStorage.setItem('custom_foods_v1', JSON.stringify(customFoods));
        renderFavSelect();
        document.getElementById('favSelect').value = n;
        showToast("Salvato! Ricorder√≤ questi grammi.");
    }

    // 4. Elimina Cibo
    function deleteFav() {
        const n = document.getElementById('favSelect').value;
        if(n && confirm(`Eliminare "${n}"?`)) {
            delete customFoods[n];
            localStorage.setItem('custom_foods_v1', JSON.stringify(customFoods));
            renderFavSelect();
            document.querySelectorAll('.add-box input').forEach(i => i.value = '');
        }
    }

    // 5. CALCOLA E AGGIUNGE AL DIARIO (Sostituisce la vecchia add)
        function addCalculated() {
        const n = document.getElementById('inName').value;
        const k100 = parseFloat(document.getElementById('inCal100').value);
        const c100 = parseFloat(document.getElementById('inCarb100').value)||0;
        const p100 = parseFloat(document.getElementById('inProt100').value)||0;
        const f100 = parseFloat(document.getElementById('inFat100').value)||0;
        const g = parseFloat(document.getElementById('inGrams').value);

        if(n && !isNaN(k100) && g > 0) {
            const finalK = Math.round((k100 * g) / 100);
            const finalC = Math.round((c100 * g) / 100);
            const finalP = Math.round((p100 * g) / 100);
            const finalF = Math.round((f100 * g) / 100);

            foods.push({ n: `${n} (${g}g)`, k: finalK, c: finalC, p: finalP, f: finalF });
            
            // --- QUESTA √à LA RIGA CHE MANCAVA PER SALVARE ---
            localStorage.setItem('foods_v3', JSON.stringify(foods)); 
            // ------------------------------------------------

            document.querySelectorAll('.add-box input').forEach(i=>i.value=''); 
            document.getElementById('inGrams').value = '100'; 

            render();
            checkSmartAdvice(n, finalK, finalC, TGT_CAL);
            showToast(`Aggiunto: ${finalK} kcal`);

            const ptCheck = parseFloat(localStorage.getItem('pt_min_g')) || 0;
            let curP = foods.reduce((a,b)=>a+b.p, 0);
            if (ptCheck > 0 && finalP >= 30 && curP < ptCheck) {
                showToast(`Ottimo carico proteico! üí™`);
            }
        } else {
            alert("Compila i dati e la grammatura.");
        }
    }

    // --- LOGICA PRINCIPALE (CALC) ---
    function calc() {
        // Aggiorna Stato da Input
        state.g = document.getElementById('gender').value;
        state.age = parseFloat(document.getElementById('age').value);
        state.w = parseFloat(document.getElementById('weight').value);
        state.h = parseFloat(document.getElementById('height').value);
        state.act = parseFloat(document.getElementById('act').value);
        state.goal = document.getElementById('goal').value;
        state.targetW = parseFloat(document.getElementById('targetWeightInput').value) || 0;
        state.targetD = document.getElementById('targetDateInput').value || '';
        state.circ_abd = parseFloat(document.getElementById('circ_abd').value) || 0;
        state.circ_coscia = parseFloat(document.getElementById('circ_coscia').value) || 0;
        state.circ_braccio = parseFloat(document.getElementById('circ_braccio').value) || 0;
        localStorage.setItem('profile_v3', JSON.stringify(state));

        // BMR & TDEE
        let s = (10 * state.w) + (6.25 * state.h) - (5 * state.age);
        BMR = (state.g === 'm') ? s + 5 : s - 161;
        TDEE = Math.round(BMR * state.act);

        // Goal Logic
        let adj = { 'lose_aggr': 0.80, 'lose_athlete_15': 0.85, 'lose_cons': 0.90, 'detox': 0.95, 'beauty': 1.0, 'recomp': 0.95, 'maintain': 1.0, 'gain': 1.10 };
        TGT_CAL = Math.round(TDEE * adj[state.goal]);
        if (TGT_CAL < BMR) TGT_CAL = Math.round(BMR);
        
                // --- BLOCCO DATA DI SICUREZZA (RIPRISTINATO) ---
        if (state.targetW > 0 && state.w > state.targetW) {
            let weightGap = state.w - state.targetW;
            let kcalGapTotal = weightGap * KCAL_PER_KG_FAT;
            let minDaysNeeded = Math.ceil(kcalGapTotal / MAX_SAFE_DAILY_DEFICIT);
            
            let earliestDate = new Date(Date.now() + minDaysNeeded * SECONDS_IN_DAY * 1000);
            let minDateString = earliestDate.toISOString().split('T')[0];
            
            document.getElementById('targetDateInput').setAttribute('min', minDateString);
        } else {
            document.getElementById('targetDateInput').removeAttribute('min');
        }
        // -----------------------------------------------

        // Text & Macros
        let p_r, c_r, f_r, gTxt, sTit, sDes;
        let reqHighProt = false;

        if (state.goal.startsWith('lose')) {
            sTit = "Protocollo Total Body 3-Fasi"; sDes = stackLoss;
            if (state.goal === 'lose_aggr') { c_r=0.4; p_r=0.3; f_r=0.3; gTxt="Perdita Peso Standard (-20%)"; reqHighProt=false; }
            else if (state.goal === 'lose_athlete_15') { c_r=0.35; p_r=0.35; f_r=0.3; gTxt="Atleta Cut Aggressivo (-15%)"; reqHighProt=true; }
            else { c_r=0.4; p_r=0.3; f_r=0.3; gTxt="Atleta Cut Conservativo (-10%)"; reqHighProt=true; }
        } else if (state.goal === 'recomp') {
            c_r=0.35; p_r=0.35; f_r=0.3; gTxt="Ricomposizione Corporea"; sTit="Protocollo Recomp"; sDes=stackRecomp; reqHighProt=true;
        } else {
            // Defaults for Detox, Beauty, Maintain, Gain
            c_r=0.5; p_r=0.2; f_r=0.3; 
            if(state.goal==='detox') { gTxt="Detox (-5%)"; sTit="Protocollo Detox"; sDes=stackDetox; }
            else if(state.goal==='beauty') { gTxt="Beauty (Mantenimento)"; sTit="Protocollo Glow"; sDes=stackBeauty; c_r=0.45; p_r=0.25; }
            else if(state.goal==='gain') { gTxt="Surplus (+10%)"; sTit="Protocollo Struttura"; sDes=stackGain; }
            else { gTxt="Mantenimento"; sTit="Protocollo Definizione"; sDes=stackGain; }
        }

        // Soglia Proteica Minima (Solo per Atleti/Recomp)
        PT_MIN_G = reqHighProt ? Math.round(state.w * PT_MIN_MULTIPLIER) : 0;
        localStorage.setItem('pt_min_g', PT_MIN_G);

        // Aggiornamento UI Calcoli
        TGT_C = Math.round((TGT_CAL * c_r)/4); TGT_P = Math.round((TGT_CAL * p_r)/4); TGT_F = Math.round((TGT_CAL * f_r)/9);
        document.getElementById('shopTitle').innerText = sTit; document.getElementById('shopDesc').innerHTML = sDes;
        document.getElementById('targetDisplay').innerText = TGT_CAL;
        document.getElementById('scientificData').innerHTML = `Metabolismo Basale (BMR): <b>${Math.round(BMR)}</b> kcal<br>Fabbisogno Totale (TDEE): <b>${TDEE}</b> kcal<br>Piano: <b>${gTxt}</b>`;

        // BMR Bar Marker
        let bmrPct = Math.min((BMR / TGT_CAL) * 100, 95);
        document.getElementById('bmrMarker').style.left = bmrPct + "%";
        document.getElementById('bmrTag').style.left = bmrPct + "%";

        // Visibilit√† Braccio
        const armWrap = document.getElementById('braccio_input_wrapper');
        if(armWrap) armWrap.style.display = ['gain', 'recomp', 'lose_athlete_15', 'lose_cons'].includes(state.goal) ? 'block' : 'none';

        // Analisi Previsionale e Misure
        updatePredictionStatus();
        checkCircumference();
        render();
        localStorage.setItem('last_day_target', TGT_CAL);
    }

    // --- RENDER UI CORRETTO ---
    function render() {
        const list = document.getElementById('list'); 
        if(list) list.innerHTML = '';
        
        let curCal=0, curC=0, curP=0, curF=0;
        
        // 1. Disegna Lista
        foods.slice().reverse().forEach((f, idx) => {
            curCal += f.k; curC += f.c; curP += f.p; curF += f.f;
            const li = document.createElement('li'); li.className = 'food-item';
            li.innerHTML = `<div class="food-info"><div class="food-name">${f.n}</div><div class="food-details">C:${f.c} P:${f.p} G:${f.f}</div></div><div class="food-actions"><span class="food-cal">${f.k}</span><button class="btn-del" onclick="rem(${foods.length - 1 - idx})">elimina</button></div>`;
            if(list) list.appendChild(li);
        });

        // 2. Calcoli
        let diff = TGT_CAL - curCal;
        const remEl = document.getElementById('remCal');
        if(remEl) { remEl.innerText = diff; remEl.style.color = diff < 0 ? 'var(--danger)' : 'var(--text-main)'; }
        
        let pct = TGT_CAL > 0 ? Math.min((curCal / TGT_CAL) * 100, 100) : 0;
        let barColor = "var(--success)"; let msgText = "‚úÖ Ottimo lavoro!";
        if (curCal < BMR) { barColor = "var(--warn)"; msgText = "‚ö†Ô∏è Energia insufficiente"; }
        else if (curCal > TGT_CAL) { barColor = "var(--danger)"; msgText = "‚õî Limite superato"; }
        
        const calBar = document.getElementById('calBar');
        if(calBar) { calBar.style.width = pct + "%"; calBar.style.background = barColor; }
        
        const stText = document.getElementById('statusText');
        if(stText) { stText.innerText = msgText; stText.style.color = barColor; }

        setBar('carb', curC, TGT_C); setBar('prot', curP, TGT_P); setBar('fat', curF, TGT_F);

        // 3. Precisione
        const badge = document.getElementById('bullseyeBadge');
        if(badge) {
            let cardC='card-default', cardT='Inizia a loggare';
            if(diff < 0) { cardC='card-default'; cardT=`‚ùå SFORATO di ${Math.abs(diff)} Kcal`; }
            else if(diff<=50 && curCal>0) { cardC='card-gold'; cardT='ü•á ORO (Perfetto)'; }
            else if(diff<=100 && curCal>0) { cardC='card-silver'; cardT='ü•à ARGENTO (Ottima)'; }
            else if(diff<=200 && curCal>0) { cardC='card-bronze'; cardT='ü•â BRONZO (Buona)'; }
            else if(curCal>0) { cardC='card-default'; cardT='‚ö†Ô∏è INCOMPLETO'; }
            badge.className = `precision-card ${cardC}`; badge.innerText = cardT;
            let precLvl=0; if(cardC==='card-gold') precLvl=3; else if(cardC==='card-silver') precLvl=2; else if(cardC==='card-bronze') precLvl=1;
            localStorage.setItem('last_day_precision', precLvl);
        }

          // 4. Avvisi Proteine (Versione compatta con "minimi")
        const highProtGoals = ['lose_athlete_15', 'lose_cons', 'recomp'];
        const ptCheck = parseFloat(localStorage.getItem('pt_min_g')) || 0;
        let alertHTML = '';
        const currentHour = new Date().getHours(); 

        if (highProtGoals.includes(state.goal) && ptCheck > 0 && curCal > 0) {
            // A. OBIETTIVO RAGGIUNTO (Verde - Compatto ed esplicativo)
            if (curP >= ptCheck) {
                alertHTML = `<div style="color:var(--success); font-size:0.8rem; font-weight:600; margin-top:10px; text-align: center;">‚úÖ Ottimo! Muscoli Protetti (${curP}g su ${ptCheck}g minimi).</div>`;
            }
            // B. OBIETTIVO MANCATO (Arancione - Solo dopo le 17:00)
            else if (currentHour >= 17) {
                alertHTML = `<div style="color:var(--orange); font-size:0.8rem; font-weight:700; background:#fff5e6; padding:8px; border-radius:8px; margin-top:10px; border:1px solid var(--orange); text-align: center;">‚ö†Ô∏è **Attenzione Atleta!** Quota minima proteica (${ptCheck}g) non ancora raggiunta. Recupera a cena!</div>`;
            }
        }
        
        const protAlert = document.getElementById('protAlert');
        if(protAlert) protAlert.innerHTML = alertHTML;

        const cumDisplay = document.getElementById('cumulativeDisplay');
        if(cumDisplay) cumDisplay.innerText = (cumulativeDeficit / KCAL_PER_KG_FAT).toFixed(1) + " Kg";

        return { curP: curP, curCal: curCal }; 
    }

    function setBar(id, val, max) {
        document.getElementById(id+'Bar').style.width = Math.min((val/max)*100, 100) + "%";
        document.getElementById(id+'Txt').innerText = `${val} / ${max}g`;
    }

    // --- FUNZIONI LOGICHE EXTRA ---
            function checkCircumference() {
        // 1. Recupera dati storici
        const oldAbd = parseFloat(localStorage.getItem('last_week_abd')) || 0;
        const oldCoscia = parseFloat(localStorage.getItem('last_week_coscia')) || 0;
        const oldBraccio = parseFloat(localStorage.getItem('last_week_braccio')) || 0;
        
        // 2. Recupera dati attuali
        const nowAbd = state.circ_abd;
        const nowCoscia = state.circ_coscia;
        const nowBraccio = state.circ_braccio;

        let parts = []; 
        let delay = 0; // Timer per non sovrapporre i messaggi

        // -------------------------------------------------------
        // A. CONTROLLO ADDOME
        // -------------------------------------------------------
        if (oldAbd > 0 && nowAbd > 0) {
            let diffAddome = nowAbd - oldAbd; 
            parts.push(`Addome: ${diffAddome > 0 ? '+' : ''}${diffAddome.toFixed(1)}`);
            
            if (appReady) {
                if (diffAddome <= -0.1) {
                    // DIMINUISCE: Pharmofiller (Elasticit√†)
                    setTimeout(() => showToast("‚úÖ Addome ridotto! Usa Pharmofiller per elasticit√† e tonicit√†."), delay);
                    delay += 10500; 
                } else if (diffAddome >= 0.1) {
                    // AUMENTA: Pharmolain (Gonfiore)
                    setTimeout(() => showToast("‚ö†Ô∏è Addome aumentato! Gonfiore? Usa Pharmolain."), delay);
                    delay += 10500;
                }
            }
        }

        // -------------------------------------------------------
        // B. CONTROLLO COSCIA
        // -------------------------------------------------------
        if (oldCoscia > 0 && nowCoscia > 0) {
            let diffCoscia = nowCoscia - oldCoscia;
            parts.push(`Coscia: ${diffCoscia > 0 ? '+' : ''}${diffCoscia.toFixed(1)}`);
            
            if (appReady) {
                if (diffCoscia <= -0.1) {
                    // DIMINUISCE: Pharmofiller (Elasticit√†)
                    setTimeout(() => showToast("‚úÖ Coscia pi√π snella! Usa Pharmofiller per elasticit√† e tonicit√†."), delay);
                    delay += 10500;
                } else if (diffCoscia >= 0.1) {
                    // AUMENTA: PharmoVen (Circolazione)
                    setTimeout(() => showToast("üö® Coscia aumentata! Problemi di circolazione? Usa PharmoVen."), delay);
                    delay += 10500;
                }
            }
        }

        // -------------------------------------------------------
        // C. CONTROLLO BRACCIO
        // -------------------------------------------------------
        if (oldBraccio > 0 && nowBraccio > 0) {
            let diffBraccio = nowBraccio - oldBraccio;
            parts.push(`Braccio: ${diffBraccio > 0 ? '+' : ''}${diffBraccio.toFixed(1)}`);
            
            if (appReady) {
                if (diffBraccio >= 0.1) {
                    // AUMENTA
                    if (['gain','recomp'].includes(state.goal)) {
                        // Se fai massa -> Bene
                        setTimeout(() => showToast("üí™ Braccio in crescita! Ottimo lavoro."), delay);
                    } else {
                        // Se vuoi dimagrire -> Male (Ritenzione) -> Pharmodren
                        setTimeout(() => showToast("üíß Braccio aumentato! Ritenzione idrica? Usa Pharmodren."), delay);
                    }
                } else if (diffBraccio <= -0.1) {
                    // DIMINUISCE: Pharmofiller (Elasticit√†)
                    setTimeout(() => showToast("‚úÖ Braccio definito! Usa Pharmofiller per elasticit√† e tonicit√†."), delay);
                }
            }
        }

        // -------------------------------------------------------
        // D. STAMPA A VIDEO NEL BOX
        // -------------------------------------------------------
        const outputBox = document.getElementById('circAnalysis');
        if (parts.length > 0) {
            outputBox.innerText = "Diff: " + parts.join(" | ") + " cm";
            outputBox.style.color = "#004494"; 
            outputBox.style.fontWeight = "600";
        } else {
            outputBox.innerText = "Aggiorna ogni 7 giorni per vedere le differenze.";
            outputBox.style.color = "#666";
            outputBox.style.fontWeight = "400";
        }
    }

        function updatePredictionStatus() {
        const box = document.getElementById('predictionStatus');
        
        // Se mancano dati
        if (!state.targetD || state.targetW <= 0) { 
            box.innerHTML = "Inserisci Peso/Data Obiettivo per l'Analisi üí°"; 
            box.style.background="#eef7ff"; 
            box.style.color="#003a80";
            box.style.borderColor="#dbeafe";
            return; 
        }
        
        const daysLeft = Math.ceil((new Date(state.targetD) - new Date()) / (1000 * 86400));
        
        // Se la data √® passata o oggi
        if (daysLeft <= 0) { 
            box.innerHTML = "üìÖ Data scaduta! Aggiorna il calendario."; 
            box.style.background="#ffc9c9"; 
            box.style.color="#b30000";
            box.style.borderColor="#ff3b30";
            return; 
        }
        
        const needDeficit = ((state.w - state.targetW) * KCAL_PER_KG_FAT) / daysLeft;
        const currDeficit = TDEE - TGT_CAL;
        
        // CASO 1: Il piano va bene
        if (currDeficit >= needDeficit) { 
            box.innerHTML = "‚úÖ **Piano Efficace!** Raggiungerai l'obiettivo entro la data."; 
            box.style.background="#c8f9c8"; 
            box.style.color="#006400";
            box.style.borderColor="#34c759";
        }
        // CASO 2: Il piano √® troppo lento
        else { 
            box.innerHTML = "‚ö†Ô∏è **Sprint necessario!** Per questa data serve un deficit maggiore. Prova a cambiare piano obiettivo o posticipa la data."; 
            box.style.background="#fff5e6"; // Sfondo Arancione chiaro
            box.style.color="#b35900";      // Testo Arancione scuro
            box.style.borderColor="#ff9500";
        }
    }

    function rem(i) { foods.splice(i, 1); render(); }
    function resetAll() { if(confirm("Vuoi iniziare una nuova giornata?\n\nATTENZIONE: Se hai completato la giornata e superato le 4:00 AM, il deficit calorico di oggi √® gi√† stato salvato automaticamente. Se cancelli ora, perderai solo i dati inseriti dopo l'ultimo reset giornaliero.")) { foods=[]; localStorage.setItem('foods_v3', '[]'); waterCount=0; renderWater(); render(); } }
    
    // --- WATER ---
    function renderWater() {
        const g = document.getElementById('waterGrid'); g.innerHTML='';
        for(let i=0; i<8; i++) {
            let d=document.createElement('div'); d.className=`water-glass ${i<waterCount?'filled':(i===waterCount?'next-up':'')}`;
            d.onclick=()=>toggleWater(i); g.appendChild(d);
        }
        document.getElementById('waterCountDisplay').innerText = `${waterCount}/8`;
        localStorage.setItem('water_count', waterCount);
        
        // Update Challenge Text
        let ws = parseInt(localStorage.getItem('water_streak_days')) || 0;
        let dayText = (waterCount === 8) ? "‚úÖ Obiettivo di oggi raggiunto!" : `üíß Sfida Drenante: Giorno ${ws + 1} di 3`;
        document.getElementById('waterStatus').innerText = dayText;

        if(waterCount===8) {
             if(localStorage.getItem('last_water_win_date') !== todayStr) {
                 localStorage.setItem('water_streak_days', ws + 1);
                 localStorage.setItem('last_water_win_date', todayStr);
                 if(ws+1 >= 3 && !localStorage.getItem('water_reward_claimed')) document.getElementById('waterRewardModal').style.display='flex';
             }
        }
    }
    
    function toggleWater(i) {
        const currentTime = Date.now();
        const lastDrink = parseInt(localStorage.getItem('water_last_time')) || 0;
        const oneHour = 3600000; 

        if (i === waterCount) {
            // Check Timer (only if not first glass)
            if (waterCount > 0 && (currentTime - lastDrink < oneHour)) {
                let minLeft = Math.ceil((oneHour - (currentTime - lastDrink)) / 60000);
                showToast(`‚è≥ Aspetta ancora ${minLeft} min per la corretta idratazione.`);
                return;
            }
            waterCount++;
            localStorage.setItem('water_last_time', currentTime);
            showToast("Idratazione registrata! üíß");
            renderWater();
        } 
        // REMOVED "else if" block to prevent removing glasses
    }

    // --- INFO POPUPS ---
    function showPrecisionInfo() {
        const platinumStreak = parseInt(localStorage.getItem('platinum_streak')) || 0;
        const msg = `üèÜ SISTEMA CARTE PRECISIONE PHARMO üèÜ\n\nIl tuo obiettivo √® usare tutte le calorie (TGT CAL) a disposizione, senza sforare!\n\n**CRITERI GIORNALIERI (Precisione Massima):**\n   ‚Ä£ ORO ü•á:  Rimanere entro 50 Kcal dal Target (massimo deficit).\n   ‚Ä£ ARGENTO ü•à: Rimanere tra 51 Kcal e 100 Kcal dal Target.\n   ‚Ä£ BRONZO ü•â: Rimanere tra 101 Kcal e 200 Kcal dal Target.\n   \n   (Lasciare >200 Kcal o Sforare = Serie interrotta.)\n\n**RICONOSCIMENTO PLATINO (Costanza):**\nLa Carta Platino √® il traguardo massimo a lungo termine!\nSi sblocca mantenendo la **Carta ORO (Perfetto)** per 5 giorni consecutivi.\n\n   ‚Ä£ Stato attuale: ${platinumStreak} giorni consecutivi Oro.\n\nMantieni la serie Oro per sbloccare la **Serie Platino** al 5¬∞ giorno, l'unica sfida ad offrire un codice sconto monetario!`;
        alert(msg);
    }

    function showStreakInfo() {
        const streakCount = parseInt(localStorage.getItem('streak_days')) || 0; 
        let alertMessage = "LA SFIDA DI PHARMO.IT\n\nUsa l'applicazione con costanza per sbloccare Premi Visivi Esclusivi!\n\nLivelli:\n- 7 Giorni: Badge Bronzo\n- 14 Giorni: Badge Argento\n- 30 Giorni: Badge Oro\n\nAttuale: " + streakCount + " giorni.\n\n‚ö†Ô∏è NOTA: Non ci sono codici sconto in questa serie, concentrati sul Platino per il premio monetario.\n\nüí° IMPORTANTE: Ricordati di aggiornare il tuo peso nel profilo ogni 7 giorni.";
        alert(alertMessage);
    }

    function checkSmartAdvice(n, k, c, max) { if(c > max/2) showToast("Troppi Carboidrati? Gestiscili con Pharmofit."); }

    function checkTimeAdvice(currentProtein) {
        const hour = new Date().getHours();
        const currentPTMinG = parseFloat(localStorage.getItem('pt_min_g')) || 0;

        if (hour >= 6 && hour < 11) {
            showToast("Buongiorno! Attiva il metabolismo con Pharmofit.");
        } else if (hour >= 12 && hour < 15) {
            showToast("Pranzo proteico? Pharmolain aiuta la digestione.");
        } else if (hour >= 20 && hour <= 22) { 
            if (currentPTMinG > 0 && currentProtein < currentPTMinG) {
                let diff = Math.round(currentPTMinG - currentProtein);
                showToast(`‚ö†Ô∏è SOS Proteine! Mancano ${diff}g per proteggere la massa muscolare oggi. Recupera subito!`);
            } else {
                 showToast("La pelle si rigenera di notte. Usa Pharmofiller.");
            }
        }
    }

    // --- INIT ---
    if(!localStorage.getItem('terms_accepted_v1')) document.getElementById('disclaimerModal').style.display='flex';
    document.getElementById('gender').value = state.g; document.getElementById('age').value = state.age;
    document.getElementById('weight').value = state.w; document.getElementById('height').value = state.h;
    document.getElementById('act').value = state.act; document.getElementById('goal').value = state.goal;
    document.getElementById('targetWeightInput').value = state.targetW || ''; document.getElementById('targetDateInput').value = state.targetD || '';
    document.getElementById('circ_abd').value = state.circ_abd || ''; document.getElementById('circ_coscia').value = state.circ_coscia || ''; document.getElementById('circ_braccio').value = state.circ_braccio || '';
    
    document.getElementById('streakDisplay').innerText = `üî• ${streakCount}gg`;
    let ps = parseInt(localStorage.getItem('platinum_streak'))||0;
    let pel = document.getElementById('platinumStreakDisplay');
    pel.innerText = `${ps}/5 gg ORO`;
    if(ps>=5) { pel.innerText = `üíé PLATINO (${ps}gg)`; pel.style.color="#FFD700"; }

    renderFavSelect();
    calc();
    renderWater();
    const finalTotals = render(); 
    checkTimeAdvice(finalTotals.curP); 
    appReady = true; 

</script>
</body>
</html>
