<!DOCTYPE html>
<html lang="it">
<nead>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pharmocounter</title>
    <style>
    * {
    box-sizing: border-box;
}

body {
    overflow-x: hidden;
    width: 100%;
    position: relative;
    margin: 0;
    padding: 0;
}

.app-container {
    max-width: 100%;
    overflow-x: hidden;
}

/* MODIFICHE PER DISCREZIONE - Uniscile alla classe precedente */
.btn-recovery-active {
    background: linear-gradient(135deg, #00d4ff 0%, #0077ff 50%, #00d4ff 100%) !important;
    background-size: 200% auto !important;
    color: white !important;
    box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);
    transition: 0.3s;
    animation: pulseBlue 2s infinite, shine 3s infinite linear;
    white-space: nowrap;
    min-width: fit-content;
    border: none;
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.3px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}


@keyframes shine {
    to { background-position: 200% center; }
}

@keyframes pulseBlue {
    0% { transform: scale(1); opacity: 0.9; }
    50% { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1); opacity: 0.9; }
}

    /* LIVELLO 1 & 2 (7 e 14 giorni): ORO CLASSICO */
.streak-gold {
    background: linear-gradient(135deg, #FFD700, #FFA500) !important;
    color: white !important;
    border: 2px solid #fff !important;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
    animation: crownPulse 2s infinite;
}

/* LIVELLO 3 (30+ giorni): ORO PLATINUM (Bianco Brillante/Diamante) */
.streak-platinum {
    /* ORO GIALLO INTENSO */
    background: linear-gradient(135deg, #FFD700 0%, #FFEA00 50%, #FFB900 100%) !important;
    color: #5c4400 !important; /* Testo marrone scuro per leggere bene */
    border: 2px solid #ffffff !important;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.8) !important;
    animation: crownPulse 1.2s infinite ease-in-out !important;
    font-weight: 900 !important;
}

    @keyframes crownPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
/* Applica l'effetto se vuoi che l'emoji della corona "pulsi" nel toast */
        :root {
            --bg-color: #f2f2f7; --card-bg: #ffffff; --text-main: #000000; --text-sec: #8e8e93;
            --accent: #007aff; --danger: #ff3b30; --warn: #ffcc00; --orange: #ff9500; --success: #34c759;
            --carb-color: #5ac8fa; --prot-color: #ff2d55; --fat-color: #ffcc00;
            --shop-bg: #f4f9ff; --shop-border: #dbeafe; --shop-text: #003a80;
        }

        /* RESET & BASE */
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); display: flex; justify-content: center; min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box; color: var(--text-main); -webkit-font-smoothing: antialiased; }
        .app-container { background: var(--card-bg); width: 100%; max-width: 420px; border-radius: 24px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.06); display: flex; flex-direction: column; gap: 20px; position: relative; }

        /* HEADER */
        .header-area { text-align: center; padding-bottom: 10px; margin-bottom: 5px; }
        .date-badge { font-size: 0.8rem; color: var(--text-sec); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 5px; }
        h1 { margin: 0; font-size: 2rem; font-weight: 800; letter-spacing: -0.5px; line-height: 1; background: linear-gradient(135deg, #007aff 0%, #004494 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block; }
        .subtitle-brand { display: block; font-size: 0.95rem; color: var(--text-sec); font-weight: 500; margin-top: 5px; }
        .streak-badge { position: absolute; top: 0; right: 0; background: #fff5e6; color: #ff9500; font-size: 0.75rem; font-weight: 700; padding: 6px 12px; border-radius: 20px; border: 1px solid #ffeebb; cursor: pointer; transition: transform 0.1s; }
        .streak-badge:active { transform: scale(0.95); }

        /* CARDS & INPUTS */
        .card { background: #f9f9fb; border-radius: 18px; padding: 18px; border: 1px solid rgba(0,0,0,0.03); }
        summary { cursor: pointer; font-weight: 600; font-size: 0.95rem; outline: none; display: flex; justify-content: space-between; align-items: center; color: var(--accent); list-style: none; }
        summary::-webkit-details-marker { display: none; }
        summary::after { content: '‚öôÔ∏è'; font-size: 1rem; opacity: 0.7; transition: transform 0.2s; }
        details[open] summary::after { transform: rotate(180deg); }
        
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; align-items: end; }
        label { font-size: 0.75rem; font-weight: 600; color: var(--text-sec); display: block; margin-bottom: 6px; }
        
        select, input { 
            width: 100%; padding: 0 12px; border-radius: 12px; 
            border: 1px solid #e5e5ea; background: #fff; 
            font-size: 0.95rem; box-sizing: border-box; 
            color: var(--text-main); height: 48px; 
            line-height: normal; -webkit-appearance: none; appearance: none;
            margin: 0;
        } 
        select:focus, input:focus { border-color: var(--accent); outline: none; }
        
        .info-box { grid-column: 1 / -1; font-size: 0.75rem; color: #666; background: #fff; padding: 12px; border-radius: 10px; border: 1px solid #eee; line-height: 1.5; margin-top: 5px; }

        /* DASHBOARD & BARS */
        .dash-header { text-align: center; margin: 10px 0; }
        .big-val { font-size: 3.2rem; font-weight: 800; line-height: 1; letter-spacing: -2px; color: var(--text-main); }
        .sub-val { font-size: 0.9rem; color: var(--text-sec); margin-top: 6px; font-weight: 500; }
        
        .track { background: #eef0f2; height: 14px; width: 100%; border-radius: 7px; overflow: hidden; position: relative; }
        .fill { height: 100%; width: 0%; border-radius: 7px; transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.4s; }
        .bmr-line { position: absolute; top: 0; bottom: 0; width: 2px; background: rgba(0,0,0,0.3); z-index: 5; border-right: 1px dashed rgba(255,255,255,0.7); }
        .bmr-tag { position: absolute; top: -18px; font-size: 0.65rem; color: var(--text-sec); transform: translateX(-50%); font-weight: 700; text-transform: uppercase; }
        .status-text { text-align: center; font-size: 0.85rem; font-weight: 600; margin-top: 10px; min-height: 1.2em; }

        /* MACROS BOX */
        .macro-grid { display: grid; gap: 18px; margin-top: 25px; }
        .macro-item { display: flex; flex-direction: column; }
        .bar-label { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: #555; }

        /* CUMULATIVE & CARDS */
        .cumulative-box { background: #e6f7ff; border: 1px solid #cceeff; border-radius: 18px; padding: 20px; text-align: center; margin-bottom: 5px; }
        .cumul-label { font-size: 0.8rem; font-weight: 600; color: #0056b3; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .cumul-value { font-size: 2rem; font-weight: 800; color: #007aff; line-height: 1; }
        .pred-status { font-size: 0.85rem; font-weight: 600; margin-top: 15px; padding: 10px; border-radius: 10px; line-height: 1.4; border: 1px solid; transition: all 0.3s ease; }
        
        .precision-card { display: inline-block; padding: 8px 15px; border-radius: 12px; font-size: 1rem; font-weight: 800; letter-spacing: 0.5px; margin-top: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); min-width: 150px; text-align: center; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); cursor: pointer; }
        .card-gold { background: linear-gradient(135deg, #FFD700, #DAA520); color: #805a00; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); }
        .card-silver { background: linear-gradient(135deg, #C0C0C0, #808080); color: #444; }
        .card-bronze { background: linear-gradient(135deg, #CD7F32, #A0522D); color: #ffffff; }
        .card-default { background: #f0f0f5; color: var(--text-sec); }

        /* WATER */
        .water-box { margin-top: 20px; padding: 15px; background: #eef7ff; border-radius: 16px; border: 1px solid #dbeafe; margin-bottom: 20px; }
        .water-title { font-size: 0.85rem; font-weight: 700; color: #004494; margin-bottom: 12px; display: flex; justify-content: space-between; }
        .water-grid { display: flex; justify-content: space-between; gap: 4px; }
        .water-glass { flex: 1; height: 40px; background: #d1e3fa; border-radius: 4px 4px 8px 8px; cursor: pointer; transition: all 0.2s; position: relative; border: 2px solid #a6c8ff; border-top: none; opacity: 0.6; }
        .water-glass.filled { background: #007aff; border-color: #005bb5; opacity: 1; }
        .water-glass.next-up { opacity: 1; border-color: #007aff; box-shadow: 0 0 0 2px rgba(0,122,255,0.3); }

        /* SHOP & LISTS */
        .shop-card { background-color: var(--shop-bg); border: 1px solid var(--shop-border); border-radius: 18px; padding: 20px; text-align: left; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 122, 255, 0.06); }
        .shop-tag { background: #007aff; color: white; font-size: 0.65rem; font-weight: 700; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; display: inline-block; margin-bottom: 10px; }
        .shop-title { font-size: 1.15rem; font-weight: 800; color: var(--shop-text); margin: 0 0 10px 0; line-height: 1.3; }
        .shop-content { font-size: 0.85rem; color: #335d88; margin-bottom: 15px; line-height: 1.5; }
        .shop-highlight { background: #ffffff; padding: 12px; border-radius: 10px; margin-top: 10px; display: block; border-left: 4px solid #007aff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-size: 0.85rem; line-height: 1.5; }
        .btn-shop { background: linear-gradient(135deg, #007aff 0%, #0056b3 100%); color: white; text-decoration: none; display: block; text-align: center; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 0.95rem; margin-top: 15px; box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2); }
        
        details.shop-details summary { color: #007aff; font-size: 0.85rem; font-weight: 600; padding: 8px 0; cursor: pointer; list-style: none; text-align: left; margin-top: 5px; display: flex; align-items: center; }
        details.macros-box summary::after { content: 'üìä'; }

        /* CIBO ALLINEAMENTO */
        .food-list { list-style: none; padding: 0; margin: 0; min-height: 20px; }
        .food-item { display: grid; grid-template-columns: 1fr auto; gap: 10px; padding: 14px 0; border-bottom: 1px solid #f0f0f5; align-items: center; }
        .food-info { min-width: 0; text-align: left; display: flex; flex-direction: column; } 
        .food-name { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #333; }
        .food-details { font-size: 0.75rem; color: var(--text-sec); margin-top: 3px; }
        .food-actions { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .food-cal { font-weight: 700; font-size: 0.95rem; }
        .btn-del { color: #ff3b30; font-size: 0.75rem; margin-top: 4px; cursor: pointer; background: none; border: none; padding: 0; font-weight: 500; }
        
        .add-box { border-top: 1px solid #eee; padding-top: 24px; display: flex; flex-direction: column; gap: 10px; }
        .row { display: flex; gap: 8px; }
        .btn-main { background: #1c1c1e; color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 600; font-size: 1rem; cursor: pointer; margin-top: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-main:active { transform: scale(0.98); }

        .did-you-know { background: #fff; padding: 20px; border-radius: 16px; border: 1px solid #eee; text-align: center; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .dyk-icon { font-size: 1.5rem; display: block; margin-bottom: 10px; }
        .dyk-title { font-weight: 800; color: #007aff; font-size: 0.9rem; margin-bottom: 5px; text-transform: uppercase; }
        .dyk-text { font-size: 0.85rem; color: #555; line-height: 1.5; }

        /* MODALS & TOAST */
        /* Stile unico per tutti i popup */
/* Correzione per banner troppo alti */
.modal-overlay, #recoveryModal { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.85); z-index: 99999; 
    display: none; justify-content: center; align-items: center; 
    padding: 10px; box-sizing: border-box; backdrop-filter: blur(5px); 
}

.modal-box { 
    background: white; width: 100%; max-width: 350px; border-radius: 20px; 
    padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
    /* Queste due righe permettono lo scroll interno se il testo √® troppo lungo */
    max-height: 85vh; 
    overflow-y: auto; 
    position: relative;
    -webkit-overflow-scrolling: touch; /* Rende lo scroll fluido su iPhone */
}


        .modal-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 15px; color: #1c1c1e; }
        .modal-text { font-size: 0.9rem; color: #444; line-height: 1.5; text-align: left; margin-bottom: 20px; }
        .modal-btn { background: #007aff; color: white; border: none; width: 100%; padding: 14px; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; }
        .reward-code { background: #f0f0f5; border: 2px dashed #007aff; color: #007aff; font-size: 1.4rem; font-weight: 800; padding: 15px; border-radius: 10px; margin: 15px 0; display: block; text-align: center; }
        
        .smart-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1c1c1e; color: white; padding: 12px 20px; border-radius: 50px; font-size: 0.85rem; box-shadow: 0 10px 20px rgba(0,0,0,0.25); z-index: 10000; display: flex; align-items: center; gap: 10px; opacity: 0; transition: opacity 0.5s; pointer-events: none; width: 90%; max-width: 350px; }
        .toast-visible { opacity: 1; pointer-events: auto; }
        .toast-btn { background: white; color: #1c1c1e; border:none; padding: 6px 12px; border-radius: 20px; font-weight: 700; font-size: 0.75rem; margin-left: auto; text-decoration: none; }
        
        /* --- SCHERMATA DI BLOCCO WHATSAPP --- */
#authGate {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.98); z-index: 20000;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    padding: 20px; box-sizing: border-box; text-align: center;
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
}
.auth-box {
    max-width: 380px; width: 100%; padding: 35px 25px; border-radius: 30px;
    background: #ffffff; border: 1px solid #f0f0f5; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
}
.auth-input {
    width: 100%; height: 55px; border-radius: 15px; border: 2px solid #efeff4;
    margin-bottom: 12px; text-align: center; font-size: 1.2rem; font-weight: 800;
    letter-spacing: 1px; background: #f5f5f7; color: #1c1c1e; outline: none;
}
.auth-input:focus { border-color: #007aff; }
.btn-wa {
    background: #25D366; color: #fff; text-decoration: none; display: flex;
    align-items: center; justify-content: center; gap: 10px; padding: 18px;
    border-radius: 16px; font-weight: 700; font-size: 1.05rem; margin-bottom: 20px;
}
.btn-unlock {
    background: #007aff; color: #fff; border: none; width: 100%; padding: 18px;
    border-radius: 15px; font-weight: 700; font-size: 1rem; cursor: pointer;
}
/* Pulsante di chiusura (X) */
.close-auth {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 1.8rem;
    color: #aeaeb2;
    cursor: pointer;
    line-height: 1;
    display: none; /* Nascosto di default, lo mostriamo via JS */
}
.close-auth:hover { color: #1c1c1e; }
/* --- STILE BLOCCO E LINK RINNOVO --- */
#authGate {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.98); z-index: 20000;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    padding: 20px; box-sizing: border-box; text-align: center;
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
}
.auth-box {
    max-width: 380px; width: 100%; padding: 35px 25px; border-radius: 30px;
    background: #ffffff; border: 1px solid #f0f0f5; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
}
.close-auth {
    position: absolute; top: 15px; right: 20px; font-size: 1.8rem;
    color: #aeaeb2; cursor: pointer; line-height: 1; display: none;
}
.btn-wa {
    background: #25D366; color: #fff; text-decoration: none; display: flex;
    align-items: center; justify-content: center; gap: 10px; padding: 18px;
    border-radius: 16px; font-weight: 700; font-size: 1.05rem; margin-bottom: 20px;
}
.btn-unlock {
    background: #007aff; color: #fff; border: none; width: 100%; padding: 18px;
    border-radius: 15px; font-weight: 700; font-size: 1rem; cursor: pointer;
}

    </style>
</head>
<body>

<div id="authGate" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 99999; display: flex; align-items: center; justify-content: center; padding: 15px; box-sizing: border-box;">
    <div class="auth-box" style="position: relative; background: white; width: 100%; max-width: 380px; max-height: 85vh; border-radius: 25px; padding: 25px; overflow-y: auto; box-sizing: border-box; text-align: center; -webkit-overflow-scrolling: touch; box-shadow: 0 15px 40px rgba(0,0,0,0.4);">
        
        <span id="closeAuthBtn" class="close-auth" onclick="document.getElementById('authGate').style.display='none'" 
              style="position: sticky; top: 0; float: right; z-index: 100; background: #f0f0f0; color: #333; border-radius: 50%; width: 30px; height: 30px; text-align: center; line-height: 28px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: -30px; display: block;">&times;</span>

        <div style="text-align: center; margin-top: 10px;">
            <div style="font-size: 3.5rem; margin-bottom: 10px;">üçé</div>
            <h2 style="margin:0 0 10px 0; font-weight:800; color:#1c1c1e; font-size: 1.6rem;">Attiva Pharmocounter</h2>
            <p style="font-size:0.95rem; color:#636366; line-height:1.5; margin-bottom:25px;">
                Unisciti alla community! Inviaci la tua <b>email</b> su WhatsApp per <b>sbloccare</b> l'app gratuitamente e iscriverti alla nostra newsletter.
                <br><br>
                <span style="color:#ff9500; font-weight:700;">üöÄ VUOI LE FUNZIONI PRO?</span><br>
                Effettua un ordine su <b>pharmo.it</b>: riceverai nel pacco il codice per sbloccare il <b>Digiuno Intermittente</b>, il <b>Salvadanaio</b>, il <b>Protocollo Pro</b>, la <b>Data Obiettivo</b>, l'<b>Analisi Misure</b> e i <b>Report PRO</b>!
            </p>
            <a href="https://wa.me/393501407554?text=%F0%9F%8D%8E%20%2AATTIVAZIONE%20PHARMOCOUNTER%2A%20%F0%9F%8D%8E%0A%0ACiao%20Team%20Pharmo%21%20%F0%9F%91%8B%20Vorrei%20ricevere%20il%20codice%20di%20sblocco%20gratuito%2E%0A%0A%F0%9F%93%A7%20%2ALa%20mia%20mail%20%C3%A8%3A%2A%20%0A%0A%E2%9C%85%20Fornendo%20questo%20indirizzo%2C%20accetto%20di%20iscrivermi%20alla%20newsletter%20di%20%2Apharmo%2Eit%2A%20per%20ricevere%20consigli%20e%20promozioni%2E" 
               target="_blank" class="btn-wa">
               <i class="fab fa-whatsapp" style="font-size: 1.4rem;"></i> Richiedi Codice Gratuito
            </a>
            <input type="text" id="unlockCodeInput" placeholder="Inserisci Codice Mensile" style="width:100%; height:50px; border-radius:12px; border:1px solid #ccc; margin-bottom:10px; text-align:center; font-size:1.1rem; font-weight:800;">
            <button class="btn-unlock" onclick="verifyUnlockCode()">Sblocca Ora</button>
            <div class="vip-promo-box" style="background: #fff; padding: 18px; border-radius: 20px; border: 2px solid #ff3b30; margin-top: 15px; box-shadow: 0 4px 15px rgba(255,59,48,0.15); text-align: left;">
                <h3 style="color: #ff3b30; margin-top: 0; font-size: 1.05rem; display: flex; align-items: center; gap: 8px;">
                    <span>üíé</span> STATUS PLATINUM (VIP)
                </h3>
                <p style="font-size: 0.85rem; color: #444; line-height: 1.5; margin-bottom: 12px;">
                    Riservato ai clienti con piano di acquisto ricorrente attivo su <b>pharmo.it</b>. 
                    Sblocca il controllo totale per trasformare il tuo corpo in una macchina brucia-grassi:<br><br>
                    üíé <b>SOS SGARRO:</b> Il "tasto reset" per attivare il <b>reset insulinico</b> post-pasto libero, svuotare il glicogeno ed <b>evitare l'accumulo di nuovo grasso</b>.<br><br>
                    üíé <b>BOOST-RECOVERY:</b> Il protocollo per resettare gli ormoni quando sei stanco, senza forze o in stallo con il peso.<br><br>
                    üíé <b>INTENSIT√Ä PRO:</b> Gestione dinamica <b>Hard/Soft</b> per decidere quanto "spingere" il metabolismo in base ai tuoi obiettivi settimanali.<br><br>
                    üíé <b>FULL PASS:</b> Accesso immediato a Digiuno, Salvadanaio, Protocolli Shock e Report misure.
                </p>
                <div style="text-align: center; border-top: 1px dashed #ff3b30; padding-top: 12px; margin-top: 5px;">
                    <a href="https://www.pharmo.it" target="_blank" style="color: #ff3b30; font-weight: 800; font-size: 0.8rem; text-decoration: none; text-transform: uppercase; letter-spacing: 0.5px;">
                        üõí Ottieni il tuo Codice VIP allo Store ‚Üí
                    </a>
                </div>
            </div>
        </div> </div> </div>

<div id="smartToast" class="smart-toast"><span class="toast-icon">üí°</span><span id="toastMsg">...</span><a href="https://www.pharmo.it" target="_blank" class="toast-btn">Vedi</a></div>

<div id="disclaimerModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title" style="color:#d32f2f;">‚ö†Ô∏è Disclaimer Legale & Privacy</div>
        <div class="modal-text" style="font-size: 0.8rem; line-height: 1.4; text-align: justify;">
            Benvenuto su <b>Pharmocounter</b>.<br><br>
            
            <b>1. ESCLUSIONE DI RESPONSABILIT√Ä MEDICA</b><br>
            Questa applicazione fornisce stime basate su formule matematiche standard a puro scopo informativo e ludico. <b>NON sostituisce in alcun modo il parere di un medico, biologo nutrizionista o dietista.</b><br>
            Prima di intraprendere qualsiasi regime alimentare o attivit√† fisica, consultare obbligatoriamente uno specialista.
            <br><br>
            <b>2. LIMITAZIONE DI RESPONSABILIT√Ä & DATI</b><br>
            <b>Pharmo.it</b> e l'azienda gestore declinano ogni responsabilit√† per danni derivanti dall'uso improprio dei dati.<br>
            Inoltre, <b>l'azienda non si assume alcuna responsabilit√† per l'eventuale perdita di dati</b> causata da bug del sistema, aggiornamenti software, malfunzionamenti tecnici, cancellazione della cache o cambio del dispositivo. L'utente riconosce che i dati non sono salvati in cloud ma risiedono esclusivamente nel proprio terminale.
            <br><br>
            <b>3. PRIVACY (GDPR)</b><br>
            A tutela della tua privacy, questa applicazione funziona <b>esclusivamente in locale</b>. I dati inseriti restano nella memoria del tuo dispositivo e <b>NON vengono mai trasmessi, raccolti o visualizzati da server esterni</b>.
            <br><br>
            <i>Cliccando su "Accetto", dichiari di aver letto, compreso e approvato integralmente queste condizioni.</i>
        </div>
        <button class="modal-btn" onclick="acceptTerms()">Ho Letto, Compreso e Accetto</button>
    </div>
</div>

        <div id="recoveryModal" class="modal-overlay">
    <div class="modal-box" style="border: 2px solid #FFD700; max-height: 80vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
        <h2 style="color:#007aff; margin-top:0; font-weight:800;">üíé RECOVERY PLATINUM</h2>
        <p style="text-align:center; font-weight:700; color:#b8860b; margin-bottom:10px;">üìâ Ti senti stanco, senza forze o in stallo con il peso?</p>
        <p style="font-size:0.85rem; color:#666; font-style:italic; margin-bottom:20px;">Protocollo di Reset Metabolico</p>

        <div style="text-align:left; font-size:0.9rem; line-height:1.5; color:#333;">
            <ul style="list-style:none; padding:0; font-size:0.9em;">
                <li style="margin-bottom:12px;">üìâ <strong>Cortisolo Control:</strong> Lo stress da dieta blocca il dimagrimento, specialmente sulla pancia. Alzando strategicamente le calorie, diciamo al corpo che pu√≤ finalmente rilassarsi e tornare a bruciare grasso.</li>
                <li style="margin-bottom:12px;">üöÄ <strong>Leptina Boost:</strong> Quando mangi poco per troppo tempo, il corpo va in "risparmio energetico" e senti sempre fame. Questo reset riaccende la tua fornace interna e spegne la fame nervosa.</li>
                <li style="margin-bottom:12px;">üîÑ <strong>T3 Optimization:</strong> Serve a riattivare il metabolismo lento, dando nuova energia al tuo corpo per evitare quegli stalli in cui il peso non scende pi√π nonostante i sacrifici.</li>
                <p style="color:#b8860b; font-weight:bold; margin-top:20px; border-bottom:1px solid #eee;">üçù L'EFFETTO SUI TUOI MACRO:</p>
<p style="font-size:0.9em; line-height:1.4;">
    Non √® cibo in pi√π a caso. √à un <strong>Refeed Tecnico</strong>: alziamo i <strong>Carboidrati al 55%</strong> della tua quota giornaliera per riempire le scorte di glicogeno muscolare e dare nuova linfa al sistema nervoso centrale.
</p>
            </ul>
            
            <div style="background:#fff9e6; border:1px dashed #ffd700; padding:15px; border-radius:12px; margin-top:20px;">
                <p style="color:#d97706; font-weight:bold; margin-top:0; font-size:0.9em;">‚ö†Ô∏è VINCOLI DEL PROTOCOLLO ELITE</p>
                <p style="font-size:0.85em; margin-bottom:5px;">La gestione ormonale richiede precisione. Per massimizzare l'effetto "Reset" senza accumulare grasso:</p>
                <ul style="font-size:0.85em; margin:0; padding-left:20px;">
                    <li><strong>Freeze Strategico:</strong> Il Salvadanaio Calorie verr√† congelato per <strong>7 giorni</strong>. Il corpo deve concentrarsi sull'energia che gli stiamo dando ora.</li>
                    <li><strong>Accesso Platinum:</strong> Funzione riservata a chi ha dimostrato costanza (Serie 7+). Utilizzabile 1 volta ogni 10 giorni. Sbloccabile con gli acquisti ricorrenti su pharmo.it.</li>
                </ul>
            </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:10px; margin-top:25px;">
            <button onclick="confirmRecovery()" style="background:linear-gradient(135deg, #007aff, #0056b3); color:white; border:none; padding:15px; border-radius:12px; font-weight:bold; cursor:pointer; font-size:1rem;">üß¨ ATTIVA RESET</button>
            <button onclick="closeRecoveryModal()" style="background:transparent; color:#888; border:none; cursor:pointer; text-decoration:underline; font-size:0.85rem;">üõ°Ô∏è RESTA IN DEFICIT</button>
        </div>
    </div>
</div>



<div id="rewardModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title" id="rewardTitle">üéâ Complimenti!</div>
        <div class="modal-text" style="text-align:center;">
            <span id="rewardMsg">Nuovo livello!</span><br><br>Premio per <b>Pharmo.it</b>:
            <span class="reward-code" onclick="copyCode(this)" id="rewardCodeDisplay">...</span>
            <small style="color:#888;">Clicca per copiare</small>
        </div>
        <button class="modal-btn" onclick="closeReward('rewardModal')">Riscatta Ora</button>
    </div>
</div>

<div id="waterRewardModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title">üíß Campione di Idratazione!</div>
        <div class="modal-text" style="text-align:center;">
            Hai bevuto correttamente per <b>3 giorni</b>!<br><br>Ecco un premio per i drenanti:
            <span class="reward-code" onclick="copyCode(this)">PHARMOSPED</span>
            <small style="color:#888;">Clicca per copiare</small><br>
            <b style="color:var(--accent); margin-top:10px; display:block;">Usalo subito su pharmo.it per i tuoi prodotti preferiti!</b>
        </div>
        <button class="modal-btn" onclick="closeReward('waterRewardModal')">Riscatta Ora</button>
    </div>
</div>

<div class="app-container">
    <div class="header-area">
        <span class="date-badge" id="dateText">...</span>
        <h1>Pharmocounter</h1>
        <span class="subtitle-brand">by pharmo.it</span>
        <div class="streak-badge" id="streakDisplay" onclick="showStreakInfo()">üî• 1/7</div>
    </div>

    <details class="card" id="profileDetails">
        <summary>Il tuo Profilo</summary>
        <div class="settings-grid">
            <div><label>Sesso</label><select id="gender" onchange="calc()"><option value="m">Uomo</option><option value="f">Donna</option></select></div>
            <div><label>Et√†</label><input type="number" id="age" value="30" onchange="calc()"></div>
            <div><label>Peso Attuale (kg)</label><input type="number" id="weight" value="75" onchange="calc()"></div>
            <div><label>Altezza (cm)</label><input type="number" id="height" value="175" onchange="calc()"></div>
            
            <div style="grid-column: 1 / -1;"><label>Livello Attivit√† Fisica</label>
                <select id="act" onchange="calc()">
                    <option value="1.2">Sedentario (Ufficio, no sport)</option>
                    <option value="1.375">Leggero (Sport 1-3 gg/sett)</option>
                    <option value="1.55">Moderato (Sport 3-5 gg/sett)</option>
                    <option value="1.725">Attivo (Sport 6-7 gg/sett)</option>
                </select>
            </div>
            <div style="grid-column: 1 / -1;"><label>Obiettivo Attuale</label>
                <select id="goal" onchange="calc()">
                    <option value="lose_aggr">üìâ Perdita Peso Standard (-20%)</option>
                    <option value="lose_athlete_15">‚úÇÔ∏è Atleta / Cut Aggressivo (-15%)</option>
                    <option value="lose_cons">üõ°Ô∏è Atleta / Cut Conservativo (-10%)</option>
                    <option value="detox">üíß Detox & Sgonfiamento (-5%)</option>
                    <option value="beauty">‚ú® Beauty & Anti-Age (Mantenimento)</option>
                    <option value="recomp">üí™ Ricomposizione Corporea (High Prot)</option>
                    <option value="maintain" selected>‚öñÔ∏è Mantenimento</option>
                    <option value="gain">üìà Aumento Muscolare (+10%)</option>
                </select>
            </div>
<div id="premiumProtocolArea" style="margin: 20px auto; padding: 18px; background: #fffdf0; border: 1px solid #ffeebb; border-radius: 20px; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; text-align: center; max-width: 380px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
    
    <div id="premiumLockOverlay" onclick="showPremiumAd()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,252,240,0.92); z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(2px);">
        <span style="font-size: 1.4rem; margin-bottom: 4px;">üîí</span>
        <span style="color: #e67e22; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px;">Sblocca Metodo Shock PRO</span>
    </div>

    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
        <span id="goldBadge" style="background: #ccc; color: white; font-size: 0.6rem; font-weight: 900; padding: 3px 10px; border-radius: 50px; text-transform: uppercase;">Status Base</span>
    </div>
    
    <label style="color:#e67e22; font-weight:800; font-size:0.8rem; display:block; margin-bottom:10px; text-align: center;">PROTOCOLLO METABOLICO PRO</label>

    <select id="advProtocol" onchange="updateProtocolDesc()" style="width: 100%; border: 1px solid #ccc; font-weight: 700; border-radius: 12px; padding: 10px; color: #999; background: white; appearance: none; -webkit-appearance: none; text-align: center; text-align-last: center;">
        <option value="none">‚ú® Nessuno (Standard)</option>
        <option value="shock">üëë üåä Metodo Shock Metabolico</option>
    </select>

    <div id="protocolDesc" style="margin: 15px auto 0 auto; font-size: 0.8rem; color: #5d4037; line-height: 1.5; text-align: center !important; width: 90%; max-width: 300px;">
    Seleziona il protocollo per attivare il calcolo automatico dei macro.
</div>
<div id="intensityArea" style="margin-top: 15px; border-top: 1px dashed #ffeebb; padding-top: 15px; width: 100%;">
    <span style="font-size: 0.65rem; font-weight: 800; color: #e67e22; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">üöÄ Intensit√† Protocollo (Livello VIP)</span>
    <div style="display: flex; justify-content: space-between; gap: 5px;">
        <button id="btnSoft" onclick="setIntensity('soft')" style="flex: 1; padding: 8px 2px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 0.7rem; font-weight: 700; color: #aaa;">üü¢ SOFT</button>
        <button id="btnStandard" onclick="setIntensity('standard')" style="flex: 1; padding: 8px 2px; border-radius: 10px; border: 1px solid #007aff; background: #007aff; cursor: pointer; font-size: 0.7rem; font-weight: 700; color: #fff;">üü° STANDARD</button>
        <button id="btnHard" onclick="setIntensity('hard')" style="flex: 1; padding: 8px 2px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 0.7rem; font-weight: 700; color: #aaa;">üî¥ HARD</button>
    </div>
    <div id="vipLockText" onclick="showVipAd()" style="margin-top: 8px; font-size: 0.65rem; color: #e67e22; font-weight: 700; cursor: pointer; text-decoration: underline;">
        üîí Sblocca Intensit√† (Solo Clienti Ricorrenti)
    </div>
</div>
</div> 

<details class="card" style="grid-column: 1 / -1; margin-top: 10px; padding: 15px; background: #f0f4f8; border: 1px solid #dbeafe;">
    <summary style="font-size: 0.9rem; color: #004494; font-weight: 700;">üéØ Obiettivi & Misure <span style="font-weight:400; opacity:0.7;">(Opzionali)</span></summary>
    
    <div class="settings-grid" style="margin-top: 15px; align-items: end; grid-gap: 15px;">
        
        <div style="grid-column: 1 / -1; border-bottom: 1px solid #cceeff; padding-bottom: 5px; margin-bottom: -5px;">
            <span style="font-size:0.75rem; font-weight:700; color:#004494; text-transform:uppercase;">Il tuo Traguardo</span>
        </div>
        
        <div>
            <label>Peso Obiettivo (kg)</label>
            <input type="number" id="targetWeightInput" placeholder="es. 65" onchange="calc()" style="height: 42px;">
        </div>
        
        <div>
            <label>Data Obiettivo</label>
            <input type="date" id="targetDateInput" onchange="calc()" style="height: 42px;">
        </div>

        <div id="idealWeightSuggestion" style="grid-column: 1 / -1; margin-top: -5px; margin-bottom: 5px; text-align: center; font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; display: none; width: fit-content; justify-self: center;">
            </div>

        <div style="grid-column: 1 / -1; border-bottom: 1px solid #cceeff; padding-bottom: 5px; margin-bottom: -5px; margin-top: 5px;">
            <span style="font-size:0.75rem; font-weight:700; color:#004494; text-transform:uppercase;">Analisi Corporea (cm)</span>
        </div>
        
        <div>
            <label>Addome (Ombelico)</label>
            <input type="number" id="circ_abd" placeholder="cm" onchange="calc()" style="height: 42px;">
        </div>
        
        <div>
            <label>Coscia (Alta)</label>
            <input type="number" id="circ_coscia" placeholder="cm" onchange="calc()" style="height: 42px;">
        </div>
        
        <div id="braccio_input_wrapper" style="grid-column: 1 / -1;">
            <label>Braccio (Bicipite)</label>
            <input type="number" id="circ_braccio" placeholder="cm" onchange="calc()" style="height: 42px;">
        </div>
        
        <div class="info-box" id="circAnalysis" style="grid-column: 1 / -1; margin-top: 5px; background: white; border-color: #cceeff; color: #004494;">Compila per analisi settimanale.</div>
    </div>
    <div style="grid-column: 1 / -1; margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px;">
    <button onclick="openBackupUI()" style="width:100%; background-color:#f8f9fa; color:#007aff; border:1px solid #007aff; padding:10px; border-radius:12px; font-weight:700; font-size:0.85rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
        ‚òÅÔ∏è Backup Dati & Transfer (PRO)
    </button>
</div>

</details>
<div style="grid-column: 1 / -1; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
    <label style="color:#007aff; font-weight:700; margin-bottom: 8px; display:block;">‚è±Ô∏è Digiuno Intermittente (Opzionale)</label>
    
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
        
        <select id="fastingMode" onchange="updateFastingUI()" 
            style="width:100%; height:50px; border:1px solid #d1d1d6; border-radius:12px; background:#f9f9fb; font-size:0.95rem; padding: 0 10px; margin:0; box-sizing: border-box;">
            <option value="none">Nessuno (Libero)</option>
            <option value="16">16:8 (Classico)</option>
            <option value="20">20:4 (Warrior)</option>
            <option value="23">OMAD (Un pasto)</option>
        </select>
        
        <input type="time" id="fastingStart" value="13:00" onchange="updateFastingUI()" 
            style="width:100%; height:50px; border:1px solid #d1d1d6; border-radius:12px; background:#f9f9fb; font-size:1.1rem; text-align:center; padding:0; margin:0; box-sizing: border-box;">
    </div>

    <div id="fastingSmallStatus" style="margin-top:10px; font-size:0.75rem; font-weight:700; text-align:center; padding:8px; border-radius:6px; display:none;">
    </div>
</div>

            <div class="info-box" id="scientificData">Calcolo in corso...</div>
        </div>
    </details>

               <div>
        <div class="dash-header">
            <div class="big-val" id="remCal">0</div>
            <div class="sub-val">Kcal Rimanenti (Target: <span id="targetDisplay">0</span>)</div>
        </div>
<div style="text-align:center; margin-top: 10px; margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; gap: 15px;">
    
    <button onclick="useBankCalories()" 
    style="background: rgba(255, 149, 0, 0.05); border: 1px solid rgba(255, 149, 0, 0.4); color: #ff9500; padding: 5px 15px; border-radius: 12px; font-size: 0.65rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 4px;">
    <span id="bankLockIcon">üîí</span> SALVADANAIO: <span id="bankDisplay">0</span> kcal
</button>

        <button id="bioRecoveryBtn" class="btn-recovery-active" onclick="openRecoveryModal()">
        <span id="recoveryLock">üîí</span> BOOST-RECOVERY
    </button>
<button onclick="openCrono()" 
            style="background: rgba(0, 212, 255, 0.05); border: 1px solid rgba(0, 212, 255, 0.4); color: #007aff; padding: 5px 15px; border-radius: 12px; font-size: 0.65rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 4px;">
        <span id="cronoLockIcon">üß¨</span> BIO-TIMING
    </button>

    </div>

        <div style="position: relative; margin-top: 30px;">
            <div id="bmrMarker" class="bmr-line"></div>
            <div id="bmrTag" class="bmr-tag">Basale</div>
            <div class="track" style="height: 26px; border-radius: 13px;">
                <div class="fill" id="calBar" style="border-radius: 13px;"></div>
            </div>
        </div>

        <div class="status-text" id="statusText" style="margin-top: 10px; margin-bottom: 15px;">...</div>

        <div id="proteinDashboardArea" style="margin-top: 10px; display: none; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px;">
                <span style="color: #666;">Muscoli (Min: <span id="protMinLabel">0</span>g)</span>
                <span id="protDashboardTxt" style="color: #ff9500;">0g / 0g</span>
            </div>
            <div style="position: relative;">
                <div id="protMinMarker" style="position: absolute; top: 0; bottom: 0; width: 2px; background: #003a80; z-index: 5; border-right: 1px dashed rgba(255,255,255,0.6);"></div>
                <div class="track" style="height: 8px; border-radius: 4px; background: #e5e5ea;">
                    <div class="fill" id="protDashboardBar" style="height: 100%; width: 0%; border-radius: 4px; transition: all 0.5s ease;"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="fastingStatusBox" style="display:none; margin-top:20px; padding:15px; border-radius:16px; text-align:center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: all 0.3s ease;">
    </div>
    
    <div class="cumulative-box" style="background: #f4f9ff; border: 1px solid #dbeafe; padding: 20px; border-radius: 18px; text-align: center;">
    <div style="font-size: 0.8rem; font-weight: 700; color: #004494; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">
        üìÖ Data Stimata Traguardo
    </div>
<div id="projectedDateDisplay" onclick="showDataLockPopup()" style="font-size: 1.8rem; font-weight: 800; color: #007aff; margin-bottom: 5px; cursor: pointer;">
        üîí PRO
    </div>
    <div class="pred-status" id="predictionStatus" style="font-size: 0.85rem; font-weight: 500; margin-top: 10px; padding: 10px; border-radius: 10px; background: white; border: 1px solid #eee;">
        Sblocca la <b>Data Traguardo</b> con la versione PRO su pharmo.it
    </div>
</div>

        
    <div style="text-align: center; margin-top: 15px;">
        <span style="font-size: 0.9rem; color: var(--text-sec); font-weight: 600;">PRECISIONE GIORNALIERA:</span>
        <div id="bullseyeBadge" class="precision-card card-default" onclick="showPrecisionInfo()">Inizia a loggare</div>
    </div>
    
    <div style="text-align: center; margin-top: 5px; padding: 5px 0; margin-bottom: 10px;"> <span style="font-size: 0.9rem; color: #007aff; font-weight: 700;">SERIE PLATINO:</span>
        <span id="platinumStreakDisplay" style="font-size: 1.1rem; color: var(--success); font-weight: 800; margin-left: 5px;">0 giorni</span>
    </div>

    <div class="shop-card" id="shopCard">
        <span class="shop-tag">Protocollo Consigliato</span>
        <h3 class="shop-title" id="shopTitle">...</h3>
        <div class="shop-content" id="shopDesc">...</div>
        <a href="https://www.pharmo.it" target="_blank" class="btn-shop">Acquista su Pharmo.it ‚Üí</a>
    </div>

    <div class="water-box">
        <div class="water-title"><span>Idratazione & Detox</span><span id="waterCountDisplay">0/8</span></div>
        <div class="water-grid" id="waterGrid"></div>
        <div id="waterStatus" style="font-size:0.75rem; color:var(--accent); font-weight:600; margin-top:8px; text-align:center;">Sfida Drenante: Giorno 1/3</div>
    </div>

    <details class="card macros-box">
        <summary>Dettaglio Nutrienti</summary>
        <button onclick="openCoach()" 
            style="background: rgba(90, 103, 216, 0.08); border: 1px solid rgba(90, 103, 216, 0.3); color: #5a67d8; padding: 5px 14px; border-radius: 12px; font-size: 0.65rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 4px;">
        <span id="coachLockIcon">üß†</span> ANALISI COACH AI
    </button>
        <div class="macro-grid">
            <div class="macro-item"><div class="bar-label"><span>Carboidrati</span><span id="carbTxt" style="color:var(--carb-color)">0 / 0g</span></div><div class="track"><div class="fill" id="carbBar" style="background:var(--carb-color)"></div></div></div>
            <div class="macro-item"><div class="bar-label"><span>Proteine</span><span id="protTxt" style="color:var(--prot-color)">0 / 0g</span></div><div class="track"><div class="fill" id="protBar" style="background:var(--prot-color)"></div></div></div>
            <div class="macro-item"><div class="bar-label"><span>Grassi</span><span id="fatTxt" style="color:var(--fat-color)">0 / 0g</span></div><div class="track"><div class="fill" id="fatBar" style="background:var(--fat-color)"></div></div></div>
        </div>
        <div id="protAlert" style="margin-top: 15px;"></div> </details>

     <div class="add-box">
        <div style="background:#f0f4f8; padding:10px; border-radius:12px; margin-bottom:10px; border:1px solid #dbeafe;">
            <label style="margin-bottom:5px; color:#004494; font-weight:700;">üìÇ I tuoi Cibi Salvati</label>
            <div class="row">
                <select id="favSelect" onchange="loadFav()" style="flex:1; font-weight:600; color:#004494;">
                    <option value="">-- Scegli o Crea Nuovo --</option>
                </select>
                <button onclick="deleteFav()" style="background:#ff3b30; color:white; border:none; padding:0 12px; border-radius:10px; font-weight:700;">X</button>
            </div>
        </div>
        <div class="row">
            <input type="text" id="inName" placeholder="Nome Cibo (es. Pollo)" style="flex:2; font-weight:600;">
        </div>
        
        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#888; margin-top:5px; padding:0 5px;">
            <span>Kcal (su 100g)</span><span>Carb</span><span>Prot</span><span>Gras</span>
        </div>
        <div class="row small-inputs">
            <input type="number" id="inCal100" placeholder="Kcal" style="border-color:#ccc;">
            <input type="number" id="inCarb100" placeholder="C">
            <input type="number" id="inProt100" placeholder="P">
            <input type="number" id="inFat100" placeholder="G">
        </div>
<div id="sugarContainer" style="margin-top: 15px; background: #fdfdfd; padding: 10px; border-radius: 12px; border: 1px solid #eee;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
        <span id="sugarLabel" style="font-size: 0.75rem; font-weight: 700; color: #555;">üç¨ DI CUI ZUCCHERI (g)</span>
        <span id="sugarBadge" style="font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 800;">üîí BLOCCATO</span>
    </div>
    
    <div id="sugarInputWrapper" style="position: relative;">
        <input type="number" id="inSugar" placeholder="0" 
               onclick="handleSugarClick()" 
               style="width: 100%; height: 40px; border-radius: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; transition: 0.3s;">
    </div>
</div>

        <div class="row" style="align-items: center; margin-top:10px; background:#fafafa; padding:8px; border-radius:10px; border:1px solid #eee;">
            <span style="font-size:0.85rem; font-weight:700; color:#333;">‚öñÔ∏è Quantit√† che mangi:</span>
            <input type="number" id="inGrams" placeholder="g" value="100" style="width:80px; text-align:center; font-weight:700; color:#007aff; font-size:1.1rem;">
            <span style="font-size:0.85rem; color:#666;">grammi</span>
        </div>

        <div class="row" style="margin-top:10px; gap:10px;">
            <button class="btn-main" onclick="saveFav()" style="background:#fff; border:2px solid #007aff; color:#007aff; flex:1; padding:10px; font-size:0.8rem;">üíæ Salva Cibo<br>& Grammi</button>
            <button class="btn-main" onclick="addCalculated()" style="flex:2; margin-top:0; background:linear-gradient(135deg, #1c1c1e 0%, #3a3a3c 100%);">‚ûï Aggiungi al Diario</button>
        </div>
        <div id="vipAdviceBox" style="display:none; margin-top:15px;"></div>
<button id="sosBtn" onclick="activateSOS()" style="display:block; background: linear-gradient(135deg, #ff3b30 0%, #b30000 100%); color: white; border: none; padding: 12px; border-radius: 14px; font-weight: 800; font-size: 0.8rem; margin-top: 15px; width: 100%; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3); cursor: pointer;">
    <span id="sosLockIcon">üîí</span> ‚ö° SOS SGARRO (Protocollo VIP)
</button>

<button id="sosActiveLabel" onclick="deactivateSOS()" style="display:none; background: #fff; color: #ff3b30; border: 2px solid #ff3b30; padding: 10px; border-radius: 14px; font-weight: 800; font-size: 0.8rem; margin-top: 10px; width: 100%; cursor: pointer;">‚úÖ PROTOCOLLO SOS ATTIVO (Clicca per annullare)</button>
    </div>

<ul id="list" class="food-list"></ul>

<div style="text-align:center; margin-top:20px; padding-bottom:30px; display:flex; flex-direction:column; align-items:center; gap:8px;">
    
    <span id="renewalLinkText" onclick="document.getElementById('authGate').style.display='flex'; document.getElementById('closeAuthBtn').style.display='block';" 
          style="font-size:0.75rem; color:#007aff; cursor:pointer; text-decoration:underline; font-weight:700;">
        Caricamento stato accesso...
    </span>

    <span style="font-size:0.7rem; color:#aaa; cursor:pointer; text-decoration:underline;" onclick="document.getElementById('disclaimerModal').style.display='flex'">
        Disclaimer e Privacy (Accettato)
    </span>

    <div style="margin-top:5px; display:flex; flex-direction:column; gap:4px;">
        <a href="mailto:shop@pharmo.it" style="font-size:0.8rem; font-weight:600; color:#007aff; text-decoration:none;">
            üìß shop@pharmo.it
        </a>
        <a href="https://wa.me/393501407554" target="_blank" style="font-size:0.8rem; font-weight:600; color:#25D366; text-decoration:none;">
            <i class="fab fa-whatsapp"></i> +39 350 140 7554
        </a>
    </div>
</div>


<script>
// Apre il modal con i controlli Platinum
function openRecoveryModal() {
    const isVip = localStorage.getItem('app_vip_v1') === 'true';
    const streak = parseInt(localStorage.getItem('streak_days')) || 0;
    
    // 1. SE NON √à VIP: Appare l'alert con i tuoi testi esatti
    if (!isVip) {
        alert(
            "üíé IL RECOVERY √à RISERVATO AI CLIENTI VIP.\n" +
            "Sbloccalo con il codice che ottieni con un piano di acquisto ricorrente attivo su pharmo.it\n\n" +
            "Per attivarlo, contatta l'assistenza e ricevi il codice di attivazione VIP!\n\n" +
            "üîí NOTA: √à richiesta anche una serie di almeno 7 giorni per l'attivazione (Attuale: " + streak + ")"
        );
        // Apriamo comunque il banner per fargli leggere i benefici
        document.getElementById('recoveryModal').style.display = 'flex';
        return;
    }

    // 2. SE √à VIP MA NON HA 7 GIORNI: Niente alert subito, apriamo il banner (il blocco sar√† al click su "Attiva")
    if (isVip && streak < 7) {
        // Nessun alert qui, lasciamo che legga il banner e venga bloccato dopo dal confirmRecovery
    }

    // 3. CONTROLLO RICARICA (10 GIORNI)
    const ultimoRecovery = parseInt(localStorage.getItem('last_recovery_timestamp')) || 0;
    const giorniPassati = (Date.now() - ultimoRecovery) / (1000 * 60 * 60 * 24);
    
    if (giorniPassati < 10) {
        alert("‚ö†Ô∏è Protocollo in ricarica. Disponibile tra " + Math.ceil(10 - giorniPassati) + " giorni.");
        return; 
    }

    document.getElementById('recoveryModal').style.display = 'flex';
}

function closeRecoveryModal() {
    document.getElementById('recoveryModal').style.display = 'none';
}

function confirmRecovery() {
    const isVip = localStorage.getItem('app_vip_v1') === 'true';
    const streak = parseInt(localStorage.getItem('streak_days')) || 0;

    // Controllo specifico per l'utente (Non-VIP)
    if (!isVip) {
        alert("üíé Il Recovery √® riservato ai clienti VIP.\nSbloccalo con il codice che ottieni con gli acquisti ricorrenti su pharmo.it");
        return;
    }

    // Controllo specifico per il VIP senza serie (Il tuo caso)
    if (streak < 7) {
        alert("üîí REQUISITO SERIE NON RAGGIUNTO\n\nIl protocollo Boost-Recovery richiede una costanza di almeno 7 giorni (Serie 7+) per garantire l'efficacia del reset ormonale.\n\nAttuale: " + streak + " giorni.");
        return;
    }

    // Controllo 10 giorni
    const ultimoRecovery = parseInt(localStorage.getItem('last_recovery_timestamp')) || 0;
    const giorniPassati = (Date.now() - ultimoRecovery) / (1000 * 60 * 60 * 24);
    if (giorniPassati < 10) {
        alert("‚ö†Ô∏è Protocollo in ricarica. Disponibile tra " + Math.ceil(10 - giorniPassati) + " giorni.");
        return;
    }

    // Attivazione
    localStorage.setItem('recovery_active_today', 'true');
    localStorage.setItem('last_recovery_timestamp', Date.now());
    localStorage.setItem('salvadanaio_blocked_until', Date.now() + (7 * 24 * 60 * 60 * 1000));
    
    alert("üß¨ Reset Ormonale Attivato. La tua fornace metabolica si sta riaccendendo!");
    location.reload();
}

// Funzione da aggiungere alla logica del tuo tasto Salvadanaio esistente
function checkSalvadanaioLock() {
    const lockUntil = parseInt(localStorage.getItem('salvadanaio_blocked_until')) || 0;
    if (Date.now() < lockUntil) {
        const giorni = Math.ceil((lockUntil - Date.now()) / (1000 * 60 * 60 * 24));
        alert("üö´ Salvadanaio in Deep Freeze. Disponibile tra " + giorni + " giorni (Post Bio-Recovery).");
        return false; // Blocca l'esecuzione
    }
    return true; // Prosegue
}

function applySOSLogic(c, p, f) {
    const isSos = localStorage.getItem('sos_mode_active') === 'true';
    if (!isSos) return { c, p, f };

    const startTime = localStorage.getItem('sos_start_time');
    // Se sono passate 24 ore, disattiva da solo
    if (Date.now() - startTime > 86400000) {
        localStorage.setItem('sos_mode_active', 'false');
        return { c, p, f };
    }

    // PROTOCOLLO DI EMERGENZA:
    // Carbo: -70% (svuotamento glicogeno)
    // Grassi: -50% (riduzione lipidica)
    // Proteine: +10% (protezione muscolare)
    return {
        c: Math.round(c * 0.3),
        p: Math.round(p * 1.1),
        f: Math.round(f * 0.5)
    };
}

function activateSOS() {
    const isVip = localStorage.getItem('app_vip_v1') === 'true';

    // SE NON √à VIP -> PUBBLICIT√Ä
    if (!isVip) {
    alert(
        "‚ö° IL TUO 'TASTO RESET' √à BLOCCATO\n\n" +
        "Hai esagerato a tavola? Non rovinare i progressi di una settimana!\n\n" +
        "Il Protocollo SOS Sgarro √® il sistema d'emergenza esclusivo dei Membri Platinum che:\n\n" +
        "1. üõ°Ô∏è SCHERMA i grassi in eccesso prima che si depositino.\n" +
        "2. üîÑ RE-SETTA l'insulina rimodulando i macro per compensare l'eccesso.\n" +
        "3. üöÄ ACCELERA lo svuotamento del glicogeno per tornare subito 'flat'.\n\n" +
        "Sblocca questa funzione con il tuo Codice VIP e trasforma ogni sgarro in una ricarica metabolica controllata!"
    );
    return;
}

    // SE √à VIP -> PROCEDI CON L'ATTIVAZIONE
    if(confirm("‚ö†Ô∏è ATTIVARE DAMAGE CONTROL?\n\nVuoi attivare il protocollo di emergenza per le prossime 24 ore?")) {
        localStorage.setItem('sos_mode_active', 'true');
        localStorage.setItem('sos_start_time', Date.now());
        showToast("üöÄ Protocollo SOS Attivo!");
        renderSOS();
        calc();
    }
}


function deactivateSOS() {
    if(confirm("Vuoi interrompere il protocollo SOS e tornare ai calcoli standard?")) {
        localStorage.setItem('sos_mode_active', 'false');
        renderSOS();
        calc();
    }
}

function renderSOS() {
    const isSos = localStorage.getItem('sos_mode_active') === 'true';
    const isVip = localStorage.getItem('app_vip_v1') === 'true';
    
    const btn = document.getElementById('sosBtn');
    const label = document.getElementById('sosActiveLabel');
    const advice = document.getElementById('vipAdviceBox');
    const lockIcon = document.getElementById('sosLockIcon');

    if (!btn || !label || !advice) return;

    if (isSos) {
        // STATO: SOS ATTIVO (Sia VIP che non, se √® attivo deve mostrare il countdown/consigli)
        btn.style.display = 'none';
        label.style.display = 'block';
        advice.style.display = 'block';
        advice.innerHTML = `
    <div style="background: linear-gradient(135deg, #fff5f5 0%, #fff0f0 100%); border: 2px solid #ff3b30; padding: 18px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(255,59,48,0.1);">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <span style="font-size:1.3rem;">üÜò</span>
            <b style="color:#ff3b30; font-size:1rem; text-transform:uppercase; letter-spacing:0.5px;">Recupero in Corso</b>
        </div>
        <p style="font-size:0.85rem; color:#444; line-height:1.5; margin:0;">
            Le tue riserve di glicogeno sono sature. Abbiamo <b>rimodulato i tuoi obiettivi</b> per le prossime 24 ore: il corpo attinger√† energia prioritariamente dall'eccesso di ieri.<br><br>
            
            <b style="color:#ff3b30; font-size:0.85rem; text-transform:uppercase;">üîç Consigli Tecnici:</b><br>
            ‚Ä¢ üíß <b>BILANCIAMENTO IDRICO:</b> 1.5L d'acqua + <b>Pharmodren</b> per prosciugare la ritenzione dello sgarro.<br>
            ‚Ä¢ üõ°Ô∏è <b>OTTIMIZZAZIONE:</b> Assumi <b>Pharmofit</b> prima dei pasti: spinge il corpo a ossidare i grassi anzich√© gli zuccheri.<br>
            ‚Ä¢ üå¨Ô∏è <b>PANCIA PIATTA:</b> <b>Pharmolain</b> subito per supportare la digestione e ridurre il gonfiore fermentativo.
        </p>
    </div>
`;
    } else {
        // STATO: SOS NON ATTIVO (Mostriamo il tasto a tutti)
        btn.style.display = 'block';
        label.style.display = 'none';
        advice.style.display = 'none';

        if (isVip) {
            // VIP: Tasto normale e senza lucchetto
            btn.style.opacity = '1';
            if(lockIcon) lockIcon.style.display = 'none';
        } else {
            // NON VIP: Tasto leggermente trasparente e con lucchetto
            btn.style.opacity = '0.7';
            if(lockIcon) lockIcon.style.display = 'inline';
        }
    }
}


// Funzione per mostrare pubblicit√† VIP
function showVipAd() {
    alert("üíé LIVELLO PLATINUM / VIP\n\nIl selettore d'intensit√† √® riservato ai clienti che hanno un piano di acquisto ricorrente attivo su Pharmo.it.\n\n Per attivarlo, contatta l‚Äôassistenza e ricevi il codice di attivazione VIP!");
}

// Funzione per cambiare intensit√† (solo se autorizzato)
function setIntensity(lvl) {
    const isVip = localStorage.getItem('app_vip_v1') === 'true';
    if (!isVip && lvl !== 'standard') {
        showVipAd();
        return;
    }
    localStorage.setItem('intensity_v1', lvl);
    updateIntensityUI();
    calc(); // Ricalcola tutto con la nuova potenza
}

// Aggiorna l'aspetto dei bottoni
function updateIntensityUI() {
    const lvl = localStorage.getItem('intensity_v1') || 'standard';
    const isVip = localStorage.getItem('app_vip_v1') === 'true';
    
    // Reset stili
    ['btnSoft', 'btnStandard', 'btnHard'].forEach(id => {
        const btn = document.getElementById(id);
        btn.style.background = "#fff";
        btn.style.color = "#aaa";
        btn.style.borderColor = "#ddd";
    });

    // Attiva quello scelto
    const activeBtn = document.getElementById('btn' + lvl.charAt(0).toUpperCase() + lvl.slice(1));
    activeBtn.style.background = (lvl === 'soft') ? "#34c759" : (lvl === 'hard' ? "#ff3b30" : "#007aff");
    activeBtn.style.color = "#fff";
    activeBtn.style.borderColor = activeBtn.style.background;

    // Nascondi link sblocco se gi√† VIP
    if(isVip) document.getElementById('vipLockText').style.display = 'none';
}

function showPremiumAd() {
    alert(
        "üöÄ POTENZIA IL TUO METABOLISMO\n\n" +
        "I Protocolli Avanzati (Carb Cycling e Metodo Shock) sono riservati ai clienti Pharmo Gold.\n\n" +
        "Questi piani automatizzano i tuoi macro ogni giorno per evitare stalli e massimizzare i risultati dei prodotti Pharmo.\n\n" +
        "Trovi il codice di sblocco all'interno del tuo pacco d'ordine su pharmo.it!"
    );
    window.open('https://www.pharmo.it', '_blank');
}

// Chiama questa funzione dentro handleAuth() o al caricamento
function checkPremiumStatus() {
    const isPremium = localStorage.getItem('app_premium_v1') === 'true';
    const overlay = document.getElementById('premiumLockOverlay');
    const badge = document.getElementById('goldBadge');
    const select = document.getElementById('advProtocol');
    const desc = document.getElementById('protocolDesc');

    if (isPremium) {
        if (overlay) overlay.style.display = 'none';
        if (badge) {
            badge.style.background = "linear-gradient(135deg, #FFD700, #FFA500)";
            badge.innerText = "STATUS GOLD üëë";
        }
        if (select) {
            select.style.borderColor = "#FF9500"; // Arancio Pharmo
            select.style.color = "#5d4037"; // Testo scuro leggibile
        }
        if (desc) {
            desc.style.color = "#5d4037";
            desc.style.borderColor = "#FFD700";
        }
    }
}


const protocolDailyMessages = {
    "shock": {
        "work": "üåä Giorno Light: Stiamo attivando la lipolisi. Mantieni i carboidrati bassi!",
        "rest": "üöÄ Giorno Boost! Alza i carboidrati per risvegliare il metabolismo."
    },
    "atleta_cut": {
        "work": "‚úÇÔ∏è Low Carb Day: Focus sulla definizione. Proteine alte per i muscoli!",
        "rest": "üçö Ricarica Strategica: Rifornisci il glicogeno senza esagerare."
    },
    "cut_agg": {
        "work": "üî• Fase d'Urto: Carboidrati al minimo. Il corpo sta bruciando riserve profonde!",
        "rest": "üîã Ricarica Totale: Goditi i carboidrati, servono a resettare gli ormoni."
    },
    "recomp": {
        "work": "üîÑ Giorno ON: Carboidrati alti per spingere l'allenamento e crescere!",
        "rest": "üíß Giorno OFF: Focus sui grassi buoni e recupero muscolare."
    },
    "bulk": {
        "work": "üí™ Spinta Muscolare: Surplus di carbo per massimizzare l'anabolismo!",
        "rest": "‚öñÔ∏è Mantenimento Pulito: Cresciamo senza accumulare grasso."
}
};

// Dizionario delle descrizioni
const protocolDescriptions = {
    "none": "Scegli il protocollo per attivare il calcolo automatico dei macro.",
    "shock": "üåä IL METODO SHOCK: alterna giorni 'Light' a giorni 'Boost' nel weekend. √à la strategia Pharmo per evitare stalli metabolici e massimizzare la lipolisi."
};

function updateProtocolDesc() {
    const val = document.getElementById('advProtocol').value;
    const goal = document.getElementById('goal').value;
    const descBox = document.getElementById('protocolDesc');
    const isPremium = localStorage.getItem('app_premium_v1') === 'true';

    // BLOCCO DI SICUREZZA PER NON-PREMIUM
    if (val === 'shock' && !isPremium) {
        showToast("üëë Funzione PRO: Target calorie aggiornato per oggi!");
        document.getElementById('advProtocol').value = 'none'; 
        showPremiumAd(); 
        return; 
    }

    let text = "";
    
    // --- CASO 1: NESSUNO (Disattivazione) ---
    if (val === 'none') {
        text = "Scegli il protocollo per attivare il calcolo automatico dei macro.";
        descBox.style.color = "#aaa";
        descBox.style.fontWeight = "400";
        localStorage.setItem('active_protocol_v1', 'none'); 
    } 
    // --- CASO 2: ATTIVATO (Shock o Carb Cycling) ---
    else if (val === 'shock') {
        // ATLETA / MASSA (Carb Cycling)
        if (['lose_athlete_15', 'lose_cons', 'recomp', 'gain'].includes(goal)) {
            text = `
                <strong style="color:#e67e22">‚ö° CARB CYCLING (Zig-Zag)</strong><br><br>
                <b>Come funziona:</b> Alterna giorni di <b>Ricarica</b> (Mercoled√¨ e Weekend) a giorni di <b>Deplezione</b> (Scarico).<br><br>
                <b>Obiettivo:</b> Svuotare le riserve di glicogeno muscolare per ottimizzare la sensibilit√† insulinica e tenere il metabolismo sempre attivo.
            `;
        } 
        // DIMAGRIMENTO / DETOX (Metodo Shock)
        else {
            text = `
                <strong style="color:#007aff">üåä METODO SHOCK (5+2)</strong><br><br>
                <b>Come funziona:</b> 5 giorni di <b>Scarico</b> (Lun-Ven) per svuotare le riserve, seguiti da 2 giorni di <b>Ricarica</b> (Weekend).<br><br>
                <b>Obiettivo:</b> Inganna il metabolismo per evitare stalli e massimizza la lipolisi (brucia-grassi) durante la settimana.
            `;
        }
        
        descBox.style.color = "#5d4037"; 
        descBox.style.fontWeight = "400"; 
        
        localStorage.setItem('active_protocol_v1', 'shock');
        showToast(text.includes("CARB") ? "üëë ‚ö° Carb Cycling Attivato!" : "üëë üåä Metodo Shock Attivato!");
    }

    descBox.innerHTML = text;
    calc(); 
}


// Integrazione nella funzione calc()
// Trova il punto in cui calcoli TGT_C, TGT_P, TGT_F e aggiungi questo:
function applyProtocolLogic(targetC, targetP, targetF) {
    const activeProt = localStorage.getItem('active_protocol_v1') || 'none';
    const isPremium = localStorage.getItem('app_premium_v1') === 'true';
    const intensity = localStorage.getItem('intensity_v1') || 'standard';
    const currentGoal = document.getElementById('goal').value; 
    const isAthlete = ['lose_athlete_15', 'lose_cons', 'recomp', 'gain'].includes(currentGoal);

    if (activeProt !== 'shock' || !isPremium) {
        return { c: targetC, p: targetP, f: targetF };
    }

    const day = new Date().getDay();
    let scarico = 0.80; // Default Standard (-20%)
    let ricarica = 1.20; // Default Standard (+20%)

    // --- LOGICA INTENSIT√Ä VIP ---
    if (intensity === 'soft') {
        scarico = 0.90; // -10%
        ricarica = 1.10; // +10%
    } else if (intensity === 'hard') {
        scarico = 0.65; // -35% (Aggressivo)
        ricarica = 1.35; // +35% (Ricarica potente)
    }

    let modC = 1;
    if (isAthlete) {
        // Atleta: Mer, Sab, Dom sono ricarica
        modC = (day === 3 || day === 6 || day === 0) ? ricarica : scarico;
    } else {
        // Shock: Sab, Dom sono ricarica
        modC = (day === 6 || day === 0) ? ricarica : scarico;
    }

    return {
        c: Math.round(targetC * modC),
        p: targetP,
        f: targetF
    };
}


// ======================================================
// üîë CHIAVI DI ACCESSO UNIFICATE
// ======================================================
const CHIAVE_BASIC = "PHARMOWIN26";   // Solo funzioni base
const CHIAVE_GOLD  = "GOLDPHARMO";    // Sblocca Premium/Gold
const CHIAVE_VIP   = "PLATINUM26";    // Sblocca TUTTO (VIP/Platinum)

function handleAuth() {
    const isUnlocked = localStorage.getItem('app_unlocked_v1');
    const lastUnlock = localStorage.getItem('last_unlock_timestamp');
    const gate = document.getElementById('authGate');
    const closeBtn = document.getElementById('closeAuthBtn');
    const renewalLink = document.getElementById('renewalLinkText');
    
    const thirtyDays = 30 * 24 * 60 * 60 * 1000; 
    const warningDays = 3 * 24 * 60 * 60 * 1000; 
    const trialPeriod = 3 * 24 * 60 * 60 * 1000; 
    const now = Date.now();

        // --- 1. LOGICA 3 GIORNI ---
    if (isUnlocked !== 'true') {
        let firstVisit = localStorage.getItem('first_visit_ever');
        
        if (!firstVisit) {
            localStorage.setItem('first_visit_ever', now.toString());
            if(gate) gate.style.display = 'none'; 
            if(renewalLink) { renewalLink.innerText = `üîë Accesso Attivo: 3 gg rimanenti`;
            }
            // AGGIUNGI QUESTA RIGA: Forza la comparsa della X al primissimo avvio
            if(closeBtn) closeBtn.style.display = 'block'; 
            
            return; 
        }

        const timePassed = now - parseFloat(firstVisit);
        if (timePassed < trialPeriod) {
            if(gate) gate.style.display = 'none';
            const daysLeftTrial = Math.ceil((trialPeriod - timePassed) / (24 * 60 * 60 * 1000));
            if(renewalLink)  { renewalLink.innerText = `üîë Accesso Attivo: ${daysLeftTrial} gg rimanenti`;
                        if (daysLeftTrial === 3) {
                renewalLink.style.color = "#ffcc00"; 
            } else if (daysLeftTrial === 2) {
                renewalLink.style.color = "#ff9500"; 
            } else if (daysLeftTrial <= 1) {
                renewalLink.style.color = "#ff3b30";
            }
            }
           
            // AGGIUNGI QUESTA RIGA: Forza la comparsa della X durante i 3 giorni
            if(closeBtn) closeBtn.style.display = 'block'; 
            
            return;
        }
    }

    // --- 2. LOGICA STANDARD (DOPO SBLOCCO O DOPO I 3 GIORNI) ---
    if (isUnlocked === 'true' && lastUnlock) {
        const timeLeft = thirtyDays - (now - lastUnlock);
        const daysLeft = Math.ceil(timeLeft / (24 * 60 * 60 * 1000));

                if (renewalLink) {
            if (daysLeft > 3) {
                // PERIODI LUNGHI (Sopra i 3 giorni)
                renewalLink.innerText = `üîë Accesso Attivo: ${daysLeft} gg rimanenti`;
                renewalLink.style.color = "#007aff"; // Blu standard
            } else if (daysLeft === 3) {
                // 3 GIORNI ALLA FINE
                renewalLink.innerText = `‚ö†Ô∏è Scadenza tra: 3 giorni (Giallo)`;
                renewalLink.style.color = "#ffcc00"; // GIALLO
                renewalLink.style.fontWeight = "800";
            } else if (daysLeft === 2) {
                // 2 GIORNI ALLA FINE
                renewalLink.innerText = `üü† Scadenza tra: 2 giorni (Arancio)`;
                renewalLink.style.color = "#ff9500"; // ARANCIONE
                renewalLink.style.fontWeight = "900";
            } else if (daysLeft === 1) {
                // ULTIMO GIORNO
                renewalLink.innerText = `üö® ULTIMO GIORNO - Rinnova ora!`;
                renewalLink.style.color = "#ff3b30"; // ROSSO
                renewalLink.style.fontWeight = "900";
                // Aggiungiamo un piccolo effetto pulsante per l'ultimo giorno
                renewalLink.style.textDecoration = "underline";
            }
        }


        if (timeLeft <= 0) {
            localStorage.setItem('app_unlocked_v1', 'false');
            if(gate) {
                gate.style.display = 'flex';
                if(closeBtn) closeBtn.style.display = 'none';
                gate.querySelector('p').innerHTML = "<b>Sessione mensile scaduta!</b><br>Richiedi la nuova chiave su WhatsApp.";
            }
        } else {
            if(gate) gate.style.display = 'none';
            if(closeBtn) closeBtn.style.display = 'block';
            if (timeLeft < warningDays) {
                setTimeout(() => { showToast(`‚ö†Ô∏è Accesso in scadenza tra ${daysLeft} gg. Chiedi la chiave!`); }, 3000);
            }
        }
    } else {
        // Se la prova √® finita (pi√π di 3gg) e NON hai inserito il codice
        if(gate) {
            gate.style.display = 'flex';
            if(closeBtn) closeBtn.style.display = 'none';
        }
        if(renewalLink) renewalLink.innerText = "üîë Clicca per Attivare Pharmocounter";
    }
    if (localStorage.getItem('app_premium_v1') === 'true') {
    document.getElementById('premiumProtocolArea').style.display = 'block';
}

}

function verifyUnlockCode() {
    const entered = document.getElementById('unlockCodeInput').value.trim().toUpperCase();

    // Controlliamo se il codice √® uno di quelli validi
    if (entered === CHIAVE_GOLD || entered === CHIAVE_BASIC || entered === CHIAVE_VIP) {
        localStorage.setItem('app_unlocked_v1', 'true');
        localStorage.setItem('last_unlock_timestamp', Date.now());
        localStorage.removeItem('first_visit_ever');
        
        // Se √® Gold o VIP, sblocca funzioni Premium
        if(entered === CHIAVE_GOLD || entered === CHIAVE_VIP) {
            localStorage.setItem('app_premium_v1', 'true');
            checkPremiumStatus(); 
        }
        
        // Se √® VIP, sblocca lo Status Platinum (per togliere il lucchetto al tasto SOS)
        if(entered === CHIAVE_VIP) {
            localStorage.setItem('app_vip_v1', 'true');
            localStorage.setItem('intensity_v1', 'standard');
        }
updateSugarUI(); 
        document.getElementById('authGate').style.display = 'none';
        showToast("‚úÖ Accesso attivato!");
        
        // Ricarica per applicare i cambiamenti
        setTimeout(() => location.reload(), 1000); 
    } else {
        alert("Chiave errata. Richiedila su WhatsApp!");
    }
}
   


// --- NUOVE LOGICHE: SALVADANAIO E CRONONUTRIZIONE ---

function getBankBalance() {
    return parseFloat(localStorage.getItem('calorie_bank')) || 0;
}

function useBankCalories() {
    const isPremium = localStorage.getItem('app_premium_v1') === 'true';
    const isRecoveryActive = localStorage.getItem('recovery_active_today') === 'true';
    const currentBank = Math.round(getBankBalance());

    // --- 1. BLOCCO GELO PER RECOVERY ---
    if (isRecoveryActive) {
        alert("‚ùÑÔ∏è SALVADANAIO CONGELATO (DEEP FREEZE)\n\nIl protocollo Boost-Recovery √® attivo. Per resettare gli ormoni ed evitare l'accumulo di grasso, il prelievo dal salvadanaio √® disattivato per 7 giorni.");
        return; 
    }

    // --- 2. LOGICA UTENTE BASE (Marketing) ---
    if (!isPremium) {
        alert(
            "üîí FUNZIONE PREMIUM: IL SALVADANAIO\n\n" +
            "Sblocca questa funzione avanzata inserendo il codice GOLD che trovi nel tuo pacco d'ordine su Pharmo.it!"
        );
        window.open('https://www.pharmo.it', '_blank');
        return;
    }

    // --- LOGICA UTENTE PREMIUM ---
    if (currentBank <= 0) {
        alert("Il tuo salvadanaio √® attualmente vuoto. Risparmia qualche caloria oggi per trovarla qui domani mattina!");
        return;
    }

    // STEP 1: SPIEGAZIONE LUNGA (Prima di tutto)
    const spiegazione = 
        "üí∞ IL TUO SALVADANAIO CALORIE\n\n" +
        "In questo spazio si accumulano le calorie che non hai consumato nei giorni scorsi.\n\n" +
        "‚Ä¢ COME FUNZIONA: Se finisci la giornata sotto il tuo target, l'avanzo viene salvato qui ogni mattina alle 04:00.\n\n" +
        "‚Ä¢ A COSA SERVE: Puoi usare questo 'tesoretto' per concederti uno sgarro o un pasto pi√π abbondante oggi senza rovinare i progressi.\n\n" +
        "‚Ä¢ SCADENZA: Il salvadanaio si azzera ogni Luned√¨ mattina per iniziare una nuova settimana.\n\n" +
        "----------------------------------\n" +
        "ATTUALMENTE DISPONIBILI: " + currentBank + " kcal\n" +
        "----------------------------------";

    alert(spiegazione);

    // STEP 2: RICHIESTA NUMERO (Subito dopo la spiegazione)
    let amountToUse = prompt(`Quante kcal vuoi prelevare dal tuo tesoretto di ${currentBank} kcal?`, "200");

    // Controllo se premi Annulla o lasci vuoto
    if (amountToUse === null || amountToUse.trim() === "") {
        return; 
    }

    let amount = parseInt(amountToUse);

    // Validazione input
    if (isNaN(amount) || amount <= 0) {
        alert("Inserisci un numero valido.");
        return;
    }

    if (amount > currentBank) {
        alert("Errore: Non puoi prelevare pi√π di quanto hai accumulato!");
        return;
    }

    // STEP 3: CONFERMA DI SICUREZZA (Finale)
    // Questo √® il blocco che impedisce errori se premi Invio per sbaglio
    if (confirm(`Confermi di voler aggiungere ${amount} kcal al tuo target di oggi?`)) {
        let extra = parseFloat(localStorage.getItem('extra_today')) || 0;
        localStorage.setItem('extra_today', extra + amount);
        localStorage.setItem('calorie_bank', currentBank - amount);
        
        showToast(`üëë Bonus di ${amount} kcal aggiunto al target odierno!`);
        setTimeout(() => location.reload(), 1200);
    }
}

function checkCrononutrizione(calorie, carbo) {
    const ora = new Date().getHours();
    if (ora >= 6 && ora <= 10) {
        showToast("üî• Mattina: Attiva il metabolismo ora con Pharmofit!");
    } else if (ora >= 13 && ora <= 15) {
        showToast("üíß Dopo pranzo: Pharmodren ti aiuta a sgonfiare i liquidi.");
    } else if (ora >= 20) {
        if (carbo > 30) showToast("üíä Cena: Pharmolain aiuta a digerire e previene il gonfiore!");
        else showToast("üåô Pharmofit la sera aiuta il metabolismo notturno.");
    }
}

    // --- COSTANTI & INIT ---
    const d = new Date();
    document.getElementById('dateText').innerText = d.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
    const KCAL_PER_KG_FAT = 7700; 
    const SECONDS_IN_DAY = 86400;
    const MAX_SAFE_DAILY_DEFICIT = 1000; 
    const PT_MIN_MULTIPLIER = 1.8;

    // --- TESTI PROTOCOLLI DETTAGLIATI & PERSUASIVI ---
    const stackLoss = `
        Consiglio: <b>Pharmofit</b>, <b>Pharmodren</b> e <b>Pharmofiller</b>.
        <details class="shop-details">
            <summary>Svela la strategia completa</summary>
            <div class="shop-highlight" style="border-left-color:#ff3b30;">
                <b>1. PHARMOFIT (Metabolismo):</b><br>
                Non basta mangiare meno. Pharmofit costringe il tuo corpo a usare i grassi come fonte primaria di energia grazie alla termogenesi indotta da Caff√® Verde e Arancio Amaro. Sblocca gli stalli metabolici.
            </div>
            <div class="shop-highlight" style="border-left-color:#34c759;">
                <b>2. PHARMODREN (Drenante Urtante):</b><br>
                Spesso quello che credi sia grasso √® acqua extracellulare. Betulla e Ananas prosciugano la ritenzione idrica, sgonfiando immediatamente girovita e gambe pesanti.
            </div>
            <div class="shop-highlight" style="border-left-color:#007aff;">
                <b>3. PHARMOFILLER (Struttura - L'architetto della Pelle):</b><br>
              Ricostruisce l'impalcatura cutanea mentre ti svuoti. Evita l'effetto "pelle svuotata". Mentre perdi volume, il Collagene e l'Acido Ialuronico mantengono la pelle elastica, soda e compatta, prevenendo i cedimenti.
            </div>
        </details>`;

    const stackDetox = `
        Consiglio: <b>Pharmodren</b> e <b>Pharmolain</b>.
        <details class="shop-details">
            <summary>Svela la strategia completa</summary>
            <div class="shop-highlight" style="border-left-color:#34c759;">
                <b>1. PHARMODREN (Wash-out Tossine):</b><br>
                Un vero lavaggio interno. Elimina le tossine accumulate nei tessuti che infiammano il corpo e bloccano il dimagrimento. Risultato: gambe leggere e microcircolo riattivato.
            </div>
            <div class="shop-highlight" style="border-left-color:#ffcc00;">
                <b>2. PHARMOLAIN (Pancia Piatta):</b><br>
                La Bromelina ad alto dosaggio (2500 GDU) √® un potente antinfiammatorio naturale. Polverizza il gonfiore addominale post-pasto e migliora la digestione istantaneamente.
            </div>
        </details>`;

    const stackBeauty = `
        Consiglio: <b>Pharmofiller</b> e <b>Pharmodren</b>.
        <details class="shop-details">
            <summary>Svela la strategia completa</summary>
            <div class="shop-highlight" style="border-left-color:#007aff;">
                <b>1. PHARMOFILLER (Anti-Age):</b><br>
                Dopo i 25 anni perdi l'1.5% di collagene l'anno. Pharmofiller lo reintegra dall'interno, rimpolpando le rughe sottili e garantendo un'idratazione profonda che nessuna crema pu√≤ raggiungere.
            </div>
            <div class="shop-highlight" style="border-left-color:#34c759;">
                <b>2. PHARMODREN (Glow & Ossigeno):</b><br>
                Una pelle bella deve respirare. La Vite Rossa stimola il microcircolo sottocutaneo, portando ossigeno e nutrienti in superficie per un colorito sano, roseo e luminoso.
            </div>
        </details>`;

    const stackRecomp = `
        Consiglio: <b>Pharmofit</b> e <b>Pharmolain</b>.
        <details class="shop-details">
            <summary>Svela la strategia completa</summary>
            <div class="shop-highlight" style="border-left-color:#ff3b30;">
                <b>1. PHARMOFIT (Gestione Carboidrati):</b><br>
                Il Cromo Picolinato indirizza i carboidrati che mangi verso il muscolo (glicogeno) invece che nel tessuto adiposo. Energia esplosiva per l'allenamento e zero accumuli.
            </div>
            <div class="shop-highlight" style="border-left-color:#ffcc00;">
                <b>2. PHARMOLAIN (Assimilazione):</b><br>
                Mangiare proteine non basta, devi assorbirle. La Bromelina massimizza la digestione proteica, garantendo che ogni grammo vada a costruire e riparare le fibre muscolari.
            </div>
        </details>`;

    const stackGain = `
         Consiglio: <b>Pharmofit</b>, <b>Pharmodren</b> e <b>Pharmofiller</b>.
        <details class="shop-details">
            <summary>Svela la strategia completa</summary>
            <div class="shop-highlight" style="border-left-color:#ff3b30;">
                <b>1. PHARMOFIT (Clean Bulk):</b><br>
                Ottimizza la sensibilit√† insulinica. Ti permette di stare in surplus calorico minimizzando l'accumulo di grasso sporco. Crescita pulita e controllata.
            </div>
            <div class="shop-highlight" style="border-left-color:#34c759;">
                <b>2. PHARMODREN (Definizione HD):</b><br>
                L'acqua appanna i muscoli. Pharmodren elimina i liquidi sottocutanei in eccesso, facendo emergere vascolarizzazione e striature muscolari.
            </div>
            <div class="shop-highlight" style="border-left-color:#007aff;">
                <b>3. PHARMOFILLER (Scudo Smagliature):</b><br>
                La crescita muscolare rapida stressa la pelle. L'integrazione di collagene rende il tessuto connettivo elastico, prevenendo la formazione di smagliature su bicipiti e petto.
            </div>
        </details>`;


    // --- STATO E VARIABILI GLOBALI ---
    let foods = JSON.parse(localStorage.getItem('foods_v3')) || [];
        let customFoods = JSON.parse(localStorage.getItem('custom_foods_v1')) || {};
    let waterCount = parseInt(localStorage.getItem('water_count')) || 0;
    let cumulativeDeficit = parseFloat(localStorage.getItem('cumulative_deficit')) || 0;
    let streakCount = parseInt(localStorage.getItem('streak_days')) || 1;
    let appReady = false; // Variabile per silenziare i toast all'avvio


    
    // Recupero Profilo
    let savedProfile = localStorage.getItem('profile_v3');
    let state = JSON.parse(savedProfile) || {
        g: 'm', age: 30, w: 75, h: 175, act: 1.375, goal: 'maintain', 
        targetW: 0, targetD: '', circ_abd: 0, circ_coscia: 0, circ_braccio: 0
    };

    // Variabili Calcolate Globale
    let TGT_CAL = 0, TGT_C = 0, TGT_P = 0, TGT_F = 0, BMR = 0, TDEE = 0, PT_MIN_G = 0, TGT_MIN_KCAL = 0; // <-- VIRGOLA AGGIUNTA

    // --- RESET GIORNALIERO (4:00 AM) ---
    const now = new Date(); now.setHours(now.getHours() - 4);
    const todayStr = now.toDateString();
    
        if (localStorage.getItem('app_date') !== todayStr) {
        // AGGIUNGI QUESTA RIGA DENTRO IL RESET GIORNALIERO
localStorage.setItem('extra_today', 0); 
        let lastTarget = parseFloat(localStorage.getItem('last_day_target')) || 0;
        let lastConsumed = parseFloat(localStorage.getItem('last_day_total_consumed')) || 0;
        let lastBMR = parseFloat(localStorage.getItem('last_day_bmr')) || 0; 
        
        // --- üí∞ NOVIT√Ä: LOGICA SALVADANAIO (Accumulo) ---
        let saving = lastTarget - lastConsumed;
        if (saving > 0) {
            let currentBank = parseFloat(localStorage.getItem('calorie_bank')) || 0;
            localStorage.setItem('calorie_bank', currentBank + saving);
        }

        // --- üìä REPORT SETTIMANALE & RESET ---
        let dayOfWeek = new Date().getDay(); 
        
        // Se oggi √® Luned√¨, facciamo il bilancio finale della settimana passata
 // Cerca questo pezzo e sostituiscilo:
                        // --- üìä REPORT SETTIMANALE & RESET ---
        if (dayOfWeek === 1) { 
            const isPremium = localStorage.getItem('app_premium_v1') === 'true';
            if (!isPremium) {
                alert("üìä REPORT SETTIMANALE DISPONIBILE!\n\nAbbiamo analizzato i tuoi dati. Per vedere il report completo dei tuoi progressi devi essere un utente PRO.");
            } else { 
                let bank = parseFloat(localStorage.getItem('calorie_bank')) || 0;
                let grassoPerso = Math.round(bank / 7);
                if (bank > 0) {
                    let reportTesto = `üìä IL MIO TRAGUARDO SETTIMANALE PHARMO:\n\nüî• Calorie risparmiate: ${Math.round(bank)} kcal\n‚öñÔ∏è Grasso extra perso (stima): ~${grassoPerso}g\n\nüçé Inizia anche tu su: tinyurl.com/pharmoit`;
                    alert(reportTesto);
                    if (confirm("Vuoi inoltrare il tuo report su WhatsApp?")) {
                        window.open(`https://wa.me/?text=${encodeURIComponent(reportTesto)}`, '_blank');
                    }
                }
            }
                        localStorage.setItem('calorie_bank', 0); // Reset dopo il report
        } else if (dayOfWeek === 0) {

            // Se √® domenica, diamo solo un piccolo incoraggiamento (opzionale)
            setTimeout(() => {
                showToast("üìä Domani mattina riceverai il tuo Report Settimanale completo!");
            }, 2000);
        }


        // --- 1. Aggiornamento Deficit & Platino Check (Originale) ---
        const daySuccess = lastConsumed >= lastBMR;
        if (lastTarget > 0) {
            cumulativeDeficit += (lastTarget - lastConsumed);
            localStorage.setItem('cumulative_deficit', cumulativeDeficit);
        }

        const lastPrecision = parseInt(localStorage.getItem('last_day_precision')) || 0;
        let pStreak = parseInt(localStorage.getItem('platinum_streak')) || 0;
        if (lastPrecision >= 3) pStreak++; else pStreak = 0;
        localStorage.setItem('platinum_streak', pStreak);

        if (pStreak >= 5 && !localStorage.getItem('claimed_platinum_5')) {
            alert("üíé PLATINO SBLOCCATO! 5 giorni di precisione Oro!\n\nIl tuo premio speciale √®: PHARMO5DAYS\n\nUsalo subito su pharmo.it per i tuoi prodotti preferiti!");
            window.open('https://www.pharmo.it', '_blank');
            localStorage.setItem('claimed_platinum_5', 'true');
        }

        // --- 2. Streak Visiva & Logica Ciclica (Originale) ---
        let lastVisit = localStorage.getItem('last_visit_date');
        let yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
        let daysSince30Win = parseInt(localStorage.getItem('days_since_30_win')) || 0;
        
        if (lastVisit === yesterday.toDateString() && daySuccess) {
            streakCount++;
            if (daysSince30Win > 0) {
                daysSince30Win++;
                localStorage.setItem('days_since_30_win', daysSince30Win);
            }
        } else {
            streakCount = 1; 
            daysSince30Win = 0;
            localStorage.removeItem('days_since_30_win');
            localStorage.removeItem('active_streak_code');
        }
        
        if (daysSince30Win > 3) {
            alert("üéâ La sfida Pharmo √® ricominciata! La tua serie √® stata resettata.");
            streakCount = 1;
            daysSince30Win = 0;
            localStorage.removeItem('days_since_30_win');
            localStorage.removeItem('active_streak_code');
        }

        localStorage.setItem('streak_days', streakCount);
        localStorage.setItem('last_visit_date', todayStr);

        // --- CONTROLLO PREMI (Originale) ---
        let rewardCode = null;
        let claimedKey = null;
        if (streakCount === 7 && !localStorage.getItem('claimed_7_days')) {
            rewardCode = 'PHARMO1100'; claimedKey = 'claimed_7_days';
        } else if (streakCount === 14 && !localStorage.getItem('claimed_14_days')) {
            rewardCode = 'PHARMO6598'; claimedKey = 'claimed_14_days';
        } else if (streakCount === 30 && !localStorage.getItem('claimed_30_days')) {
            rewardCode = 'PHARMO8756'; claimedKey = 'claimed_30_days';
            localStorage.setItem('days_since_30_win', 1); 
        }

        if (rewardCode) {
            alert(`üéâ Sfida Pharmo Completata! Codice: ${rewardCode}`);
            localStorage.setItem(claimedKey, 'true');
            localStorage.setItem('active_streak_code', rewardCode); 
        }

        // --- LOGICA ACQUA (Originale) ---
        let wStreak = parseInt(localStorage.getItem('water_streak_days')) || 0;
        let lastWin = localStorage.getItem('last_water_win_date');
        let yest = new Date(now); yest.setDate(yest.getDate() - 1);
        
        if (lastWin !== yest.toDateString()) {
            if (wStreak > 0) localStorage.setItem('water_streak_days', 0);
        } else if (wStreak >= 3) {
            localStorage.setItem('water_streak_days', 0);
        }

        // --- 3. Reset Dati di Giornata (Originale) ---
        if (state.circ_abd > 0) localStorage.setItem('last_week_abd', state.circ_abd);
        if (state.circ_coscia > 0) localStorage.setItem('last_week_coscia', state.circ_coscia);
        if (state.circ_braccio > 0) localStorage.setItem('last_week_braccio', state.circ_braccio);

        localStorage.setItem('foods_v3', JSON.stringify([])); 
        localStorage.setItem('water_count', 0);
        localStorage.setItem('water_last_time', 0);
        localStorage.setItem('sos_active_today', 'false');
        localStorage.setItem('extra_today',0); // Azzera eventuali calorie extra residue
        localStorage.setItem('app_date', todayStr);

        foods = []; 
        waterCount = 0; 
        location.reload();
    }



    // --- FUNZIONI UTILI ---
        function showToast(msg) {
    const t = document.getElementById('smartToast');
    const toastMsg = document.getElementById('toastMsg');
    
    // Se il messaggio contiene la corona, aggiungiamo un bordo dorato temporaneo
    if (msg.includes('üëë')) {
        t.style.border = "2px solid #FFD700";
        t.style.boxShadow = "0 10px 25px rgba(255, 215, 0, 0.3)";
    } else {
        t.style.border = "none";
        t.style.boxShadow = "0 10px 20px rgba(0,0,0,0.25)";
    }

    toastMsg.innerText = msg;
    t.classList.add('toast-visible');
    setTimeout(() => t.classList.remove('toast-visible'), 10000); 
}

    
    function copyCode(el) { navigator.clipboard.writeText(el.innerText); alert("Codice copiato!"); }
    function closeReward(id) { 
        if(id==='waterRewardModal') window.open('https://www.pharmo.it', '_blank');
        document.getElementById(id).style.display = 'none'; 
        localStorage.setItem(id === 'rewardModal' ? 'reward_claimed' : 'water_reward_claimed', 'true');
    }
    function acceptTerms() { 
    document.getElementById('disclaimerModal').style.display = 'none'; 
    localStorage.setItem('terms_accepted_v1', 'true'); 
    document.getElementById('profileDetails').open = true;
    
    // I toast partono solo dopo l'accettazione
    const finalTotals = render(); 
    checkTimeAdvice(finalTotals.curP); 
}

  // --- GESTIONE DATABASE CIBI PERSONALE ---
    
       // --- GESTIONE CIBI AVANZATA ---

    // 1. Carica la tendina
    function renderFavSelect() {
        const sel = document.getElementById('favSelect');
        sel.innerHTML = '<option value="">-- Scegli o Crea Nuovo --</option>';
        Object.keys(customFoods).sort().forEach(name => {
            let opt = document.createElement('option');
            opt.value = name;
            opt.innerText = name;
            sel.appendChild(opt);
        });
    }

    // 2. Carica Cibo + Grammatura salvata
    function loadFav() {
        const name = document.getElementById('favSelect').value;
        if(customFoods[name]) {
            const f = customFoods[name];
            document.getElementById('inName').value = name;
            document.getElementById('inCal100').value = f.k;
            document.getElementById('inCarb100').value = f.c;
            document.getElementById('inProt100').value = f.p;
            document.getElementById('inFat100').value = f.f;
            // Carica la grammatura preferita (o 100 se non esiste)
            document.getElementById('inGrams').value = f.defG || 100; 
        }
    }

    // 3. Salva Cibo + Grammatura attuale
    function saveFav() {
        const n = document.getElementById('inName').value.trim();
        const k = parseFloat(document.getElementById('inCal100').value);
        const c = parseFloat(document.getElementById('inCarb100').value)||0;
        const p = parseFloat(document.getElementById('inProt100').value)||0;
        const f = parseFloat(document.getElementById('inFat100').value)||0;
        const g = parseFloat(document.getElementById('inGrams').value)||100;

        if(!n || isNaN(k)) { alert("Inserisci Nome e Kcal per salvare."); return; }

        customFoods[n] = { k, c, p, f, defG: g }; // Salva anche i grammi preferiti
        localStorage.setItem('custom_foods_v1', JSON.stringify(customFoods));
        renderFavSelect();
        document.getElementById('favSelect').value = n;
        showToast("Salvato! Ricorder√≤ questi grammi.");
    }

    // 4. Elimina Cibo
    function deleteFav() {
        const n = document.getElementById('favSelect').value;
        if(n && confirm(`Eliminare "${n}"?`)) {
            delete customFoods[n];
            localStorage.setItem('custom_foods_v1', JSON.stringify(customFoods));
            renderFavSelect();
            document.querySelectorAll('.add-box input').forEach(i => i.value = '');
        }
    }

    // 5. CALCOLA E AGGIUNGE AL DIARIO (Sostituisce la vecchia add)
                function addCalculated() {
    const n = document.getElementById('inName').value;
    const k100 = parseFloat(document.getElementById('inCal100').value);
    const c100 = parseFloat(document.getElementById('inCarb100').value) || 0;
    const p100 = parseFloat(document.getElementById('inProt100').value) || 0;
    const f100 = parseFloat(document.getElementById('inFat100').value) || 0;
    const s100 = parseFloat(document.getElementById('inSugar').value) || 0; // Prende gli zuccheri
    const g = parseFloat(document.getElementById('inGrams').value);

    if (n && !isNaN(k100) && g > 0) {
        const finalK = Math.round((k100 * g) / 100);
        const finalC = Math.round((c100 * g) / 100);
        const finalP = Math.round((p100 * g) / 100);
        const finalF = Math.round((f100 * g) / 100);
        const finalS = Math.round((s100 * g) / 100); // Calcola lo zucchero effettivo

        // Salva tutto nell'oggetto foods (inclusa la 's')
        foods.push({ n: `${n} (${g}g)`, k: finalK, c: finalC, p: finalP, f: finalF, s: finalS });
        localStorage.setItem('foods_v3', JSON.stringify(foods));

        checkCrononutrizione(finalK, finalC);
        render(); // Aggiorna la vista

        // Pulisce tutti i campi input
        document.querySelectorAll('.add-box input').forEach(i => i.value = '');
        document.getElementById('inGrams').value = '100';

        // Avvisi del Coach/Toast
        const totalWait = checkSmartAdvice(n, finalK, finalC, finalP, finalF, TGT_CAL);
        setTimeout(() => {
            showToast(`‚úÖ Diario aggiornato: +${finalK} kcal`);
        }, totalWait);

    } else {
        alert("Compila i dati e la grammatura.");
    }
}



        // --- GESTIONE DIGIUNO INTERMITTENTE (AGGIORNATA) ---
    function updateFastingUI() {
    const mode = document.getElementById('fastingMode').value;
    const isPremium = localStorage.getItem('app_premium_v1') === 'true';

    if (mode !== 'none' && !isPremium) {
        alert("üîí MODALIT√Ä FASTING PREMIUM\n\nI protocolli di digiuno sono disponibili solo per i membri PRO. Effettua un ordine su Pharmo.it per sbloccarli!");
        document.getElementById('fastingMode').value = 'none';
        return;
    }
        const startInput = document.getElementById('fastingStart').value;
        
        // Elementi da aggiornare
        const mainBox = document.getElementById('fastingStatusBox');
        const smallBox = document.getElementById('fastingSmallStatus');
        
        // Salva preferenze
        localStorage.setItem('fasting_mode', mode);
        localStorage.setItem('fasting_start', startInput);

        if (mode === 'none') {
            if(mainBox) mainBox.style.display = 'none';
            if(smallBox) smallBox.style.display = 'none';
            return;
        }

        // Calcoli Orari
        const now = new Date();
        const nowMins = (now.getHours() * 60) + now.getMinutes();
        const [startH, startM] = startInput.split(':').map(Number);
        const startMins = (startH * 60) + startM;
        
        // Calcola durata finestra cibo
        const eatingWindow = (24 - parseInt(mode)); 
        const endMins = startMins + (eatingWindow * 60);

        // Verifica finestra temporale
        let isEating = false;
        if (endMins < 1440) { 
            if (nowMins >= startMins && nowMins < endMins) isEating = true;
        } else { 
            const realEnd = endMins - 1440;
            if (nowMins >= startMins || nowMins < realEnd) isEating = true;
        }

        // Orario di fine
        let endH = Math.floor(endMins / 60) % 24;
        let endM = endMins % 60;
        let endTimeStr = `${endH.toString().padStart(2,'0')}:${endM.toString().padStart(2,'0')}`;

        // Mostra i box
        if(mainBox) mainBox.style.display = 'block';
        if(smallBox) smallBox.style.display = 'block';
        
        let timeLabel = "";
        if (!isEating) {
            let minsToWait = (startMins - nowMins);
            if (minsToWait < 0) minsToWait += 1440;
            let hLeft = Math.floor(minsToWait/60);
            let mLeft = minsToWait % 60;
            timeLabel = `Prossimo pasto tra: <b>${hLeft}h ${mLeft}m</b>`;
        }

        if (isEating) {
            // --- FASE VERDE (CIBO) ---
            smallBox.style.background = "#d4edda"; smallBox.style.color = "#155724";
            smallBox.innerHTML = `üçΩÔ∏è ORA: PUOI MANGIARE (fino alle ${endTimeStr})`;

            if(mainBox) {
                mainBox.style.background = "linear-gradient(135deg, #e6fffa 0%, #e8f5e9 100%)";
                mainBox.style.border = "2px solid #34c759";
                mainBox.style.color = "#006400";
                mainBox.innerHTML = `
                    <div style="font-size:1.2rem; font-weight:800; margin-bottom:5px;">üçΩÔ∏è PUOI MANGIARE</div>
                    <div style="font-size:0.85rem; margin-bottom:10px;">La finestra chiude alle <b>${endTimeStr}</b></div>
                    <div style="background:white; padding:10px; border-radius:10px; border-left:4px solid #34c759; text-align:left; font-size:0.85rem; line-height:1.4; color:#333;">
                        <b>üöÄ Controllo Fame & Metabolismo:</b><br>
                        Prima di iniziare a mangiare, assumi <b>Pharmofit</b>.<br>
                        <span style="color:#e65100; font-weight:700;">Perch√©?</span> L'Arancio Amaro aiuta a controllare l'appetito e accende subito il consumo calorico.
                    </div>`;
            }
        } else {
            // --- FASE ROSSA (DIGIUNO) ---
            smallBox.style.background = "#f8d7da"; smallBox.style.color = "#721c24";
            smallBox.innerHTML = `‚õî ORA: STOP CIBO`;

            if(mainBox) {
                mainBox.style.background = "linear-gradient(135deg, #fff5f5 0%, #fff0f0 100%)";
                mainBox.style.border = "2px solid #ff3b30";
                mainBox.style.color = "#b30000";
                mainBox.innerHTML = `
                    <div style="font-size:1.2rem; font-weight:800; margin-bottom:5px;">‚õî STOP CIBO (Fasting)</div>
                    <div style="font-size:0.85rem; margin-bottom:10px;">${timeLabel}</div>
                    
                    <div style="background:white; padding:10px; border-radius:10px; border-left:4px solid #ff3b30; text-align:left; font-size:0.85rem; line-height:1.4; color:#333;">
                        
                        <div style="margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #ffcccc;">
                            <div style="margin-bottom:4px;"><b style="color:#34c759;">‚úÖ PUOI BERE:</b> Acqua, caff√® nero (no zucchero), t√®, tisane amare.</div>
                            <div><b style="color:#ff3b30;">‚ùå NON PUOI:</b> Cibo solido, bevande zuccherate, latte, cappuccini o succhi.</div>
                        </div>

                        <b>üíß Drenaggio Profondo:</b><br>
                        Mentre il corpo non digerisce, i reni lavorano al massimo.<br>
                        <span style="color:#007aff; font-weight:700;">Consiglio:</span> Usa <b>Pharmodren</b> ora. Non rompe il digiuno e massimizza l'eliminazione dei liquidi.
                    </div>`;
            }
        }
    }


        function calc() {
    // --- GESTIONE EMOJI (VISIBILE A TUTTI) ---
    const recoveryLock = document.getElementById('recoveryLock');
    if (recoveryLock) {
        const isVip = localStorage.getItem('app_vip_v1') === 'true';
        const streak = parseInt(localStorage.getItem('streak_days')) || 0;
        if (isVip && streak >= 7) {
            recoveryLock.innerText = "üíé";
        } else {
            recoveryLock.innerText = "üîí";
        }
    }

    // --- 1. RECUPERO DATI ---
    state.g = document.getElementById('gender').value;
    state.age = parseFloat(document.getElementById('age').value) || 30;
    state.w = parseFloat(document.getElementById('weight').value) || 0;
    state.h = parseFloat(document.getElementById('height').value) || 0;
    state.act = parseFloat(document.getElementById('act').value) || 1.375;
    state.goal = document.getElementById('goal').value;

    // Se i dati sono a zero, mostra l'avviso e ferma lo script
            if (state.w === 0 || state.h === 0) {
        document.getElementById('scientificData').innerHTML = "‚ö†Ô∏è Inserisci <b>Peso</b> e <b>Altezza</b> per vedere i calcoli.";
        
        updatePredictionStatus(); // <--- AGGIUNGI QUESTA RIGA QUI!
        
        return; 
    }


    // Gestione Nomi Dinamici Protocollo
    const shockOpt = document.querySelector('#advProtocol option[value="shock"]');
    if (shockOpt) {
        if (['lose_athlete_15', 'lose_cons', 'recomp', 'gain'].includes(state.goal)) {
            shockOpt.innerText = "üëë ‚ö° Carb Cycling Pro"; 
        } else {
            shockOpt.innerText = "üëë üåä Metodo Shock Metabolico"; 
        }
    }

    state.targetW = parseFloat(document.getElementById('targetWeightInput').value) || 0;
    state.targetD = document.getElementById('targetDateInput').value || '';
    state.circ_abd = parseFloat(document.getElementById('circ_abd').value) || 0;
    state.circ_coscia = parseFloat(document.getElementById('circ_coscia').value) || 0;
    state.circ_braccio = parseFloat(document.getElementById('circ_braccio').value) || 0;
    
    localStorage.setItem('profile_v3', JSON.stringify(state));

    // --- 2. SUGGERITORE PESO ---
    const suggestionBox = document.getElementById('idealWeightSuggestion');
    if (suggestionBox) {
        suggestionBox.style.display = 'block';
        if (['lose_athlete_15', 'lose_cons', 'recomp'].includes(state.goal)) {
            suggestionBox.innerHTML = "ü¶µ <b>Atleta:</b> Il peso √® relativo. Conta la composizione corporea.";
            suggestionBox.style.background = "#fff5e6"; suggestionBox.style.color = "#b35900"; suggestionBox.style.border = "1px solid #ffcc00";
        } else if (['gain'].includes(state.goal)) {
            suggestionBox.innerHTML = "üí™ <b>Massa:</b> Punta a salire di peso pulito.";
            suggestionBox.style.background = "#d4edda"; suggestionBox.style.color = "#155724"; suggestionBox.style.border = "1px solid #34c759";
        } else {
            const hM = state.h / 100;
            const minW = Math.round(18.5 * hM * hM);
            const maxW = Math.round(24.9 * hM * hM);
            suggestionBox.innerHTML = `üí° Range Salute: <b>${minW} - ${maxW} kg</b>`;
            suggestionBox.style.background = "#eef7ff"; suggestionBox.style.color = "#004494"; suggestionBox.style.border = "1px solid #cceeff";
        }
    }

    // --- 3. CALCOLO BMR & TDEE ---
    let s = (10 * state.w) + (6.25 * state.h) - (5 * state.age);
    BMR = (state.g === 'm') ? s + 5 : s - 161;
    TDEE = Math.round(BMR * state.act);

    // --- VARIABILI OBIETTIVI ---
    let p_r, c_r, f_r, gTxt, sTit, sDes;
    let reqHighProt = false;
    
    // QUESTA √à LA VARIABILE CHE DAVA PROBLEMI SE DUPLICATA
    let adj = { 'lose_aggr': 0.80, 'lose_athlete_15': 0.85, 'lose_cons': 0.90, 'detox': 0.95, 'beauty': 1.0, 'recomp': 0.95, 'maintain': 1.0, 'gain': 1.10 };

    if (state.goal.startsWith('lose')) {
        sTit = "Protocollo Total Body 3-Fasi"; sDes = stackLoss;
        if (state.goal === 'lose_aggr') { c_r=0.4; p_r=0.3; f_r=0.3; gTxt="üìâ Perdita Peso Standard (-20%)"; }
        else if (state.goal === 'lose_athlete_15') { c_r=0.35; p_r=0.35; f_r=0.3; gTxt="‚úÇÔ∏è Atleta / Cut Aggressivo (-15%)"; reqHighProt=true; }
        else { c_r=0.4; p_r=0.3; f_r=0.3; gTxt="üõ°Ô∏è Atleta / Cut Conservativo (-10%)"; reqHighProt=true; }
    } else if (state.goal === 'recomp') {
        c_r=0.35; p_r=0.35; f_r=0.3; gTxt="üí™ Ricomposizione Corporea"; sTit="Protocollo Recomp"; sDes=stackRecomp; reqHighProt=true;
    } else {
        // ELSE GENERICO
        c_r=0.5; p_r=0.2; f_r=0.3; 
        if(state.goal==='detox') { gTxt="üíß Detox & Sgonfiamento (-5%)"; sTit="Protocollo Detox"; sDes=stackDetox; }
        else if(state.goal==='beauty') { gTxt="‚ú® Beauty & Anti-Age (Mantenimento)"; sTit="Protocollo Glow"; sDes=stackBeauty; c_r=0.45; p_r=0.25; }
        else if(state.goal==='gain') { gTxt="üìà Aumento Muscolare (+10%)"; sTit="Protocollo Struttura"; sDes=stackGain; c_r=0.45; p_r=0.30; reqHighProt = true; }
        else { gTxt="‚öñÔ∏è Mantenimento"; sTit="Protocollo Definizione"; sDes=stackGain; }
    }

    // --- 5. LOGICA PROTOCOLLI SPECIALI ---
    const isRecoveryActive = localStorage.getItem('recovery_active_today') === 'true';

    if (isRecoveryActive) {
        TGT_CAL = TDEE; 
        TGT_C = Math.round((TGT_CAL * 0.55) / 4); 
        TGT_P = Math.round((TGT_CAL * 0.25) / 4); 
        TGT_F = Math.round((TGT_CAL * 0.20) / 9);
        const stText = document.getElementById('statusText');
        if (stText) stText.innerHTML = "üíé <b style='color:#b8860b'>BOOST-RECOVERY ATTIVO:</b> Reset ormonale in corso!";
    } else { 
        // CALCOLO NORMALE
        TGT_CAL = Math.round(TDEE * (adj[state.goal] || 1.0));

        let baseC = (TGT_CAL * c_r) / 4;
        let baseP = (TGT_CAL * p_r) / 4;
        let baseF = (TGT_CAL * f_r) / 9;

        const finalMacros = applyProtocolLogic(baseC, baseP, baseF);
        const finalSOS = applySOSLogic(finalMacros.c, finalMacros.p, finalMacros.f);
        
        TGT_C = Math.round(finalSOS.c);
        TGT_P = Math.round(finalSOS.p);
        TGT_F = Math.round(finalSOS.f);
        TGT_CAL = (TGT_C * 4) + (TGT_P * 4) + (TGT_F * 9);
    }

    // --- 6. CORREZIONE PROTEINE ---
    PT_MIN_G = reqHighProt ? Math.round(state.w * 1.8) : 0;
    localStorage.setItem('pt_min_g', PT_MIN_G);
    
    if (reqHighProt && TGT_P < PT_MIN_G) {
        TGT_P = PT_MIN_G + 10; 
        TGT_CAL = (TGT_C * 4) + (TGT_P * 4) + (TGT_F * 9);
    }

    TGT_CAL += (parseFloat(localStorage.getItem('extra_today')) || 0);
    
    if (TGT_CAL < BMR) TGT_CAL = Math.round(BMR);
    TGT_MIN_KCAL = Math.max(Math.round(TDEE * 0.80), BMR);

    // --- CALCOLO DEI MACRO REALI ---
    let consumedC = 0, consumedP = 0, consumedF = 0;
    foods.forEach(f => { consumedC += f.c; consumedP += f.p; consumedF += f.f; });

    // --- 7. AGGIORNAMENTO UI ---
    document.getElementById('scientificData').innerHTML = `Metabolismo Basale (BMR): <b>${Math.round(BMR)}</b> kcal<br>Fabbisogno Totale (TDEE): <b>${TDEE}</b> kcal<br>Piano: <b>${gTxt}</b>`;

    if (!isRecoveryActive) {
        document.getElementById('shopTitle').innerText = sTit; 
        document.getElementById('shopDesc').innerHTML = sDes;
    }
    
    document.getElementById('targetDisplay').innerText = Math.round(TGT_CAL);

    let bmrPct = (TGT_CAL > 0) ? Math.min((BMR / TGT_CAL) * 100, 95) : 0;
    document.getElementById('bmrMarker').style.left = bmrPct + "%";
    document.getElementById('bmrTag').style.left = bmrPct + "%";

    const protDashArea = document.getElementById('proteinDashboardArea');
    if (['lose_athlete_15', 'lose_cons', 'recomp', 'gain'].includes(state.goal)) {
        protDashArea.style.display = 'block';
        document.getElementById('protMinLabel').innerText = PT_MIN_G;
        let markerPos = Math.min((PT_MIN_G / TGT_P) * 100, 95);
        document.getElementById('protMinMarker').style.left = markerPos + "%";
    } else {
        protDashArea.style.display = 'none';
    }
    // ... (sopra ci sono i calcoli di BMR e TDEE)

    // --- AGGIORNAMENTO DINAMICO BADGE (PRO/VIP) ---
    const isPremium = localStorage.getItem('app_premium_v1') === 'true';
    const isVip = localStorage.getItem('app_vip_v1') === 'true';
    const streakDays = parseInt(localStorage.getItem('streak_days')) || 0;

  
    // Lucchetto Coach AI
    const cIcon = document.getElementById('coachLockIcon');
    if (cIcon) cIcon.innerHTML = isPremium ? "üß†" : "üîí";

    // Lucchetto Bio-Timing
    const tIcon = document.getElementById('cronoLockIcon');
    if (tIcon) tIcon.innerHTML = isVip ? "üß¨" : "üîí";

    // Lucchetto Boost Recovery (VIP + Serie 7)
    const rIcon = document.getElementById('recoveryLock');
    if (rIcon) rIcon.innerHTML = (isVip && streakDays >= 7) ? "üíé" : "üîí";

document.getElementById('targetDateInput').addEventListener('change', function() {
    const isPremium = localStorage.getItem('app_premium_v1') === 'true';
    if (!isPremium) {
        alert("üîí DATA BLOCCATA\n\n\n\nLa gestione della Data Traguardo √® riservata ai membri PRO. Sbloccala con il tuo codice Pharmo che trovi dentro il pacco.");
        this.value = ""; // Svuota la scelta fatta
        updatePredictionStatus(); // Forza il ritorno del lucchetto üîí PRO
    }
});

    // --- AGGIORNAMENTO UI FINALE ---
    updatePredictionStatus();
    checkCircumference();
    render();


    localStorage.setItem('last_day_target', TGT_CAL);
    localStorage.setItem('last_day_bmr', BMR);
   
} // <--- CHIUDI QUI LA FUNZIONE CALC

    // --- RENDER UI CORRETTO ---
    function render() {
        const list = document.getElementById('list'); 
        if(list) list.innerHTML = '';
        
        let curCal=0, curC=0, curP=0, curF=0;
        
        // 1. Disegna Lista
        foods.slice().reverse().forEach((f, idx) => {
            curCal += f.k; curC += f.c; curP += f.p; curF += f.f;
            const li = document.createElement('li'); li.className = 'food-item';
            li.innerHTML = `<div class="food-info"><div class="food-name">${f.n}</div><div class="food-details">C:${f.c} P:${f.p} G:${f.f}</div></div><div class="food-actions"><span class="food-cal">${f.k}</span><button class="btn-del" onclick="rem(${foods.length - 1 - idx})">elimina</button></div>`;
            if(list) list.appendChild(li);
        });
    // SALVATAGGIO CONSUMO (PER NON RESETTARE LA SFIDA)
    localStorage.setItem('last_day_total_consumed', curCal); 
    localStorage.setItem('last_day_target', TGT_CAL);

        // 2. Calcoli Preliminari per Barra & Avvisi
        let diff = TGT_CAL - curCal;
        const remEl = document.getElementById('remCal');
        if(remEl) { remEl.innerText = diff; remEl.style.color = diff < 0 ? 'var(--danger)' : 'var(--text-main)'; }
        
        let pct = TGT_CAL > 0 ? Math.min((curCal / TGT_CAL) * 100, 100) : 0;
        let barColor = "var(--success)"; 
        let msgText = "‚úÖ Ottimo lavoro!"; // Default che sar√† sovrascritto
        let barTextColor = barColor; 
        
        const currentHour = new Date().getHours(); 
        const highRiskGoals = ['lose_athlete_15', 'lose_cons', 'recomp'];
        const isHighRisk = highRiskGoals.includes(state.goal);

        // --- LOGICA AVVISI CON PRIORIT√Ä ---
        if (curCal > TGT_CAL) {
            // 1. Sforato (PRIORIT√Ä MASSIMA)
            barColor = "var(--danger)";
            msgText = "‚õî Limite superato";
            barTextColor = barColor;
        } else if (curCal === 0) {
            // 2. Inizio Giornata (Neutro)
            msgText = "‚ö™ Inizia il tuo tracciamento!"; 
            barTextColor = 'var(--text-sec)';
            barColor = 'var(--success)';
        } else if (curCal >= TGT_CAL) {
             // 3. Condizione di Successo Totale (Target Raggiunto)
             msgText = "‚úÖ Obiettivo calorico giornaliero raggiunto!";
             barColor = "var(--success)";
             barTextColor = barColor;
        } else if (curCal > 0 && curCal < BMR) {
            // 4. BMR ALLARME UNIVERSALE (Sotto Basale, SEMPRE GIALLO se ci sono Kcal)
            barColor = "var(--warn)"; 
            msgText = "‚ö†Ô∏è Continua ad aggiungere per raggiungere il basale.";
            barTextColor = barColor;
        } else if (isHighRisk) {
            // 5. LOGICA ATLETA/RECOMP
            
            if (curCal >= TGT_MIN_KCAL) {
                // 5a. SOPRA IL MINIMO DI SICUREZZA -> VERDE (Obiettivo primario raggiunto)
                barColor = "var(--success)";
                msgText = "‚úÖ Ottimo Lavoro! Rischio Catabolismo ridotto."; // TUA FRASE
                barTextColor = barColor;
                
            } else if (currentHour >= 17 && curCal < TGT_MIN_KCAL) {
                // 5b. Rischio Catabolismo (Arancione) - SOLO DOPO LE 17:00 E SOTTO IL MINIMO
                barColor = "var(--orange)";
                msgText = `üö® Rischio Catabolismo<br><span style="display: block; font-weight: 700; opacity: 0.9;">(Sotto Minimo: ${TGT_MIN_KCAL} Kcal)</span>`;
                barTextColor = barColor;
            } else {
                // 5c. Giallo Precoce (Sotto TGT_MIN_KCAL, ma prima delle 17:00)
                barColor = "var(--warn)";
                msgText = `‚ö†Ô∏è Sei nel Deficit Ideale<br><span style="display: block; font-weight: 700; opacity: 0.9;">(Obiettivo Minimo: ${TGT_MIN_KCAL} Kcal)</span>`;
                barTextColor = barColor;
            }
        }

        // 6. Fallback Verde Finale (Ottimo Lavoro)
        // AGGIUNTA CONDIZIONE: Applica "Ottimo lavoro!" generico SOLO se il goal NON √® ad alto rischio,
        // per NON sovrascrivere il messaggio specifico del Punto 5a ("Rischio Catabolismo ridotto").
        if (barColor === "var(--success)" && curCal > 0 && !isHighRisk) {
            msgText = "‚úÖ Ottimo lavoro!"; 
            barTextColor = barColor;
        }

        // **********************************************
        // VISUALIZZAZIONE BARRA E MACRO
        // **********************************************
        const calBar = document.getElementById('calBar');
        if(calBar) { calBar.style.width = pct + "%"; calBar.style.background = barColor; }
        
        const stText = document.getElementById('statusText');
        if(stText) { stText.innerHTML = msgText; stText.style.color = barTextColor; } 
        
        setBar('carb', curC, TGT_C); setBar('prot', curP, TGT_P); setBar('fat', curF, TGT_F);


        // 3. Precisione
        const badge = document.getElementById('bullseyeBadge');
        if(badge) {
            let cardC='card-default', cardT='Inizia a loggare';
            if(diff < 0) { cardC='card-default'; cardT=`‚ùå SFORATO di ${Math.abs(diff)} Kcal`; }
            else if(diff<=50 && curCal>0) { cardC='card-gold'; cardT='ü•á ORO (Perfetto)'; }
            else if(diff<=100 && curCal>0) { cardC='card-silver'; cardT='ü•à ARGENTO (Ottima)'; }
            else if(diff<=200 && curCal>0) { cardC='card-bronze'; cardT='ü•â BRONZO (Buona)'; }
            else if(curCal>0) { cardC='card-default'; cardT='‚ö†Ô∏è INCOMPLETO'; }
            badge.className = `precision-card ${cardC}`; badge.innerText = cardT;
            let precLvl=0; if(cardC==='card-gold') precLvl=3; else if(cardC==='card-silver') precLvl=2; else if(cardC==='card-bronze') precLvl=1;
            localStorage.setItem('last_day_precision', precLvl);
            localStorage.setItem('last_day_total_consumed', curCal); 
        }

          // 4. Avvisi Proteine (Versione compatta con "minimi")
        const highProtGoals = ['lose_athlete_15', 'lose_cons', 'recomp'];
        const ptCheck = parseFloat(localStorage.getItem('pt_min_g')) || 0;
        let alertHTML = '';
        const proteinHour = new Date().getHours(); 

        if (highProtGoals.includes(state.goal) && ptCheck > 0 && curCal > 0) {
            // A. OBIETTIVO RAGGIUNTO (Verde - Compatto ed esplicativo)
            if (curP >= ptCheck) {
                alertHTML = `<div style="color:var(--success); font-size:0.8rem; font-weight:600; margin-top:10px; text-align: center;">‚úÖ Ottimo! Muscoli Protetti (${curP}g su ${ptCheck}g minimi).</div>`;
            }
            // B. OBIETTIVO MANCATO (Arancione - Solo dopo le 17:00)
            else if (proteinHour >= 17) {
                alertHTML = `<div style="color:var(--orange); font-size:0.8rem; font-weight:700; background:#fff5e6; padding:8px; border-radius:8px; margin-top:10px; border:1px solid var(--orange); text-align: center;">‚ö†Ô∏è **Attenzione Atleta!** Quota minima proteica (${ptCheck}g) non ancora raggiunta. Recupera a cena!</div>`;
            }
        }
        
        const protAlert = document.getElementById('protAlert');
        if(protAlert) protAlert.innerHTML = alertHTML;

                // ... (resto del codice sopra invariato)
        
        const cumDisplay = document.getElementById('cumulativeDisplay');
        if(cumDisplay) cumDisplay.innerText = (cumulativeDeficit / KCAL_PER_KG_FAT).toFixed(1) + " Kg";

                // --- AGGIORNAMENTO DINAMICO BARRA PROTEINE DASHBOARD ---
        const highProtGoalsRender = ['lose_athlete_15', 'lose_cons', 'recomp', 'gain'];
        if (highProtGoalsRender.includes(state.goal)) {
            const pDashBar = document.getElementById('protDashboardBar');
            const pDashTxt = document.getElementById('protDashboardTxt');
            
            // Usiamo PT_MIN_G come riferimento per il colore e TGT_P per il limite massimo
            let pPct = TGT_P > 0 ? Math.min((curP / TGT_P) * 100, 100) : 0;
            if(pDashBar) pDashBar.style.width = pPct + "%";
            if(pDashTxt) pDashTxt.innerText = `${curP}g / ${TGT_P}g`;

            if (curP >= PT_MIN_G) {
                // ZONA BLU (Sicura)
                pDashBar.style.backgroundColor = "#003a80"; 
                pDashTxt.style.color = "#003a80";
            } else {
                // ZONA GIALLA (Attenzione) - Forziamo il colore esadecimale
                pDashBar.style.backgroundColor = "#ff9500"; 
                pDashTxt.style.color = "#ff9500";
            }
        }

        // Aggiorna il numero nel tasto del salvadanaio
        const bankBtn = document.getElementById('bankDisplay');
        if (bankBtn) {
            bankBtn.innerText = Math.round(parseFloat(localStorage.getItem('calorie_bank')) || 0);
        }
// --- Trova questo punto dentro function render() ---

const isPremium = localStorage.getItem('app_premium_v1') === 'true';
const isRecoveryActive = localStorage.getItem('recovery_active_today') === 'true';
const bankVal = Math.round(getBankBalance());

const allButtons = document.getElementsByTagName('button');
for (let btn of allButtons) {
    if (btn.getAttribute('onclick') === 'useBankCalories()') {
        if (isRecoveryActive) {
            // EFFETTO GHIACCIO ‚ùÑÔ∏è
            btn.style.background = "rgba(179, 229, 252, 0.3)";
            btn.style.borderColor = "#81d4fa";
            btn.style.color = "#0288d1";
            btn.innerHTML = `<span>‚ùÑÔ∏è</span> SALVADANAIO FROZEN: <span id="bankDisplay">${bankVal}</span> kcal`;
        } else {
            // COLORE ORIGINALE (Arancio)
            btn.style.background = "rgba(255, 149, 0, 0.05)";
            btn.style.borderColor = "rgba(255, 149, 0, 0.4)";
            btn.style.color = "#ff9500";
            
            // Qui cambiamo l'icona in base a isPremium
            let icona = isPremium ? "üí∞" : "üîí";
            btn.innerHTML = `<span id="bankLockIcon">${icona}</span> SALVADANAIO: <span id="bankDisplay">${bankVal}</span> kcal`;
        }
    }
}

        return { curP: curP, curCal: curCal }; // Questa deve essere l'ULTIMA riga della funzione
    }


    function setBar(id, val, max) {
        document.getElementById(id+'Bar').style.width = Math.min((val/max)*100, 100) + "%";
        document.getElementById(id+'Txt').innerText = `${val} / ${max}g`;
    }

    // --- FUNZIONI LOGICHE EXTRA ---
            function checkCircumference() {
                // --- BLOCCO CONTROLLO PREMIUM ---
    const isPremium = localStorage.getItem('app_premium_v1') === 'true';
    const outputBox = document.getElementById('circAnalysis');

    if (!outputBox) return; 

    if (!isPremium) {
        outputBox.innerHTML = `<span style="color:#ff9500; font-weight:700; cursor:pointer;" onclick="window.open('https://www.pharmo.it', '_blank')">üîì ANALISI MISURE RISERVATA PRO</span><br><small>Sblocca il confronto centimetri settimanale.</small>`;
        return; // Ferma l'esecuzione qui per gli utenti base
    }
    // --------------------------------

        // 1. Recupera dati storici
        const oldAbd = parseFloat(localStorage.getItem('last_week_abd')) || 0;
        const oldCoscia = parseFloat(localStorage.getItem('last_week_coscia')) || 0;
        const oldBraccio = parseFloat(localStorage.getItem('last_week_braccio')) || 0;
        
        // 2. Recupera dati attuali
        const nowAbd = state.circ_abd;
        const nowCoscia = state.circ_coscia;
        const nowBraccio = state.circ_braccio;

        let parts = []; 
        let delay = 0; // Timer per non sovrapporre i messaggi

        // -------------------------------------------------------
        // A. CONTROLLO ADDOME
        // -------------------------------------------------------
        if (oldAbd > 0 && nowAbd > 0) {
            let diffAddome = nowAbd - oldAbd; 
            parts.push(`Addome: ${diffAddome > 0 ? '+' : ''}${diffAddome.toFixed(1)}`);
            
            if (appReady) {
                if (diffAddome <= -0.1) {
                    // DIMINUISCE: Pharmofiller (Elasticit√†)
                    setTimeout(() => showToast("‚úÖ Addome ridotto! Usa Pharmofiller per elasticit√† e tonicit√†."), delay);
                    delay += 10500; 
                } else if (diffAddome >= 0.1) {
                    // AUMENTA: Pharmolain (Gonfiore)
                    setTimeout(() => showToast("‚ö†Ô∏è Addome aumentato! Gonfiore? Usa Pharmolain."), delay);
                    delay += 10500;
                }
            }
        }

        // -------------------------------------------------------
        // B. CONTROLLO COSCIA
        // -------------------------------------------------------
        if (oldCoscia > 0 && nowCoscia > 0) {
            let diffCoscia = nowCoscia - oldCoscia;
            parts.push(`Coscia: ${diffCoscia > 0 ? '+' : ''}${diffCoscia.toFixed(1)}`);
            
            if (appReady) {
                if (diffCoscia <= -0.1) {
                    // DIMINUISCE: Pharmofiller (Elasticit√†)
                    setTimeout(() => showToast("‚úÖ Coscia pi√π snella! Usa Pharmofiller per elasticit√† e tonicit√†."), delay);
                    delay += 10500;
                } else if (diffCoscia >= 0.1) {
                    // AUMENTA: PharmoVen (Circolazione)
                    setTimeout(() => showToast("üö® Coscia aumentata! Problemi di circolazione? Usa PharmoVen."), delay);
                    delay += 10500;
                }
            }
        }

        // -------------------------------------------------------
        // C. CONTROLLO BRACCIO
        // -------------------------------------------------------
        if (oldBraccio > 0 && nowBraccio > 0) {
            let diffBraccio = nowBraccio - oldBraccio;
            parts.push(`Braccio: ${diffBraccio > 0 ? '+' : ''}${diffBraccio.toFixed(1)}`);
            
            if (appReady) {
                if (diffBraccio >= 0.1) {
                    // AUMENTA
                    if (['gain','recomp'].includes(state.goal)) {
                        // Se fai massa -> Bene
                        setTimeout(() => showToast("üí™ Braccio in crescita! Ottimo lavoro."), delay);
                    } else {
                        // Se vuoi dimagrire -> Male (Ritenzione) -> Pharmodren
                        setTimeout(() => showToast("üíß Braccio aumentato! Ritenzione idrica? Usa Pharmodren."), delay);
                    }
                } else if (diffBraccio <= -0.1) {
                    // DIMINUISCE: Pharmofiller (Elasticit√†)
                    setTimeout(() => showToast("‚úÖ Braccio definito! Usa Pharmofiller per elasticit√† e tonicit√†."), delay);
                }
            }
        }

        // -------------------------------------------------------
        // D. STAMPA A VIDEO NEL BOX
        // -------------------------------------------------------
   
        if (parts.length > 0) {
            outputBox.innerText = "Diff: " + parts.join(" | ") + " cm";
            outputBox.style.color = "#004494"; 
            outputBox.style.fontWeight = "600";
        } else {
            outputBox.innerText = "Aggiorna ogni 7 giorni per vedere le differenze.";
            outputBox.style.color = "#666";
            outputBox.style.fontWeight = "400";
        }
    }

            function updatePredictionStatus() {
    const statusBox = document.getElementById('predictionStatus');
    const dateDisplay = document.getElementById('projectedDateDisplay');
    const isPremium = localStorage.getItem('app_premium_v1') === 'true';

    // BLOCCO DI SICUREZZA: Se non √® PRO, ripristina il lucchetto e i testi originali
    if (!isPremium) {
        dateDisplay.innerHTML = "üîí PRO"; 
        statusBox.innerHTML = "Sblocca la <b>Data Traguardo</b> con la versione PRO su pharmo.it";
        statusBox.style.background = "white"; // Mantiene il tuo stile
        statusBox.style.color = "#555";
        return; // Ferma l'esecuzione qui
    }

    // --- DA QUI IN POI CALCOLI ORIGINALI (Solo se PRO) ---
    if (!state.targetW || state.w <= 0 || state.targetW === state.w) { 
        statusBox.innerHTML = "Inserisci Peso e Obiettivo nel Profilo ‚öôÔ∏è"; 
        dateDisplay.innerText = "-- / --";
        return; 
    }

    let dailyDiff = 0;
    let weightDiff = 0;
    let isWeightLoss = state.w > state.targetW;

    if (isWeightLoss) {
        dailyDiff = TDEE - TGT_CAL;
        weightDiff = state.w - state.targetW;
    } else {
        dailyDiff = TGT_CAL - TDEE;
        weightDiff = state.targetW - state.w;
    }

    if (dailyDiff < 100) {
        dateDisplay.innerText = "Piano Lento";
        dateDisplay.style.fontSize = "1.2rem";
        if (isWeightLoss) {
            statusBox.innerHTML = `‚ö†Ô∏è <b>Metabolismo Lento?</b><br>Il deficit √® minimo. Usa <b>Pharmofit</b> per alzare il dispendio calorico a riposo e velocizzare tutto.`;
        } else {
            statusBox.innerHTML = `‚ö†Ô∏è <b>Crescita Lenta.</b><br>Non stai mangiando abbastanza per mettere muscoli.`;
        }
        statusBox.style.background="#fff5e6"; statusBox.style.color="#b35900";
        return;
    }

    const totalKcalNeeded = weightDiff * 7700;
    const daysNeeded = Math.ceil(totalKcalNeeded / dailyDiff);
    const futureDate = new Date();
    futureDate.setDate(futureDate.getDate() + daysNeeded);
    
    const dateString = futureDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
    
    dateDisplay.innerText = dateString;
    dateDisplay.style.fontSize = "1.6rem";

    if (state.targetD) {
        const userTargetDate = new Date(state.targetD);
        userTargetDate.setHours(0,0,0,0);
        futureDate.setHours(0,0,0,0);

        if (futureDate <= userTargetDate) {
            statusBox.innerHTML = `‚úÖ <b>Ottimo! Arriverai in tempo.</b><br>Dimagrendo velocemente, la pelle potrebbe cedere. Usa <b>Pharmofiller</b> per mantenerla elastica e soda.`;
            statusBox.style.background="#d4edda"; statusBox.style.color="#155724";
        } else {
            statusBox.innerHTML = `‚ö†Ô∏è <b>Sei in ritardo sulla tabella!</b><br>Arriverai il ${dateString} invece che alla tua scadenza.<br><br>üöÄ <b>Strategia Recupero:</b><br>Combina <b>Pharmofit</b> (Brucia) + <b>Pharmodren</b> (Sgonfia) per accorciare i tempi.`;
            statusBox.style.background="#fff3cd"; statusBox.style.color="#856404";
        }
    } else {
        statusBox.innerHTML = "üí° Imposta una 'Data Obiettivo' nel profilo per vedere se sei in tempo.";
        statusBox.style.background="#eef7ff"; statusBox.style.color="#004494";
    }
}


        function rem(i) { 
        foods.splice(i, 1); 
        localStorage.setItem('foods_v3', JSON.stringify(foods)); // <--- RIGA AGGIUNTA
        render(); 
    }

    function resetAll() { if(confirm("Vuoi iniziare una nuova giornata?\n\nATTENZIONE: Se hai completato la giornata e superato le 4:00 AM, il deficit calorico di oggi √® gi√† stato salvato automaticamente. Se cancelli ora, perderai solo i dati inseriti dopo l'ultimo reset giornaliero.")) { foods=[]; localStorage.setItem('foods_v3', '[]'); waterCount=0; renderWater(); render(); } }
    
    // --- WATER ---
    function renderWater() {
        const g = document.getElementById('waterGrid'); g.innerHTML='';
        for(let i=0; i<8; i++) {
            let d=document.createElement('div'); d.className=`water-glass ${i<waterCount?'filled':(i===waterCount?'next-up':'')}`;
            d.onclick=()=>toggleWater(i); g.appendChild(d);
        }
        document.getElementById('waterCountDisplay').innerText = `${waterCount}/8`;
        localStorage.setItem('water_count', waterCount);
        
        // Calcolo visivo Streak
        let ws = parseInt(localStorage.getItem('water_streak_days')) || 0;
        // Se oggi ho vinto, mostro ws, altrimenti mostro ws + 1 (il giorno corrente che sto tentando)
        let displayDay = (localStorage.getItem('last_water_win_date') === todayStr) ? ws : ws + 1;
        
        let dayText = (waterCount === 8) ? "‚úÖ Obiettivo raggiunto!" : `üíß Sfida Drenante: Giorno ${displayDay} di 3`;
        document.getElementById('waterStatus').innerText = dayText;

        if(waterCount===8) {
             if(localStorage.getItem('last_water_win_date') !== todayStr) {
                 ws++;
                 localStorage.setItem('water_streak_days', ws);
                 localStorage.setItem('last_water_win_date', todayStr);
                 
                 if(ws >= 3 && !localStorage.getItem('water_reward_claimed')) {
                     document.getElementById('waterRewardModal').style.display='flex';
                 }
             }
        }
    }
    
    function toggleWater(i) {
        const currentTime = Date.now();
        const lastDrink = parseInt(localStorage.getItem('water_last_time')) || 0;
        const oneHour = 3600000; 

        if (i === waterCount) {
            // Check Timer (only if not first glass)
            if (waterCount > 0 && (currentTime - lastDrink < oneHour)) {
                let minLeft = Math.ceil((oneHour - (currentTime - lastDrink)) / 60000);
                showToast(`‚è≥ Aspetta ancora ${minLeft} min per la corretta idratazione.`);
                return;
            }
            waterCount++;
            localStorage.setItem('water_last_time', currentTime);
            showToast("Idratazione registrata! üíß");
            renderWater();
        } 
        // REMOVED "else if" block to prevent removing glasses
    }

    // --- INFO POPUPS ---
    function showPrecisionInfo() {
        const platinumStreak = parseInt(localStorage.getItem('platinum_streak')) || 0;
        const msg = `üèÜ SISTEMA CARTE PRECISIONE PHARMO üèÜ\n\nIl tuo obiettivo √® usare tutte le calorie (TGT CAL) a disposizione, senza sforare!\n\n**CRITERI GIORNALIERI (Precisione Massima):**\n   ‚Ä£ ORO ü•á:  Rimanere entro 50 Kcal dal Target (massimo deficit).\n   ‚Ä£ ARGENTO ü•à: Rimanere tra 51 Kcal e 100 Kcal dal Target.\n   ‚Ä£ BRONZO ü•â: Rimanere tra 101 Kcal e 200 Kcal dal Target.\n   \n   (Lasciare >200 Kcal o Sforare = Serie interrotta.)\n\n**RICONOSCIMENTO PLATINO (Costanza):**\nLa Carta Platino √® il traguardo massimo a lungo termine!\nSi sblocca mantenendo la **Carta ORO (Perfetto)** per 5 giorni consecutivi.\n\n   ‚Ä£ Stato attuale: ${platinumStreak} giorni consecutivi Oro.\n\nMantieni la serie Oro per sbloccare la **Serie Platino** al 5¬∞ giorno e ottenere vantaggi su pharmo.it!`;
        alert(msg);
    }

                            function showStreakInfo() {
        const streakCount = parseInt(localStorage.getItem('streak_days')) || 0; 
        const daysSince30Win = parseInt(localStorage.getItem('days_since_30_win')) || 0; 
        
                                        let rewardsDisplay = '--- Livelli Premiati (Vantaggi su pharmo.it) ---\n';
        
        // 1. Determina il codice massimo attivo (quello che DEVE essere mostrato)
        let maxCode = '';
        if (streakCount >= 30) {
            maxCode = 'PHARMO8756'; // CORRETTO (30 giorni)
        } else if (streakCount >= 14) {
            maxCode = 'PHARMO6598'; // CORRETTO (14 giorni)
        } else if (streakCount >= 7) {
            maxCode = 'PHARMO1100'; // CORRETTO (7 giorni)
        }

        // 2. Tracciamento 7 Giorni: Mostra il codice solo se √® l'attivo
        let display7 = (maxCode === 'PHARMO1100') ? maxCode : 'Sbloccato';
        if (streakCount >= 7) {
            rewardsDisplay += `‚úÖ 7 Giorni: ${display7}\n`;
        } else {
            rewardsDisplay += 'üéØ 7 Giorni: Prossimo Obiettivo\n';
        }
        
        // 3. Tracciamento 14 Giorni: Mostra il codice solo se √® l'attivo
        let display14 = (maxCode === 'PHARMO6598') ? maxCode : 'Sbloccato';
        if (streakCount >= 14) {
            rewardsDisplay += `‚úÖ 14 Giorni: ${display14}\n`;
        } else {
            rewardsDisplay += 'üéØ 14 Giorni: Prossimo Obiettivo\n';
        }
        
        // 4. Tracciamento 30 Giorni: Mostra il codice solo se √® l'attivo
        let display30 = (maxCode === 'PHARMO8756') ? maxCode : 'Sbloccato';
        if (streakCount >= 30) {
            rewardsDisplay += `‚úÖ 30 Giorni: ${display30}\n`;
        } else {
            rewardsDisplay += 'üéØ 30 Giorni: Prossimo Obiettivo\n';
        }


        // Aggiungi il timer di scadenza (appare solo tra giorno 30 e 33)
        let timerDisplay = '';
        if (daysSince30Win > 0 && daysSince30Win <= 3) {
            const daysLeft = 4 - daysSince30Win;
            timerDisplay = `\n\nüö® ATTENZIONE: La serie scadr√† tra ${daysLeft} giorno/i. Dopo, la sfida ricomincer√†!`;
        }

        const msg = `üî• SFIDA PHARMO - STATO SERIE üî•

Il tuo obiettivo √® completare l'utilizzo giornaliero raggiungendo almeno il **Metabolismo Basale (BMR)**.

Stato attuale: ${streakCount} giorni consecutivi di successo.
----------------------------------------------------

${rewardsDisplay}
${timerDisplay}

----------------------------------------------------
üí° IMPORTANTE: La serie si interrompe **solo se non raggiungi il Metabolismo Basale (BMR)** nel corso della giornata precedente. \n ‚ö†Ô∏è Attenzione: i codici cambiano regolarmente. Assicurati di usarli subito appena ottenuti! `;

        // Mostra l'alert principale della Sfida
        alert(msg);
        
        // MOSTRA L'AVVISO DEL PESO SEPARATAMENTE
        alert("‚ö†Ô∏è PROMEMORIA IMPORTANTE\n\nRicordati di aggiornare il tuo Peso Attuale e le tue Circonferenze nel profilo ogni 7 giorni per mantenere l'analisi previsionale accurata.");
    }


                            function checkSmartAdvice(n, k, c, p, f, max) {
    let currentDelay = 0;
    const durataMessaggio = 10500; 

    if (f > 20) {
        setTimeout(() => showToast("üçî Pasto ricco di grassi? Pharmolain aiuta la tua digestione."), currentDelay);
        currentDelay += durataMessaggio; 
    } 
    
    const cibiSalati = ["pizza", "sushi", "hamburger", "patatine", "salam", "focaccia", "piadina"];
    if (cibiSalati.some(cibo => n.toLowerCase().includes(cibo))) {
        setTimeout(() => showToast("üßÇ Pasto sapido? Domani mattina Pharmodren per eliminare i liquidi!"), currentDelay);
        currentDelay += durataMessaggio;
    }

    if (p > 25) {
        setTimeout(() => showToast("üí™ Ottimo carico proteico! Se ti senti appesantito, Pharmolain aiuta la digestione."), currentDelay);
        currentDelay += durataMessaggio;
    }

    if (c > 40) {
        setTimeout(() => showToast("üçû Carboidrati alti? Pharmofit prima del pasto √® l'ideale!"), currentDelay);
        currentDelay += durataMessaggio;
    }
    
    return currentDelay; // <--- FONDAMENTALE: restituisce il tempo totale
}


function checkTimeAdvice(currentProtein) {
    const hour = new Date().getHours();
    const currentPTMinG = parseFloat(localStorage.getItem('pt_min_g')) || 0;

    if (hour >= 6 && hour < 11) {
        showToast("Buongiorno! Attiva il metabolismo con Pharmofit.");
    } else if (hour >= 12 && hour < 15) {
        showToast("Pranzo proteico? Pharmolain aiuta la digestione.");
    } else if (hour >= 20 && hour <= 22) { 
        if (currentPTMinG > 0 && currentProtein < currentPTMinG) {
            let diff = Math.round(currentPTMinG - currentProtein);
            showToast(`‚ö†Ô∏è SOS Proteine! Mancano ${diff}g per proteggere la massa muscolare oggi. Recupera subito!`);
        } else {
             showToast("La pelle si rigenera di notte. Usa Pharmofiller.");
        }
    }
}
function getProtocolToast() {
    const activeProt = localStorage.getItem('active_protocol_v1');
    const day = new Date().getDay();
    // Messaggi per il Metodo Shock
    if (activeProt === 'shock') {
        if (day >= 1 && day <= 5) return "üåä Giorno Light: Carboidrati bassi per attivare la lipolisi.";
        else return "üöÄ Giorno Boost: Carboidrati alti per il metabolismo!";
    }
    return null;
}
    // --- INIT ---
    // --- BLOCCO DI AVVIO UNIFICATO E CORRETTO PER SALVATAGGIO DATI ---
window.addEventListener('DOMContentLoaded', () => {
    
    // 1. Recupero immediato del profilo dal database locale
    const savedProfile = localStorage.getItem('profile_v3');
    if (savedProfile) {
        state = JSON.parse(savedProfile);
    }

    // 2. SCRIVI I DATI NEGLI INPUT (Prima di calcolare!)
    const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el && val !== undefined && val !== null) el.value = val;
    };

    if (state) {
        setVal('gender', state.g);
        setVal('age', state.age);
        setVal('weight', state.w);
        setVal('height', state.h);
        setVal('act', state.act);
        setVal('goal', state.goal);
        setVal('targetWeightInput', state.targetW || '');
        setVal('targetDateInput', state.targetD || '');
        setVal('circ_abd', state.circ_abd || '');
        setVal('circ_coscia', state.circ_coscia || '');
        setVal('circ_braccio', state.circ_braccio || '');
    }

    // 3. ESEGUI I CALCOLI (Ora che i campi sono pieni)
    calc(); 
    renderFavSelect();
    renderWater();
    const finalTotals = render(); 

    // 4. Gestione Badge Serie (Streak)
    const actualStreak = parseInt(localStorage.getItem('streak_days')) || 1;
    const badge = document.getElementById('streakDisplay');
    if (badge) {
        let target = (actualStreak > 14) ? 30 : (actualStreak > 7 ? 14 : 7);
        badge.classList.remove('streak-platinum', 'streak-gold'); 
        if (actualStreak === 7 || actualStreak === 14 || actualStreak >= 30) {
            badge.classList.add('streak-gold', 'streak-platinum');
        }
        badge.innerText = "üî• " + actualStreak + "/" + target;
    }

    // 5. Gestione Accesso & Premium
    handleAuth(); 
    checkPremiumStatus();

    // 6. Ripristino Protocollo
    const savedProt = localStorage.getItem('active_protocol_v1');
    if (savedProt && savedProt !== 'none' && localStorage.getItem('app_premium_v1') === 'true') {
        const sel = document.getElementById('advProtocol');
        if(sel) {
            sel.value = savedProt;
            updateProtocolDesc(); 
        }
    }

    // 7. Disclaimer & Consigli Tempo
    if (localStorage.getItem('terms_accepted_v1') !== 'true') {      
        if (document.getElementById('disclaimerModal')) document.getElementById('disclaimerModal').style.display = 'flex';
    } else {
        checkTimeAdvice(finalTotals.curP); 
        if (localStorage.getItem('app_premium_v1') === 'true') {
            const protocolMsg = getProtocolToast();
            if (protocolMsg) setTimeout(() => showToast(protocolMsg), 4000); 
        }
    }

    // 8. Gestione Digiuno
    const fMode = document.getElementById('fastingMode');
    const fStart = document.getElementById('fastingStart');
    if (fMode) fMode.value = localStorage.getItem('fasting_mode') || 'none';
    if (fStart) fStart.value = localStorage.getItem('fasting_start') || '13:00';
    updateFastingUI();
updateSugarUI();
    appReady = true; 
});
// --- FUNZIONE REPORT SETTIMANALE GRAFICO ---
function showWeeklyReport(manualBank) {
    // 1. Controlla se PRO
    const isPremium = localStorage.getItem('app_premium_v1') === 'true';
    if (!isPremium) {
        alert("üîí FUNZIONE PRO\n\nIl Report Grafico Settimanale √® riservato ai membri Gold/Platinum.");
        return;
    }

    // 2. Prendi i dati (o usa quelli simulati dal test)
    let bank = manualBank || parseFloat(localStorage.getItem('calorie_bank')) || 0;
    
    // 3. Calcoli (Stima grasso: 7700kcal = 1kg)
    let fatLost = Math.round((bank / 7700) * 1000); // in grammi
    if (fatLost < 0) fatLost = 0;

    // 4. Aggiorna HTML
    document.getElementById('repCal').innerText = Math.round(bank);
    document.getElementById('repFat').innerText = fatLost;

    // 5. Configura tasto WhatsApp
    let msg = `üìä *IL MIO REPORT PHARMO*\n\nüî• Ho risparmiato: ${Math.round(bank)} kcal\n‚öñÔ∏è Grasso stimato perso: -${fatLost}g\n\nüöÄ Unisciti alla sfida su pharmo.it!`;
    document.getElementById('btnShareWa').setAttribute('onclick', `window.open('https://wa.me/?text=${encodeURIComponent(msg)}', '_blank')`);

    // 6. Mostra il Modal
    document.getElementById('weeklyReportModal').style.display = 'flex';
}
// --- FUNZIONI BACKUP SEMPLIFICATO ---

function openBackupUI() {
    // 1. Controllo PRO
    if (localStorage.getItem('app_premium_v1') !== 'true') {
        alert("üîí FUNZIONE PHARMOCLOUD\n\nIl salvataggio dati √® riservato ai membri PRO/GOLD.\n\nSbloccalo per non perdere mai i tuoi progressi!");
        return;
    }
    // 2. Apre Finestra
    document.getElementById('simpleBackupModal').style.display = 'flex';
    updateSugarFieldStatus()
}
function updateSugarUI() {
    const isVIP = localStorage.getItem('app_vip_v1') === 'true';
    const isPRO = localStorage.getItem('app_premium_v1') === 'true';
    const input = document.getElementById('inSugar');
    const badge = document.getElementById('sugarBadge');
    const label = document.getElementById('sugarLabel');

    if (isVIP) {
        // --- LIVELLO VIP: TUTTO APERTO ---
        input.style.filter = "none";
        label.style.filter = "none";
        label.innerText = "üç¨ DI CUI ZUCCHERI (g)";
        input.style.background = "#fff";
        input.placeholder = "g";
        badge.innerText = "üíé VIP ACCESS";
        badge.style.background = "#e3f2fd";
        badge.style.color = "#1976d2";
        input.readOnly = false;
    } 
    else if (isPRO) {
        // --- LIVELLO PRO: VEDE MA NON TOCCA ---
        input.style.filter = "none";
        label.style.filter = "none";
        label.innerText = "üç¨ DI CUI ZUCCHERI (g)";
        input.style.background = "#f5f5f5";
        input.placeholder = "üîí VIP";
        badge.innerText = "‚≠ê GOLD (Solo Vista)";
        badge.style.background = "#fff8e1";
        badge.style.color = "#ffa000";
        input.readOnly = true;
    } 
    else {
        // --- LIVELLO FREE: SFOCATO (BLUR) ---
        input.style.filter = "blur(5px)";
        label.style.filter = "blur(5px)";
        label.innerText = "üîí BLOCCATO"; 
        input.style.background = "#eee";
        badge.innerText = "üîí BLOCCATO";
        badge.style.background = "#f5f5f5";
        badge.style.color = "#999";
        input.readOnly = true;
    }
}


function exportDataSimple() {
    try {
        // Prende tutto il database
        const data = JSON.stringify(localStorage);
        // Lo converte in un codice sicuro (Base64) per evitare errori di copia
        const secureCode = btoa(unescape(encodeURIComponent(data)));
        
        // Copia negli appunti
        const tempInput = document.createElement("textarea");
        tempInput.value = secureCode;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);

        showToast("‚úÖ Codice Copiato! Incollalo dove vuoi.");
        alert("‚úÖ COPIA RIUSCITA!\n\nIl tuo 'Codice di Salvataggio' √® ora negli appunti.\n\nüëâ Vai sulle Note o su WhatsApp e fai 'Incolla' per salvarlo al sicuro.");
    } catch (e) {
        alert("Errore durante il salvataggio. Riprova.");
    }
}

function importDataSimple() {
    // Chiede il codice all'utente
    const inputCode = prompt("Incolla qui il tuo Codice di Salvataggio:");
    
    if (inputCode) {
        try {
            // Decodifica il codice
            const jsonString = decodeURIComponent(escape(atob(inputCode)));
            const data = JSON.parse(jsonString);

            // Conferma finale (perch√© cancella i dati attuali)
            if(confirm("‚ö†Ô∏è ATTENZIONE: Stai per sovrascrivere i dati attuali con quelli del backup.\n\nL'operazione √® irreversibile. Continuare?")) {
                localStorage.clear(); // Pulisce
                
                // Ricarica i vecchi dati
                Object.keys(data).forEach(key => {
                    localStorage.setItem(key, data[key]);
                });

                alert("‚úÖ RIPRISTINO COMPLETATO!\nBentornato/a. L'app si riavvier√† ora.");
                location.reload();
            }
        } catch (e) {
            alert("‚ùå CODICE NON VALIDO\n\nSembra che il codice incollato sia incompleto o errato. Riprova.");
        }
    }
}
// --- DATABASE CONSIGLI COACH (ROTAZIONE) ---
const tipsDB = {
    fat: [
        "üî¥ <b>Allarme Grassi:</b> Hai superato il limite lipidico. Questo crea infiammazione silenziosa.<br>üëâ <i>Rimedio:</i> Stasera usa <b>Pharmodren</b> per drenare le tossine.",
        "üî¥ <b>Troppi Lipidi:</b> La digestione rallenter√† drasticamente.<br>üëâ <i>Consiglio:</i> Bevi 2 bicchieri d'acqua subito e niente carboidrati a cena.",
        "üî¥ <b>Attenzione alle Calorie Nascoste:</b> L'olio √® il nemico invisibile di oggi.<br>üëâ <i>Azione:</i> Domani usa lo spray per condire o misura col cucchiaino.",
        "üî¥ <b>Reset Necessario:</b> L'eccesso di grassi blocca il dimagrimento.<br>üëâ <i>Soluzione:</i> Domani fai una giornata Low-Fat per compensare."
    ],
    carb: [
        "üü† <b>Picco Glicemico:</b> Troppi carboidrati oggi. Rischio accumulo adiposo immediato.<br>üëâ <i>Rimedio:</i> Assumi <b>Pharmofit</b> prima del prossimo pasto per bloccare l'assorbimento.",
        "üü† <b>Insulina Alta:</b> Il tuo corpo ha smesso di bruciare grassi.<br>üëâ <i>Azione:</i> Fai una camminata veloce di 15 min dopo cena per abbassare la glicemia.",
        "üü† <b>Carbo-Load Eccessivo:</b> Se non ti alleni domani, questi zuccheri diventeranno grasso.<br>üëâ <i>Consiglio:</i> Taglia la frutta e il pane per le prossime 12 ore.",
        "üü† <b>Stop Zuccheri:</b> Hai saturato le riserve di glicogeno.<br>üëâ <i>Soluzione:</i> Prossimo pasto solo Proteine e Verdure verdi."
    ],
    prot: [
        "üü° <b>Carenza Proteica:</b> Sei sotto la soglia di protezione muscolare.<br>üëâ <i>Consiglio:</i> Aggiungi uno shake proteico o 200g di albumi subito.",
        "üü° <b>Rischio Catabolismo:</b> Stai perdendo peso, ma potrebbe essere muscolo!<br>üëâ <i>Azione:</i> Recupera con uno yogurt greco o fiocchi di latte pre-nanna.",
        "üü° <b>Fame Nervosa?</b> La mancanza di proteine causa attacchi di fame.<br>üëâ <i>Soluzione:</i> Mangia un pezzo di parmigiano o affettato magro ora."
    ],
    perfect: [
        "‚úÖ <b>Giornata Perfetta!</b><br>I macro sono in armonia. Il metabolismo lavora al 100%.",
        "‚úÖ <b>Ottimo Lavoro!</b><br>Hai nutrito il muscolo senza ingrassare. Continua cos√¨!",
        "‚úÖ <b>Bilanciamento Top.</b><br>Sei un cecchino. Il tuo corpo ti ringrazier√† domani mattina."
    ]
};

function getRandomTip(category) {
    const list = tipsDB[category];
    return list[Math.floor(Math.random() * list.length)];
}
function updateSugarFieldStatus() {
    const isVIP = localStorage.getItem('app_vip_v1') === 'true';
    const isPRO = localStorage.getItem('app_premium_v1') === 'true';
    const sugarInput = document.getElementById('inSugar');
    const sugarBadge = document.getElementById('sugarBadge');
    const container = document.getElementById('sugarContainer');

    if (isVIP) {
        // --- LIVELLO VIP: PIENO ACCESSO ---
        sugarInput.style.filter = "none";
        sugarInput.style.background = "#fff";
        sugarInput.placeholder = "Inserisci g";
        sugarBadge.innerText = "üíé VIP ACCESS";
        sugarBadge.style.background = "#e3f2fd";
        sugarBadge.style.color = "#1976d2";
        sugarInput.readOnly = false;
    } 
    else if (isPRO) {
        // --- LIVELLO PRO: VEDE MA √à BLOCCATO ---
        sugarInput.style.filter = "none"; // Non sfocato
        sugarInput.style.background = "#f9f9f9";
        sugarInput.placeholder = "üîí BLOCCATO";
        sugarBadge.innerText = "‚≠ê GOLD (Solo Vista)";
        sugarBadge.style.background = "#fff8e1";
        sugarBadge.style.color = "#ffa000";
        sugarInput.readOnly = true;
    } 
    else {
        // --- LIVELLO FREE: SFOCATO E MISTERIOSO ---
        sugarInput.style.filter = "blur(4px)";
        sugarInput.style.background = "#eee";
        sugarInput.placeholder = "";
        sugarBadge.innerText = "üîí BLOCCATO";
        sugarInput.readOnly = true;
    }
}

// Gestione del Popup al click
function handleSugarClick() {
    const isVIP = localStorage.getItem('app_vip_v1') === 'true';
    const isPRO = localStorage.getItem('app_premium_v1') === 'true';

    if (isVIP) return; // Se √® VIP non fare nulla, lascia scrivere

    if (isPRO) {
        alert("üíé FUNZIONE PLATINUM (VIP)\n\nSei un membro Gold, ma l'analisi dell'impatto insulinico degli zuccheri √® riservata allo status VIP.\n\nSblocca il livello Platinum per attivare il calcolo dell'Infiammazione Cellulare!");
    } else {
        alert("üîí FUNZIONE RISERVATA\n\nIl monitoraggio di questo parametro √® fondamentale per non bloccare la lipolisi.\n\nQuesta funzione √® disponibile solo per i membri PRO e VIP.");
    }
}

// --- FUNZIONE 1: COACH AI 2.0 (PRO) ---
function openCoach() {
    if (localStorage.getItem('app_premium_v1') !== 'true') {
        alert("üîí COACH AI PRO\nAnalisi avanzata della composizione corporea riservata ai membri Gold.");
        return;
    }

        const isVIP = localStorage.getItem('app_vip_v1') === 'true';
    const fVal = parseInt(document.getElementById('fatTxt').innerText) || 0;
    const pVal = parseInt(document.getElementById('protTxt').innerText) || 0;
    const cVal = parseInt(document.getElementById('carbTxt').innerText) || 0;

    // --- CORRETTO COSI ---
    let curS = 0; 
    foods.forEach(f => {
        curS += (f.s || 0); 
    });
    // ---------------------

    const ptMin = parseFloat(localStorage.getItem('pt_min_g')) || 0;
    const hour = new Date().getHours();
    const consumed = parseFloat(localStorage.getItem('last_day_total_consumed')) || 0;


    let score = 100;
    let advice = "";

    // --- LOGICA VIP: IL COACH DIVENTA SPIETATO (BIO-HACKING) ---
    if (isVIP) {
        // 1. Errore Timing Carboidrati Notturni (Blocco GH)
        if (hour >= 20 && cVal > (TGT_C * 0.5)) {
            score -= 40;
            advice = "üåô <b>DISASTRO ORMONALE:</b> Hai caricato troppi carboidrati stasera. Questo picco insulinico bloccher√† totalmente il GH notturno. Non brucerai grasso mentre dormi.<br>üëâ <i>Rimedio:</i> Domani mattina <b>Pharmodren</b> a stomaco vuoto per drenare i liquidi ritenvuti.";
        }
        // 2. Mix Infiammazione (Grassi + Carbo alti)
        else if (fVal > (TGT_F * 0.8) && cVal > (TGT_C * 0.8)) {
            score -= 35;
            advice = "üö® <b>MIX INFIAMMATORIO:</b> Grassi e Carboidrati alti contemporaneamente. √à il modo pi√π veloce per sporcare la forma fisica e infiammare i tessuti.<br>üëâ <i>Azione:</i> Prendi subito <b>Pharmolain</b> per processare l'eccesso e ridurre il gonfiore.";
        }
        // 3. Blocco Lipolisi Mattutina
        else if (hour < 11 && cVal > 30) {
            score -= 20;
            advice = "üî• <b>LIPOLISI INTERROTTA:</b> Hai inserito troppi zuccheri quando il cortisolo era alto. Hai spento la tua fornace naturale.<br>üëâ <i>Prossima volta:</i> Usa <b>Pharmofit</b> prima di colazione per gestire meglio questo picco.";
        }
    } 

    // --- SE NON √à VIP O SE I CONTROLLI VIP SONO PASSATI, USA LOGICA STANDARD ---
    if (advice === "") {
        if (cVal > (pVal * 2.5) && cVal > 50) {
            score -= 25;
            advice = "‚ö†Ô∏è <b>Sbilanciamento Glicemico:</b> Troppi carboidrati rispetto alle proteine. Rischi accumulo adiposo.<br>üëâ <i>Rimedia:</i> Prossimo pasto solo proteine magre.";
        } 
        else if (pVal < (ptMin * 0.5) && hour > 15) {
            score -= 20;
            advice = "üìâ <b>Allarme Catabolismo:</b> Proteine troppo basse per proteggere i tuoi muscoli.<br>üëâ <i>Azione:</i> Inserisci subito uno spuntino proteico o albumi.";
        }
        else if (consumed > 0) {
            advice = getRandomTip('perfect');
            if (!isVIP) {
    advice += "<br><br>üíé <b>UPGRADE PLATINUM:</b> Sblocca l'analisi del <i>Bio-Timing</i>. Il Coach analizzer√† l'orario dei tuoi pasti per dirti se stai bloccando il GH notturno o la Lipolisi mattutina.";
}
        } else {
            advice = "‚òï Inizia a loggare i tuoi pasti per ricevere l'analisi del Coach!";
        }
    }

    // Calcolo Voto (Stessi parametri tuoi)
    let grade = "A"; let color = "#34c759"; let sub = "Eccellente";
    if (score < 90) { grade = "B"; color = "#ffcc00"; sub = "Buono"; }
    if (score < 75) { grade = "C"; color = "#ff9500"; sub = "Migliorabile"; }
    if (score < 60) { grade = "D"; color = "#ff3b30"; sub = "Incoerente"; }

    document.getElementById('coachGrade').innerText = grade;
    document.getElementById('coachGrade').style.color = color;
    document.getElementById('coachSubtitle').innerText = sub;
    document.getElementById('coachTipsBox').innerHTML = advice;
    document.getElementById('coachModal').style.display = 'flex';
}


// --- FUNZIONE 2: CRONO-GENETICA 2.0 (VIP) ---
function openCrono() {
    if (localStorage.getItem('app_vip_v1') !== 'true') {
        alert("üíé FUNZIONE BIO-TIMING\n\nIl bio-hacking temporale √® riservato ai membri PLATINUM/VIP.");
        return;
    }
    renderCronoTimeline();
    document.getElementById('cronoModal').style.display = 'flex';
}

function renderCronoTimeline() {
    const timeStr = document.getElementById('wakeUpTime').value;
    const [h, m] = timeStr.split(':').map(Number);
    const wakeMins = h * 60 + m;
    const oraAttuale = new Date();
    const minutiAdesso = oraAttuale.getHours() * 60 + oraAttuale.getMinutes();

    const addTime = (mins) => {
        let tot = wakeMins + mins;
        let nh = Math.floor(tot / 60) % 24;
        let nm = tot % 60;
        return { string: `${nh.toString().padStart(2,'0')}:${nm.toString().padStart(2,'0')}`, totalMins: tot % 1440 };
    };

    const phase1 = addTime(30); const phase2 = addTime(300); const phase3 = addTime(720);

    const getActiveStyle = (start, end) => {
        let active = (end > start) ? (minutiAdesso >= start && minutiAdesso < end) : (minutiAdesso >= start || minutiAdesso < end);
        return active ? "background: rgba(255,255,255,0.07); border-radius:12px; padding:15px; border-left-width: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);" : "opacity: 0.5; padding: 10px 15px;";
    };

    const tC = cronoDB.cortisolo[Math.floor(Math.random() * cronoDB.cortisolo.length)];
    const tI = cronoDB.insulina[Math.floor(Math.random() * cronoDB.insulina.length)];
    const tG = cronoDB.gh[Math.floor(Math.random() * cronoDB.gh.length)];

    const html = `
        <div style="border-left: 2px solid #ff3b30; margin-bottom: 25px; position:relative; transition:0.3s; ${getActiveStyle(phase1.totalMins, phase2.totalMins)}">
            <div style="position:absolute; left:-7px; top:15px; width:12px; height:12px; background:#ff3b30; border-radius:50%; box-shadow: 0 0 12px #ff3b30;"></div>
            <div style="font-size:1rem; color:#ff3b30; font-weight:800; display:flex; align-items:center; gap:8px;">
                <span>üî•</span> ${phase1.string} ‚Ä¢ CORTISOLO
            </div>
            <div style="font-size:0.85rem; color:#ccc; margin-top:8px; line-height:1.4;">
                ${tC}<br>
                <span style="color:#ff3b30; font-weight:700;">‚õî NO ZUCCHERI.</span>
            </div>
        </div>

        <div style="border-left: 2px solid #FFD700; margin-bottom: 25px; position:relative; transition:0.3s; ${getActiveStyle(phase2.totalMins, phase3.totalMins)}">
            <div style="position:absolute; left:-7px; top:15px; width:12px; height:12px; background:#FFD700; border-radius:50%; box-shadow: 0 0 12px #FFD700;"></div>
            <div style="font-size:1rem; color:#FFD700; font-weight:800; display:flex; align-items:center; gap:8px;">
                <span>üçö</span> ${phase2.string} ‚Ä¢ INSULINA
            </div>
            <div style="font-size:0.85rem; color:#ccc; margin-top:8px; line-height:1.4;">
                ${tI}<br>
                <span style="color:#FFD700; font-weight:700;">‚úÖ FOCUS: Carboidrati complessi.</span>
            </div>
        </div>

        <div style="border-left: 2px solid #00d4ff; position:relative; transition:0.3s; ${getActiveStyle(phase3.totalMins, phase1.totalMins)}">
            <div style="position:absolute; left:-7px; top:15px; width:12px; height:12px; background:#00d4ff; border-radius:50%; box-shadow: 0 0 12px #00d4ff;"></div>
            <div style="font-size:1rem; color:#00d4ff; font-weight:800; display:flex; align-items:center; gap:8px;">
                <span>üåô</span> ${phase3.string} ‚Ä¢ FASE GH
            </div>
            <div style="font-size:0.85rem; color:#ccc; margin-top:8px; line-height:1.4;">
                ${tG}<br>
                <span style="color:#00d4ff; font-weight:700;">‚õî STOP CARBOIDRATI.</span>
            </div>
        </div>
    `;

    document.getElementById('cronoTimeline').innerHTML = html;
}

function setWakeUpNow() {
    const ora = new Date();
    const h = ora.getHours().toString().padStart(2, '0');
    const m = ora.getMinutes().toString().padStart(2, '0');
    
    document.getElementById('wakeUpTime').value = `${h}:${m}`;
    
    // Feedback visivo
    showToast("‚úÖ Sveglia impostata alle " + h + ":" + m);
    
    // Ricalcola tutto
    renderCronoTimeline();
}

</script>

<div id="weeklyReportModal" class="modal-overlay" style="display:none; z-index:100000;">
    <div class="modal-box" style="background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%); border-radius: 24px; padding: 0; overflow: hidden; max-width: 340px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
        
        <div style="background: linear-gradient(135deg, #007aff 0%, #0056b3 100%); padding: 25px 20px; text-align: center; color: white;">
            <div style="font-size: 3rem; margin-bottom: 5px;">üìä</div>
            <h2 style="margin:0; font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px;">REPORT SETTIMANALE</h2>
            <p style="margin:5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">La tua settimana in numeri</p>
        </div>

        <div style="padding: 25px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                
                <div style="background: #fff; padding: 15px; border-radius: 16px; border: 1px solid #e1e4e8; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
                    <div style="font-size: 0.8rem; color: #666; font-weight: 600; text-transform: uppercase;">Risparmio</div>
                    <div style="font-size: 1.3rem; color: #007aff; font-weight: 800; margin-top: 5px;">
                        <span id="repCal">0</span> <span style="font-size:0.8rem;">kcal</span>
                    </div>
                </div>

                <div style="background: #fff; padding: 15px; border-radius: 16px; border: 1px solid #e1e4e8; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
                    <div style="font-size: 0.8rem; color: #666; font-weight: 600; text-transform: uppercase;">Grasso Perso</div>
                    <div style="font-size: 1.3rem; color: #ff9500; font-weight: 800; margin-top: 5px;">
                        -<span id="repFat">0</span> <span style="font-size:0.8rem;">g</span>
                    </div>
                </div>
            </div>

            <p style="text-align: center; color: #444; font-size: 0.9rem; line-height: 1.5; margin-bottom: 25px;">
                Ottimo lavoro! Hai trasformato il tuo deficit calorico in risultati reali. Continua cos√¨! üöÄ
            </p>

            <button id="btnShareWa" onclick="" 
                style="width: 100%; background: #25D366; color: white; border: none; padding: 14px; border-radius: 14px; font-weight: 700; font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);">
                <i class="fab fa-whatsapp"></i> Condividi Risultati
            </button>
            
            <button onclick="document.getElementById('weeklyReportModal').style.display='none'" 
                style="width: 100%; background: transparent; color: #888; border: none; padding: 10px; font-weight: 600; cursor: pointer;">
                Chiudi
            </button>
        </div>
    </div>
</div>
<div id="simpleBackupModal" class="modal-overlay" style="display:none; z-index:100000;">
    <div class="modal-box" style="text-align: center;">
        <div class="modal-title" style="color:#007aff; font-size:1.3rem;">‚òÅÔ∏è PharmoCloud</div>
        <p style="font-size:0.9rem; color:#555; margin-bottom:20px;">
            Salva la tua configurazione e i tuoi progressi al sicuro, oppure trasferiscili su un altro telefono.
        </p>

        <div style="background:#f0f4f8; padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid #dbeafe;">
            <div style="font-size:0.8rem; font-weight:700; color:#004494; margin-bottom:8px; text-transform:uppercase;">1. Salva i tuoi dati</div>
            <button onclick="exportDataSimple()" style="width:100%; background:#007aff; color:white; border:none; padding:12px; border-radius:10px; font-weight:bold; font-size:0.95rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                üìã Copia Codice di Salvataggio
            </button>
            <div style="font-size:0.7rem; color:#888; margin-top:5px;">Clicca, poi incollalo nelle Note o su WhatsApp.</div>
        </div>

        <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin:15px 0; opacity:0.3;">
            <div style="height:1px; background:#000; flex:1;"></div>
            <span style="font-size:0.8rem;">OPPURE</span>
            <div style="height:1px; background:#000; flex:1;"></div>
        </div>

        <div style="background:#f9fff9; padding:15px; border-radius:12px; border:1px solid #c3e6cb;">
            <div style="font-size:0.8rem; font-weight:700; color:#155724; margin-bottom:8px; text-transform:uppercase;">2. Recupera i dati</div>
            <button onclick="importDataSimple()" style="width:100%; background:#34c759; color:white; border:none; padding:12px; border-radius:10px; font-weight:bold; font-size:0.95rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                üì• Incolla e Ripristina
            </button>
        </div>

        <button onclick="document.getElementById('simpleBackupModal').style.display='none'" style="margin-top:20px; background:transparent; color:#888; border:none; width:100%; padding:10px; cursor:pointer;">Chiudi</button>
    </div>
</div>
<div id="coachModal" class="modal-overlay" style="display:none; z-index:100000;">
    <div class="modal-box" style="border-top: 6px solid #FFD700; max-width: 320px;">
        <div class="modal-title">üß† Coach Pharmo</div>
        
        <div style="text-align:center; margin: 15px 0;">
            <div id="coachGrade" style="font-size: 5rem; font-weight: 800; line-height: 0.9;">A</div>
            <div id="coachSubtitle" style="font-size: 0.9rem; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Eccellente</div>
        </div>

        <div id="coachTipsBox" style="background: #f8f9fa; border-radius: 12px; padding: 18px; text-align: left; font-size: 0.9rem; line-height: 1.5; color: #333; border: 1px solid #eee; box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);">
            Analisi...
        </div>

        <button onclick="document.getElementById('coachModal').style.display='none'" style="margin-top:20px; width:100%; background:#007aff; color:white; border:none; padding:14px; border-radius:12px; font-weight:bold; cursor:pointer;">Ricevuto</button>
    </div>
</div>

<div id="cronoModal" class="modal-overlay" style="display:none; z-index:100000;">
    <div class="modal-box" style="background: #1c1c1e; color: white; border: 1px solid #333; max-width: 350px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
            <div class="modal-title" style="color:#00d4ff; margin:0; font-size: 1.2rem;">üß¨ Bio-Timing</div>
            <span style="background: linear-gradient(135deg, #00d4ff, #007aff); color:white; font-size:0.65rem; font-weight:800; padding:4px 8px; border-radius:4px;">VIP PLATINUM</span>
        </div>
        <p style="font-size:0.8rem; color:#888; margin-top:5px; margin-bottom:20px;">Ottimizzazione ormonale basata sul risveglio.</p>
        
        <div style="background:#2c2c2e; padding:15px; border-radius:14px; margin-bottom:25px; border: 1px solid #444;">
            <label style="color:#aaa; font-size:0.75rem; font-weight:700; text-transform:uppercase; display:block; margin-bottom:10px;">Configura Risveglio</label>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="time" id="wakeUpTime" value="07:00" onchange="renderCronoTimeline()" 
                       style="background:#000; color:#fff; border:1px solid #555; padding:10px; border-radius:10px; font-weight:bold; font-size:1.1rem; flex:1;">
                <button onclick="setWakeUpNow()" 
                        style="background:#00d4ff; color:black; border:none; padding:10px 15px; border-radius:10px; font-weight:800; font-size:0.7rem; cursor:pointer; line-height:1.2; flex:1;">
                    ‚òÄÔ∏è SVEGLIATO<br>ADESSO
                </button>
            </div>
        </div>

        <div id="cronoTimeline"></div>

        <button onclick="document.getElementById('cronoModal').style.display='none'" style="margin-top:20px; width:100%; background:transparent; border:1px solid #555; color:#aaa; padding:12px; border-radius:12px; cursor:pointer;">Chiudi Timeline</button>
    </div>
</div>

<script>
// AGGIUNGI QUESTO DATABASE ALL'INIZIO DEL TUO BLOCCO <script> SE NON C'√à GI√Ä
const cronoDB = {
    cortisolo: [
        "üî• <b>Fase Lipolitica:</b> Il corpo √® una fornace. ‚úÖ Carbo complessi (Avena/Integrali) OK. ‚õî NO ZUCCHERI semplici o aggiunti per non bloccare il dimagrimento.",
        "üî• <b>Stato di Allerta:</b> Ormoni al massimo. Usa proteine magre e <b>Pharmofit</b>. Evita zuccheri nel caff√® o succhi: causano crash insulinico.",
        "üî• <b>Focus Lipolisi:</b> In questa finestra il tuo corpo preferisce usare i grassi come carburante. Non spegnere la fornace con dolci o farine raffinate."
    ],
    insulina: [
        "üçö <b>Finestra di Carico:</b> Le tue cellule sono pronte. √à il momento ideale per i carboidrati principali (Pasta, Riso, Cereali). I nutrienti vanno ai muscoli.",
        "üçö <b>Picco Metabolico:</b> Massima sensibilit√† insulinica. Il cibo va nel muscolo, non nel grasso. Usa <b>Pharmolain</b> per ottimizzare l'assorbimento.",
        "üçö <b>Ricarica Glicogeno:</b> Ora i carboidrati servono a darti energia senza appesantirti. √à il momento del pasto pi√π abbondante della giornata."
    ],
    gh: [
        "üåô <b>Fase di Riparazione:</b> ‚õî STOP CARBOIDRATI TOTALI. Solo proteine e fibre per non bloccare il GH (Ormone del dimagrimento) notturno.",
        "üåô <b>Deep Sleep Prep:</b> Meno insulina circola stasera, pi√π grasso brucerai mentre dormi. <b>Pharmodren</b> consigliato per sgonfiare i tessuti.",
        "üåô <b>Reset Notturno:</b> Il corpo si ripara ora. Niente zuccheri o amidi stasera per permettere al fegato di disintossicarsi e attivare il GH."
    ]
};

function showDataLockPopup() {
    const isPremium = localStorage.getItem('app_premium_v1') === 'true';
    if (!isPremium) {
        alert("üîí DATA BLOCCATA\n\nFUNZIONE PRO \n\nLa gestione della Data Traguardo √® riservata ai membri PRO. Sbloccala con il tuo codice Pharmo che trovi dentro il pacco.");
    }
}

</script>
<!--  PANNELLO DI TEST -----------------‚≠ïÔ∏è‚≠ïÔ∏è‚≠ïÔ∏è‚≠ïÔ∏è‚≠ïÔ∏è‚≠ïÔ∏è      -->

<div style="position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.95); z-index: 9999999; padding: 10px 5px 30px 5px; display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; border-top: 3px solid #00d4ff; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); font-family: sans-serif;">
    
    <div style="width: 100%; text-align: center; color: #aaa; font-size: 9px; margin-bottom: 3px;">--- LIVELLO UTENTE ---</div>
    
    <button onclick="localStorage.clear(); location.reload();" 
            style="background: #ff3b30; color: white; border:none; border-radius:4px; padding: 6px 8px; font-weight:bold; font-size: 10px; flex: 1;">
            üóëÔ∏è FREE
    </button>
    
    <button onclick="localStorage.setItem('app_unlocked_v1','true'); localStorage.setItem('last_unlock_timestamp', Date.now()); localStorage.setItem('app_premium_v1','true'); localStorage.removeItem('app_vip_v1'); location.reload();" 
            style="background: #FFD700; color: black; border:none; border-radius:4px; padding: 6px 8px; font-weight:bold; font-size: 10px; flex: 1;">
            ‚≠ê GOLD
    </button>

    <button onclick="localStorage.setItem('app_unlocked_v1','true'); localStorage.setItem('last_unlock_timestamp', Date.now()); localStorage.setItem('app_premium_v1','true'); localStorage.setItem('app_vip_v1','true'); location.reload();" 
            style="background: #e0f7fa; color: #006064; border:1px solid #00bcd4; border-radius:4px; padding: 6px 8px; font-weight:bold; font-size: 10px; flex: 1;">
            üíé VIP
    </button>

    <div style="width: 100%; text-align: center; color: #aaa; font-size: 9px; margin: 3px 0;">--- FUNZIONI & REPORT ---</div>

        <button onclick="showWeeklyReport(3500);" 
            style="background: #28a745; color: white; border:none; border-radius:4px; padding: 6px 8px; font-size: 10px; flex: 1;">
            üìÖ REPORT GUI
    </button>


    <button onclick="localStorage.setItem('calorie_bank', 1000); location.reload();" 
            style="background: #ff9500; color: white; border:none; border-radius:4px; padding: 6px 8px; font-size: 10px; flex: 1;">
            üí∞ BANK
    </button>
<button onclick="localStorage.setItem('calorie_bank', 0); location.reload();" 
        style="background: #555; color: white; border:none; border-radius:4px; padding: 6px 8px; font-size: 10px; flex: 1;">
        üí∏ SVUOTA
</button>

    <button onclick="localStorage.removeItem('last_recovery_timestamp'); localStorage.removeItem('recovery_active_today'); alert('Timer Recovery azzerato!'); location.reload();" 
            style="background: #17a2b8; color: white; border:none; border-radius:4px; padding: 6px 8px; font-size: 10px; flex: 1;">
            ‚ö° NO TIMER
    </button>

    <div style="width: 100%; text-align: center; color: #aaa; font-size: 9px; margin: 3px 0;">--- PROGRESSI & SICUREZZA ---</div>

    <button onclick="localStorage.setItem('streak_days', parseInt(localStorage.getItem('streak_days')||0)+7); location.reload();" 
            style="background: #6f42c1; color: white; border:none; border-radius:4px; padding: 6px 8px; font-size: 10px; flex: 1;">
            üî• +7 GG
    </button>

    <button onclick="localStorage.setItem('water_count', 8); localStorage.setItem('water_streak_days', 2); location.reload();" 
            style="background: #007aff; color: white; border:none; border-radius:4px; padding: 6px 8px; font-size: 10px; flex: 1;">
            üíß ACQUA
    </button>

    <button onclick="document.querySelectorAll('.modal-overlay, #authGate').forEach(el => el.style.display='none');" 
            style="background: #333; color: white; border:1px solid white; border-radius:4px; padding: 6px 8px; font-size: 10px; flex: 2;">
            üîì SBLOCCA SCHERMO
    </button>
    
    <button onclick="this.parentElement.style.display='none'" 
            style="background: black; color: white; border:1px solid #555; border-radius:4px; padding: 6px 8px; font-size: 10px;">
            X
    </button>
</div>
</body>
</html>
