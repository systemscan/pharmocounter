<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pharmocounter</title>
    <style>
        :root {
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --text-main: #000000;
            --text-sec: #8e8e93;
            --accent: #007aff;
            --danger: #ff3b30;
            --warn: #ffcc00;     
            --orange: #ff9500;   
            --success: #34c759;  
            --carb-color: #5ac8fa;
            --prot-color: #ff2d55;
            --fat-color: #ffcc00;
            --shop-bg: #f4f9ff;
            --shop-border: #dbeafe;
            --shop-text: #003a80;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); display: flex; justify-content: center; min-height: 100vh; margin: 0; padding: 20px 15px; box-sizing: border-box; color: var(--text-main); -webkit-font-smoothing: antialiased; }
        
        .app-container { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 28px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.06); display: flex; flex-direction: column; gap: 24px; position: relative; }

        /* HEADER STYLE */
        .header-area { text-align: center; margin-bottom: 10px; padding-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); position: relative; }
        .date-badge { font-size: 0.8rem; color: var(--text-sec); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: block; }
        h1 { margin: 0; font-size: 2rem; font-weight: 800; letter-spacing: -0.5px; line-height: 1; background: linear-gradient(135deg, #007aff 0%, #004494 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block; }
        .subtitle-brand { display: block; font-size: 0.95rem; color: var(--text-sec); font-weight: 500; margin-top: 5px; }
        
        /* STREAK BADGE */
        .streak-badge {
            position: absolute; top: 0; right: 0;
            background: #fff5e6; color: #ff9500;
            font-size: 0.75rem; font-weight: 700;
            padding: 6px 12px; border-radius: 20px;
            border: 1px solid #ffeebb; cursor: pointer;
            transition: transform 0.1s;
        }
        .streak-badge:active { transform: scale(0.95); background: #ffeebb; }

        /* INPUT CARD */
        .card { background: #f9f9fb; border-radius: 18px; padding: 18px; border: 1px solid rgba(0,0,0,0.03); }
        summary { cursor: pointer; font-weight: 600; font-size: 0.95rem; outline: none; display: flex; justify-content: space-between; align-items: center; color: var(--accent); }
        summary::after { content: '‚öôÔ∏è'; font-size: 1rem; opacity: 0.7; }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        label { font-size: 0.75rem; font-weight: 600; color: var(--text-sec); display: block; margin-bottom: 6px; }
        select, input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e5e5ea; background: #fff; font-size: 0.95rem; -webkit-appearance: none; box-sizing: border-box; color: var(--text-main); transition: border-color 0.2s; }
        select:focus, input:focus { border-color: var(--accent); outline: none; }
        
        .info-box { grid-column: 1 / -1; font-size: 0.75rem; color: #666; background: #fff; padding: 12px; border-radius: 10px; border: 1px solid #eee; line-height: 1.5; margin-top: 5px; }

        /* DASHBOARD */
        .dash-header { text-align: center; margin: 10px 0; }
        .big-val { font-size: 3.2rem; font-weight: 800; line-height: 1; letter-spacing: -2px; color: var(--text-main); }
        .sub-val { font-size: 0.9rem; color: var(--text-sec); margin-top: 6px; font-weight: 500; }

        /* PROGRESS BARS */
        .bar-label { display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; color: #555; }
        .track { background: #eef0f2; height: 14px; width: 100%; border-radius: 7px; overflow: hidden; position: relative; }
        .fill { height: 100%; width: 0%; border-radius: 7px; transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.4s; }
        .bmr-line { position: absolute; top: 0; bottom: 0; width: 2px; background: rgba(0,0,0,0.3); z-index: 5; border-right: 1px dashed rgba(255,255,255,0.7); }
        .bmr-tag { position: absolute; top: -16px; font-size: 0.65rem; color: var(--text-sec); transform: translateX(-50%); font-weight: 700; text-transform: uppercase; }
        .status-text { text-align: center; font-size: 0.85rem; font-weight: 600; margin-top: 10px; min-height: 1.2em; }

        /* WATER TRACKER */
        .water-box { margin-top: 20px; padding: 15px; background: #eef7ff; border-radius: 16px; border: 1px solid #dbeafe; }
        .water-title { font-size: 0.85rem; font-weight: 700; color: #004494; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .water-grid { display: flex; justify-content: space-between; gap: 5px; }
        .water-glass {
            height: 35px; width: 25px; 
            background: #d1e3fa; border-radius: 4px 4px 8px 8px;
            cursor: pointer; transition: all 0.2s; position: relative;
            border: 2px solid #a6c8ff; border-top: none;
            opacity: 0.5; /* Dimmed */
        }
        .water-glass::before { content:''; position:absolute; top:0; left:0; width:100%; height:3px; background:rgba(0,0,0,0.1); }
        .water-glass.filled { background: #007aff; border-color: #005bb5; opacity: 1; }
        .water-glass.next-up { opacity: 1; border-color: #007aff; box-shadow: 0 0 0 2px rgba(0,122,255,0.2); }

        /* MACROS HIDDEN */
        details.macros-box summary::after { content: 'üìä'; }
        .macro-grid { display: grid; gap: 14px; margin-top: 15px; }
        .macro-item { display: flex; flex-direction: column; }
        
        /* SHOP / PROMO CARD */
        .shop-card { background-color: var(--shop-bg); border: 1px solid var(--shop-border); border-radius: 18px; padding: 20px; text-align: left; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 122, 255, 0.06); }
        .shop-tag { background: #007aff; color: white; font-size: 0.65rem; font-weight: 700; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; display: inline-block; margin-bottom: 10px; }
        .shop-title { font-size: 1.15rem; font-weight: 800; color: var(--shop-text); margin: 0 0 10px 0; line-height: 1.3; }
        .shop-content { font-size: 0.85rem; color: #335d88; margin-bottom: 15px; line-height: 1.5; }
        
        /* DETAILS ACCORDION */
        details.shop-details summary { color: #007aff; font-size: 0.85rem; font-weight: 600; padding: 8px 0; cursor: pointer; list-style: none; text-align: left; margin-top: 5px; display: flex; align-items: center; }
        details.shop-details summary::-webkit-details-marker { display: none; }
        details.shop-details summary::after { content: ' ‚ñæ'; font-size: 1rem; margin-left: 5px; }
        details.shop-details[open] summary::after { content: ' ‚ñ¥'; }

        .shop-highlight { background: rgba(255,255,255,0.7); padding: 10px; border-radius: 10px; margin-top: 8px; display: block; border-left: 3px solid #007aff; box-shadow: 0 2px 5px rgba(0,0,0,0.03); font-size: 0.85rem; line-height: 1.4; }
        
        .btn-shop { background: linear-gradient(135deg, #007aff 0%, #0056b3 100%); color: white; text-decoration: none; display: block; text-align: center; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 0.95rem; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2); margin-top: 15px; }
        .btn-shop:active { transform: scale(0.98); opacity: 0.9; }

        /* FOOD LIST & EMPTY STATE */
        .food-list { list-style: none; padding: 0; margin: 0; min-height: 20px; }
        .food-item { display: grid; grid-template-columns: 1fr auto; gap: 10px; padding: 14px 0; border-bottom: 1px solid #f0f0f5; align-items: center; }
        .food-info { min-width: 0; }
        .food-name { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #333; }
        .food-details { font-size: 0.75rem; color: var(--text-sec); margin-top: 3px; }
        .food-actions { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .food-cal { font-weight: 700; font-size: 0.95rem; }
        .btn-del { color: #ff3b30; font-size: 0.75rem; margin-top: 4px; cursor: pointer; background: none; border: none; padding: 0; font-weight: 500; }

        .did-you-know {
            background: #fff; padding: 20px; border-radius: 16px; border: 1px solid #eee;
            text-align: center; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        .dyk-icon { font-size: 1.5rem; display: block; margin-bottom: 10px; }
        .dyk-title { font-weight: 800; color: #007aff; font-size: 0.9rem; margin-bottom: 5px; text-transform: uppercase; }
        .dyk-text { font-size: 0.85rem; color: #555; line-height: 1.5; }

        /* ADD SECTION */
        .add-box { border-top: 1px solid #eee; padding-top: 24px; display: flex; flex-direction: column; gap: 10px; }
        .row { display: flex; gap: 8px; }
        .btn-main { background: #1c1c1e; color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 600; font-size: 1rem; cursor: pointer; margin-top: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-main:active { transform: scale(0.98); }
        .small-inputs input { font-size: 0.85rem; text-align: center; padding: 10px 4px; }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: none; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white; width: 100%; max-width: 350px;
            border-radius: 20px; padding: 25px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 15px; color: #1c1c1e; }
        .modal-text { font-size: 0.85rem; color: #444; line-height: 1.5; text-align: left; margin-bottom: 20px; }
        .modal-btn {
            background: #007aff; color: white; border: none; width: 100%;
            padding: 14px; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer;
        }
        .reward-code {
            background: #f0f0f5; border: 2px dashed #007aff; color: #007aff;
            font-size: 1.4rem; font-weight: 800; padding: 15px;
            border-radius: 10px; margin: 15px 0; display: block; text-align: center;
        }

        /* SMART TOAST */
        .smart-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #1c1c1e; color: white; padding: 12px 20px; border-radius: 50px;
            font-size: 0.85rem; box-shadow: 0 10px 20px rgba(0,0,0,0.25);
            z-index: 10000; display: flex; align-items: center; gap: 10px;
            opacity: 0; transition: opacity 0.5s; pointer-events: none; width: 90%; max-width: 350px;
        }
        .toast-visible { opacity: 1; pointer-events: auto; }
        .toast-icon { font-size: 1.2rem; }
        .toast-btn { background: white; color: #1c1c1e; border:none; padding: 6px 12px; border-radius: 20px; font-weight: 700; font-size: 0.75rem; margin-left: auto; text-decoration: none; }
    </style>
</head>
<body>

<div id="smartToast" class="smart-toast">
    <span class="toast-icon">üí°</span>
    <span id="toastMsg">...</span>
    <a href="https://www.pharmo.it" target="_blank" class="toast-btn">Vedi</a>
</div>

<div id="disclaimerModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title">‚ö†Ô∏è Disclaimer Importante</div>
        <div class="modal-text">
            Benvenuto su <b>Pharmocounter</b>.<br><br>
            Questa applicazione utilizza formule scientifiche standardizzate per la stima del fabbisogno calorico. I dati forniti sono <b>esclusivamente a scopo informativo</b>.<br><br>
            <b>Non siamo medici.</b> L'utilizzo di questa app non sostituisce il parere di un medico o nutrizionista.<br><br>
            <b>Pharmo.it</b> e l'azienda gestore declinano ogni responsabilit√† per l'uso improprio delle informazioni. Inoltre, l'azienda non si assume responsabilit√† per eventuali perdite di dati, errori di calcolo, bug del sistema o malfunzionamenti dovuti ad aggiornamenti software.
        </div>
        <button class="modal-btn" onclick="acceptTerms()">Ho capito e Accetto</button>
    </div>
</div>

<div id="rewardModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title">üéâ Complimenti!</div>
        <div class="modal-text" style="text-align:center;">
            Hai completato la tua <b>Sfida 7 Giorni</b>!<br><br>
            La costanza ti ha premiato.<br>Ecco un regalo per te da usare su <b>Pharmo.it</b>:
            <span class="reward-code" onclick="copyCode()">PHARMOAPP</span>
            <small style="color:#888;">Clicca il codice per copiarlo</small>
        </div>
        <button class="modal-btn" onclick="closeReward()">Riscatta Ora</button>
    </div>
</div>

<div class="app-container">
    <div class="header-area">
        <span class="date-badge" id="dateText">...</span>
        <h1>Pharmocounter</h1>
        <span class="subtitle-brand">by pharmo.it</span>
        <div class="streak-badge" id="streakDisplay" onclick="showStreakInfo()">üî• 1/7</div>
    </div>

    <details class="card" id="profileDetails">
        <summary>Il tuo Profilo</summary>
        <div class="settings-grid">
            <div>
                <label>Sesso</label>
                <select id="gender" onchange="calc()">
                    <option value="m">Uomo</option>
                    <option value="f">Donna</option>
                </select>
            </div>
            <div>
                <label>Et√†</label>
                <input type="number" id="age" value="30" onchange="calc()">
            </div>
            <div>
                <label>Peso (kg)</label>
                <input type="number" id="weight" value="75" onchange="calc()">
            </div>
            <div>
                <label>Altezza (cm)</label>
                <input type="number" id="height" value="175" onchange="calc()">
            </div>
            <div style="grid-column: 1 / -1;">
                <label>Livello Attivit√† Fisica</label>
                <select id="act" onchange="calc()">
                    <option value="1.2">Sedentario (Ufficio, no sport)</option>
                    <option value="1.375">Leggero (Sport 1-3 gg/sett)</option>
                    <option value="1.55">Moderato (Sport 3-5 gg/sett)</option>
                    <option value="1.725">Attivo (Sport 6-7 gg/sett)</option>
                </select>
            </div>
            <div style="grid-column: 1 / -1;">
                <label>Obiettivo</label>
                <select id="goal" onchange="calc()">
                    <option value="lose_aggr">üìâ Perdita Peso Standard (-20%)</option>
                    <option value="lose_athlete_15">‚úÇÔ∏è Atleta / Cut Aggressivo (-15%)</option>
                    <option value="lose_cons">üõ°Ô∏è Atleta / Cut Conservativo (-10%)</option>
                    <option value="maintain" selected>‚öñÔ∏è Mantenimento</option>
                    <option value="gain">üìà Aumento Muscolare (+10%)</option>
                </select>
            </div>
            <div class="info-box" id="scientificData">
                Calcolo in corso...
            </div>
        </div>
    </details>

    <div>
        <div class="dash-header">
            <div class="big-val" id="remCal">0</div>
            <div class="sub-val">Kcal Rimanenti (Target: <span id="targetDisplay">0</span>)</div>
        </div>

        <div style="position: relative; margin-top: 30px;">
            <div id="bmrMarker" class="bmr-line"></div>
            <div id="bmrTag" class="bmr-tag">Basale</div>
            
            <div class="track" style="height: 26px; border-radius: 13px;">
                <div class="fill" id="calBar" style="border-radius: 13px;"></div>
            </div>
        </div>
        <div class="status-text" id="statusText">...</div>
    </div>

    <div class="shop-card" id="shopCard">
        <span class="shop-tag">Protocollo Consigliato</span>
        <h3 class="shop-title" id="shopTitle">...</h3>
        <div class="shop-content" id="shopDesc">...</div>
        <a href="https://www.pharmo.it" target="_blank" class="btn-shop">Acquista il Protocollo su Pharmo.it ‚Üí</a>
    </div>

    <div class="water-box">
        <div class="water-title">
            <span>Idratazione & Detox</span>
            <span id="waterCountDisplay">0/8</span>
        </div>
        <div class="water-grid" id="waterGrid">
            </div>
        <div style="font-size:0.7rem; color:#666; margin-top:8px; text-align:center;">
            Segui l'ordine: 1 bicchiere ogni ora (8 al giorno)
        </div>
    </div>

    <details class="card macros-box">
        <summary>Dettaglio Nutrienti (Macro)</summary>
        <div class="macro-grid">
            <div class="macro-item">
                <div class="bar-label">
                    <span>Carboidrati</span>
                    <span id="carbTxt" style="color:var(--carb-color)">0 / 0g</span>
                </div>
                <div class="track"><div class="fill" id="carbBar" style="background:var(--carb-color)"></div></div>
            </div>
            <div class="macro-item">
                <div class="bar-label">
                    <span>Proteine (Muscoli)</span>
                    <span id="protTxt" style="color:var(--prot-color)">0 / 0g</span>
                </div>
                <div class="track"><div class="fill" id="protBar" style="background:var(--prot-color)"></div></div>
            </div>
            <div class="macro-item">
                <div class="bar-label">
                    <span>Grassi (Salute)</span>
                    <span id="fatTxt" style="color:var(--fat-color)">0 / 0g</span>
                </div>
                <div class="track"><div class="fill" id="fatBar" style="background:var(--fat-color)"></div></div>
            </div>
        </div>
    </details>

    <div class="add-box">
        <div class="row">
            <input type="text" id="inName" placeholder="Nome Cibo (es. Pasta, Pollo...)" style="flex:2">
            <input type="number" id="inCal" placeholder="Kcal" style="flex:1">
        </div>
        <div class="row small-inputs">
            <input type="number" id="inCarb" placeholder="Carb">
            <input type="number" id="inProt" placeholder="Prot">
            <input type="number" id="inFat" placeholder="Grass">
        </div>
        <button class="btn-main" onclick="add()">Aggiungi al Diario</button>
    </div>

    <ul class="food-list" id="list"></ul>
    
    <button onclick="resetAll()" style="background:none; border:1px solid #eee; padding:12px; border-radius:10px; color:#999; font-size:0.8rem; margin-top:20px; width:100%;">üóëÔ∏è Inizia nuova giornata</button>
</div>

<script>
    const d = new Date();
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    document.getElementById('dateText').innerText = d.toLocaleDateString('it-IT', options);

    // --- DATE LOGIC (SHIFT 04:00 AM) ---
    const now = new Date();
    now.setHours(now.getHours() - 4);
    const todayStr = now.toDateString(); 

    // --- AUTOMATIC DAILY RESET (MASTER CHECK) ---
    if (localStorage.getItem('app_date') !== todayStr) {
        localStorage.setItem('foods_v3', JSON.stringify([])); 
        localStorage.setItem('water_count', 0); 
        localStorage.setItem('water_last_time', 0); 
        localStorage.setItem('app_date', todayStr); 
    }

    // --- DISCLAIMER LOGIC ---
    if (!localStorage.getItem('terms_accepted_v1')) {
        document.getElementById('disclaimerModal').style.display = 'flex';
    }

    function acceptTerms() {
        localStorage.setItem('terms_accepted_v1', 'true');
        document.getElementById('disclaimerModal').style.display = 'none';
        if (!localStorage.getItem('profile_v3')) {
            document.getElementById('profileDetails').setAttribute('open', 'true');
        }
    }

    // --- STREAK & REWARD LOGIC (7 DAYS) ---
    let streakCount = parseInt(localStorage.getItem('streak_days')) || 1;
    let lastVisitDate = localStorage.getItem('last_visit_date');

    if (lastVisitDate !== todayStr) {
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        
        if (lastVisitDate === yesterday.toDateString()) {
            streakCount++;
        } else if (lastVisitDate) {
            streakCount = 1;
        }
        localStorage.setItem('streak_days', streakCount);
        localStorage.setItem('last_visit_date', todayStr);
    }

    document.getElementById('streakDisplay').innerText = `üî• ${streakCount}/7`;

    function showStreakInfo() {
        alert("LA SFIDA DI PHARMO.IT\n\nUsa l'applicazione per 7 giorni consecutivi per sbloccare un Codice Sconto Esclusivo! üî•\n\nAttuale: " + streakCount + " di 7 giorni.\n\nüí° IMPORTANTE: Alla fine della sfida, ricordati di aggiornare il tuo peso nel profilo!");
    }

    if (streakCount >= 7 && !localStorage.getItem('reward_claimed')) {
        document.getElementById('rewardModal').style.display = 'flex';
    }

    function closeReward() {
        localStorage.setItem('reward_claimed', 'true');
        document.getElementById('rewardModal').style.display = 'none';
        window.open('https://www.pharmo.it', '_blank');
    }

    function copyCode() {
        const code = document.querySelector('.reward-code').innerText;
        navigator.clipboard.writeText(code);
        alert("Codice copiato!");
    }

    // --- WATER TRACKER LOGIC (SEQUENTIAL + TIMER) ---
    let waterCount = parseInt(localStorage.getItem('water_count')) || 0;

    function renderWater() {
        const grid = document.getElementById('waterGrid');
        grid.innerHTML = '';
        for(let i=0; i<8; i++) {
            const glass = document.createElement('div');
            let className = 'water-glass';
            if (i < waterCount) className += ' filled';
            if (i === waterCount) className += ' next-up'; 
            
            glass.className = className;
            glass.onclick = () => toggleWater(i);
            grid.appendChild(glass);
        }
        document.getElementById('waterCountDisplay').innerText = `${waterCount}/8`;
        localStorage.setItem('water_count', waterCount);
    }

    function toggleWater(idx) {
        const currentTime = Date.now();
        const lastDrink = parseInt(localStorage.getItem('water_last_time')) || 0;
        const oneHour = 60 * 60 * 1000;

        // AGGIUNTA
        if (idx === waterCount) {
            if (waterCount > 0 && (currentTime - lastDrink < oneHour)) {
                let minutesLeft = Math.ceil((oneHour - (currentTime - lastDrink)) / 60000);
                showToast(`‚è≥ Aspetta ancora ${minutesLeft} min per la corretta idratazione.`);
                return;
            }
            waterCount++;
            localStorage.setItem('water_last_time', currentTime);
            renderWater();
            showToast("Idratazione registrata! üíß Un passo in pi√π verso la Sfida 3 Giorni Acqua üî•");
        } 
        // RIMOZIONE
        else if (idx === waterCount - 1) {
            waterCount--;
            renderWater();
        }
    }

    // --- SMART ALERTS LOGIC (SERVERLESS) ---
    function showToast(msg) {
        const t = document.getElementById('smartToast');
        document.getElementById('toastMsg').innerText = msg;
        t.classList.add('toast-visible');
        setTimeout(() => t.classList.remove('toast-visible'), 6000);
    }

    function checkSmartAdvice(name, cal, curCarb, maxCarb) {
        if (curCarb > maxCarb) {
            showToast("Troppi Carboidrati? Gestiscili con Pharmofit.");
            return;
        }
        const lowerName = name.toLowerCase();
        const dirtyKeywords = ['pizza', 'sushi', 'fritto', 'burger', 'mc', 'kebab', 'sale', 'salame', 'insaccati', 'patatine'];
        if (dirtyKeywords.some(k => lowerName.includes(k))) {
            showToast("Pasto salato? Pharmodren riduce la ritenzione.");
            return;
        }
    }

    function checkTimeAdvice() {
        const hour = new Date().getHours();
        if (hour >= 6 && hour < 11) {
            showToast("Buongiorno! Attiva il metabolismo con Pharmofit.");
        } else if (hour >= 12 && hour < 15) {
            showToast("Pranzo proteico? Pharmolain aiuta la digestione.");
        } else if (hour >= 20 && hour <= 23) {
            showToast("La pelle si rigenera di notte. Usa Pharmofiller.");
        }
    }

    // --- APP CORE ---
    let savedProfile = localStorage.getItem('profile_v3');
    if (!savedProfile && localStorage.getItem('terms_accepted_v1')) {
        document.getElementById('profileDetails').setAttribute('open', 'true');
    }

    let foods = JSON.parse(localStorage.getItem('foods_v3')) || [];
    let state = JSON.parse(savedProfile) || {
        g: 'm', age: 30, w: 75, h: 175, act: 1.375, goal: 'maintain'
    };

    document.getElementById('gender').value = state.g;
    document.getElementById('age').value = state.age;
    document.getElementById('weight').value = state.w;
    document.getElementById('height').value = state.h;
    document.getElementById('act').value = state.act;
    if(state.goal === 'lose') state.goal = 'lose_aggr'; 
    document.getElementById('goal').value = state.goal;

    let TGT_CAL = 0, TGT_C = 0, TGT_P = 0, TGT_F = 0, BMR = 0, TDEE = 0;

    function calc() {
        let oldWeight = state.w;
        let newWeight = parseFloat(document.getElementById('weight').value);
        
        if (oldWeight && newWeight && oldWeight !== newWeight) {
            if (newWeight < oldWeight) {
                showToast("Peso in calo! Mantieni la pelle tonica con Pharmofiller.");
            } else {
                showToast("Peso stabile? Sbloccalo con Pharmofit.");
            }
        }

        state = {
            g: document.getElementById('gender').value,
            age: parseFloat(document.getElementById('age').value),
            w: newWeight,
            h: parseFloat(document.getElementById('height').value),
            act: parseFloat(document.getElementById('act').value),
            goal: document.getElementById('goal').value
        };
        localStorage.setItem('profile_v3', JSON.stringify(state));

        let s = (10 * state.w) + (6.25 * state.h) - (5 * state.age);
        BMR = (state.g === 'm') ? s + 5 : s - 161;
        TDEE = Math.round(BMR * state.act);

        let adjustments = {
            'lose_aggr': 0.80, 'lose_athlete_15': 0.85, 'lose_cons': 0.90, 'maintain': 1.0, 'gain': 1.10
        };
        TGT_CAL = Math.round(TDEE * adjustments[state.goal]);

        let safetyText = "";
        if (TGT_CAL < BMR) {
            TGT_CAL = Math.round(BMR);
            safetyText = "<br><span style='color:var(--orange); font-weight:600;'>‚ö†Ô∏è Target limitato al BMR per sicurezza.</span>";
        }

        // --- SHOP 3-FASI LOGIC ---
        let p_ratio, c_ratio, f_ratio, goalText;
        let sTitle, sDesc;
        const fillerBenefits = "Collagene Marino, Acido Ialuronico e Vit. C.";

        const stackLoss = `
            Consiglio: <b>Pharmofit</b> (Metabolismo), <b>Pharmodren</b> (Drenante) e <b>Pharmofiller</b> (Elasticit√†).
            <details class="shop-details">
                <summary>Svela i dettagli del trattamento</summary>
                <div class="shop-highlight" style="border-left-color:#ff3b30;">
                    <b>1. PHARMOFIT:</b> Sblocca il metabolismo stagnante. Caff√® Verde e Arancio Amaro innescano la termogenesi (bruci grassi a riposo), mentre il Cromo spegne la fame nervosa.<br>
                    <i>Ottieni:</i> Dimagrimento costante senza abbuffate.<br>
                    <i>Eviti:</i> Lo stallo del peso e la fame incontrollabile.
                </div>
                <div class="shop-highlight" style="margin-top:5px; border-left-color:#34c759;">
                    <b>2. PHARMODREN:</b> Azione d'urto sui liquidi. Betulla e Ananas prosciugano la ritenzione che maschera i progressi.<br>
                    <i>Ottieni:</i> Addome sgonfio e gambe leggere.<br>
                    <i>Eviti:</i> L'aspetto gonfio/appannato e la cellulite.
                </div>
                <div class="shop-highlight" style="margin-top:5px; border-left-color:#007aff; background: #eef7ff;">
                    <b>3. PHARMOFILLER:</b> L'architetto della pelle (Collagene + Ialuronico). Ricostruisce l'impalcatura cutanea mentre ti svuoti.<br>
                    <i>Ottieni:</i> Una pelle che si "ritira" rimanendo soda.<br>
                    <i>Eviti:</i> L'effetto <b>pelle flaccida</b> o "svuotata" post-dieta.
                </div>
            </details>`;

        const stackGain = `
             Consiglio: <b>Pharmofit</b> (Controllo), <b>Pharmodren</b> (Definizione) e <b>Pharmofiller</b> (Struttura).
            <details class="shop-details">
                <summary>Svela i dettagli del trattamento</summary>
                <div class="shop-highlight" style="border-left-color:#ff3b30;">
                    <b>1. PHARMOFIT:</b> Gestione insulinica. Il Cromo dirige i carboidrati nei muscoli (glicogeno) invece che nel tessuto adiposo.<br>
                    <i>Ottieni:</i> Crescita muscolare pulita (Clean Bulk).<br>
                    <i>Eviti:</i> Accumulo eccessivo di grasso in surplus.
                </div>
                <div class="shop-highlight" style="margin-top:5px; border-left-color:#34c759;">
                    <b>2. PHARMODREN:</b> Definizione HD. Espelle l'acqua extracellulare mantenendo visibili i dettagli muscolari.<br>
                    <i>Ottieni:</i> Muscoli duri, separati e vascolarizzati.<br>
                    <i>Eviti:</i> Il "faccione gonfio" tipico della massa.
                </div>
                <div class="shop-highlight" style="margin-top:5px; border-left-color:#007aff; background: #eef7ff;">
                    <b>3. PHARMOFILLER:</b> Scudo anti-smagliature. Nutre la matrice dermica sottoposta a forte tensione per la crescita muscolare.<br>
                    <i>Ottieni:</i> Pelle elastica e resistente.<br>
                    <i>Eviti:</i> Le <b>smagliature</b> da crescita rapida.
                </div>
            </details>`;

        if(state.goal === 'lose_aggr' || state.goal === 'lose_athlete_15' || state.goal === 'lose_cons') {
            sTitle = "Protocollo Total Body 3-Fasi";
            sDesc = stackLoss;
            
            if(state.goal === 'lose_aggr') {
                c_ratio = 0.40; p_ratio = 0.30; f_ratio = 0.30; goalText = "Perdita Peso Standard (-20%)";
            } else if (state.goal === 'lose_athlete_15') {
                c_ratio = 0.35; p_ratio = 0.35; f_ratio = 0.30; goalText = "Atleta / Cut Aggressivo (-15%)";
            } else {
                c_ratio = 0.40; p_ratio = 0.30; f_ratio = 0.30; goalText = "Atleta / Cut Conservativo (-10%)";
            }

        } else {
            sTitle = "Protocollo Definizione & Struttura";
            sDesc = stackGain;

            if(state.goal === 'gain') {
                c_ratio = 0.50; p_ratio = 0.20; f_ratio = 0.30; goalText = "Surplus Muscolare (+10%)";
            } else {
                c_ratio = 0.50; p_ratio = 0.20; f_ratio = 0.30; goalText = "Mantenimento Peso";
            }
        }

        document.getElementById('shopTitle').innerText = sTitle;
        document.getElementById('shopDesc').innerHTML = sDesc;

        TGT_C = Math.round((TGT_CAL * c_ratio) / 4);
        TGT_P = Math.round((TGT_CAL * p_ratio) / 4);
        TGT_F = Math.round((TGT_CAL * f_ratio) / 9);

        document.getElementById('scientificData').innerHTML = 
            `<b>Analisi Scientifica:</b><br>
            Metabolismo Basale (BMR): <b>${Math.round(BMR)}</b> kcal<br>
            Fabbisogno Totale (TDEE): <b>${TDEE}</b> kcal<br>
            Piano: <b>${goalText}</b>${safetyText}`;
        
        document.getElementById('targetDisplay').innerText = TGT_CAL;

        let bmrPct = Math.min((BMR / TGT_CAL) * 100, 95);
        document.getElementById('bmrMarker').style.left = bmrPct + "%";
        document.getElementById('bmrTag').style.left = bmrPct + "%";

        render();
    }

    function render() {
        const list = document.getElementById('list');
        list.innerHTML = '';
        let curCal=0, curC=0, curP=0, curF=0;

        foods.slice().reverse().forEach((f, idx) => {
            curCal += f.k; curC += f.c; curP += f.p; curF += f.f;
            const li = document.createElement('li');
            li.className = 'food-item';
            li.innerHTML = `
                <div class="food-info">
                    <div class="food-name">${f.n}</div>
                    <div class="food-details">C:${f.c} P:${f.p} G:${f.f}</div>
                </div>
                <div class="food-actions">
                    <span class="food-cal">${f.k}</span>
                    <button class="btn-del" onclick="rem(${foods.length - 1 - idx})">elimina</button>
                </div>`;
            list.appendChild(li);
        });

        if (foods.length === 0) {
            const tips = [
                {t: "Bromelina (Pharmolain)", d: "Lo sapevi? 500mg di Bromelina 2500 GDU equivalgono all'attivit√† enzimatica di 2 ananas interi. Potente contro la cellulite."},
                {t: "Caff√® Verde (Pharmofit)", d: "Scienza: L'Acido Clorogenico riduce l'assorbimento degli zuccheri nell'intestino, abbassando il carico glicemico del pasto."},
                {t: "Collagene (Pharmofiller)", d: "Dopo i 25 anni, la produzione di collagene cala dell'1.5% l'anno. Integrarlo √® l'unico modo per mantenere la pelle soda."},
                {t: "Betulla (Pharmodren)", d: "La Betulla non elimina solo liquidi, ma aiuta a smaltire le tossine accumulate nei tessuti (Detox)."},
                {t: "Cromo Picolinato (Pharmofit)", d: "Voglia di dolce dopo i pasti? Spesso √® dovuta a sbalzi glicemici. Il Cromo Picolinato aiuta a stabilizzarli."},
                {t: "Acido Ialuronico (Pharmofiller)", d: "L'Acido Ialuronico trattiene fino a 1000 volte il suo peso in acqua, mantenendo la pelle idratata e 'piena'."},
                {t: "Arancio Amaro (Pharmofit)", d: "La Sinefrina (Arancio Amaro) stimola la termogenesi selettiva, aiutando a utilizzare i grassi a scopo energetico."},
                {t: "Sonno e Peso", d: "Dormire meno di 7 ore aumenta il cortisolo, l'ormone che ti fa accumulare grasso sulla pancia. Il riposo √® parte della dieta."},
                {t: "Termogenesi Digestiva", d: "Digerire le proteine costa al corpo il 30% delle calorie ingerite. Ecco perch√© una dieta proteica accelera il metabolismo."},
                {t: "Vite Rossa (Pharmodren)", d: "Gambe pesanti a fine giornata? La Vite Rossa migliora il microcircolo e riduce il gonfiore alle caviglie."},
                {t: "Acqua e Ritenzione", d: "Paradosso: se bevi poco, il corpo trattiene l'acqua per 'sopravvivenza'. Bevi almeno 2L per sbloccare la ritenzione."},
                {t: "Fibre e Saziet√†", d: "Le fibre solubili creano un gel nello stomaco che ti fa sentire sazio pi√π a lungo. Abbonda con le verdure!"}
            ];
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            
            list.innerHTML = `
                <div class="did-you-know">
                    <span class="dyk-icon">üí°</span>
                    <div class="dyk-title">${randomTip.t}</div>
                    <div class="dyk-text">${randomTip.d}</div>
                </div>`;
        }

        let diff = TGT_CAL - curCal;
        document.getElementById('remCal').innerText = diff;
        document.getElementById('remCal').style.color = diff < 0 ? 'var(--danger)' : 'var(--text-main)';

        let pct = (curCal / TGT_CAL) * 100;
        let bar = document.getElementById('calBar');
        let msg = document.getElementById('statusText');
        bar.style.width = Math.min(pct, 100) + "%";
        
        let barColor = "var(--danger)";
        let msgText = "‚õî Limite superato";
        let msgColor = "var(--danger)";

        if (state.goal === 'lose_athlete_15' || state.goal === 'lose_cons') {
            let safeFloor = Math.round(TDEE * 0.80);
            if (curCal < BMR) {
                barColor = "var(--warn)"; msgText = "‚ö†Ô∏è Energia insufficiente (Sotto Basale)"; msgColor = "#d4a017";
            } else if (curCal >= BMR && curCal < safeFloor) {
                barColor = "var(--orange)"; msgText = "üü† Deficit ancora eccessivo (>20%)"; msgColor = "var(--orange)";
            } else if (curCal >= safeFloor && curCal <= TGT_CAL) {
                barColor = "var(--success)"; msgText = "‚úÖ Zona Target Ottimale (Atleta)"; msgColor = "var(--success)";
            }
        } else {
            if (curCal < BMR) {
                barColor = "var(--warn)"; msgText = "‚ö†Ô∏è Energia insufficiente (Sotto Basale)"; msgColor = "#d4a017";
            } else if (curCal >= BMR && curCal <= TGT_CAL) {
                barColor = "var(--success)"; msgText = "‚úÖ Ottimo lavoro! Sei nel range ideale."; msgColor = "var(--success)";
            }
        }
        bar.style.background = barColor;
        msg.innerText = msgText;
        msg.style.color = msgColor;

        setBar('carb', curC, TGT_C, 'g');
        setBar('prot', curP, TGT_P, 'g');
        setBar('fat', curF, TGT_F, 'g');

        localStorage.setItem('foods_v3', JSON.stringify(foods));
        
        return { curCal, curC };
    }

    function setBar(type, cur, max, unit) {
        let p = (cur / max) * 100;
        document.getElementById(type+'Bar').style.width = Math.min(p, 100) + "%";
        document.getElementById(type+'Txt').innerText = `${cur} / ${max}${unit}`;
    }

    function add() {
        let n = document.getElementById('inName').value;
        let k = parseInt(document.getElementById('inCal').value);
        let c = parseInt(document.getElementById('inCarb').value)||0;
        
        if(n && k) {
            foods.push({
                n, k,
                c: c,
                p: parseInt(document.getElementById('inProt').value)||0,
                f: parseInt(document.getElementById('inFat').value)||0
            });
            document.querySelectorAll('.add-box input').forEach(i => i.value = '');
            
            const totals = render();
            
            checkSmartAdvice(n, k, totals.curC, TGT_C);
        }
    }

    function rem(i) {
        foods.splice(i, 1);
        render();
    }

    function resetAll() {
        if(confirm("Cancellare tutto?")) {
            foods = []; render();
        }
    }

    // Init Calls
    renderWater();
    calc();
    checkTimeAdvice(); 
</script>
</body>
</html>
